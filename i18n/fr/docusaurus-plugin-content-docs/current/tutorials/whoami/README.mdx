---
sidebar_position: 1
sidebar_label: 'Tutoriel : Qui suis-je ?'
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import SetupOauth from './_setup-oauth.mdx';
import SetupOidc from './_setup-oidc.mdx';

# Tutoriel : Qui suis-je ? (Tutorial: Who am I?)

Ce tutoriel vous guidera √† travers le processus de configuration de MCP Auth pour authentifier les utilisateurs et r√©cup√©rer leurs informations d'identit√© depuis le serveur d‚Äôautorisation (Authorization Server).

Apr√®s avoir termin√© ce tutoriel, vous aurez :

- ‚úÖ Une compr√©hension de base de l‚Äôutilisation de MCP Auth pour authentifier les utilisateurs.
- ‚úÖ Un serveur MCP qui offre un outil pour r√©cup√©rer les informations d'identit√© utilisateur.

## Vue d‚Äôensemble \{#overview}

Le tutoriel impliquera les composants suivants :

- **Serveur MCP** : Un serveur MCP simple qui utilise les SDK officiels MCP pour g√©rer les requ√™tes.
- **Inspecteur MCP** : Un outil de test visuel pour les serveurs MCP. Il agit √©galement comme un client OAuth / OIDC pour initier le flux d‚Äôautorisation et r√©cup√©rer les jetons d‚Äôacc√®s (Access tokens).
- **Serveur d‚Äôautorisation (Authorization server)** : Un fournisseur OAuth 2.1 ou OpenID Connect qui g√®re les identit√©s utilisateur et √©met les jetons d‚Äôacc√®s (Access tokens).

Voici un sch√©ma de haut niveau de l‚Äôinteraction entre ces composants :

```mermaid
sequenceDiagram
    participant Client as Inspecteur MCP
    participant Server as Serveur MCP
    participant Auth as Serveur d‚Äôautorisation

    Client->>Server: Demande de l‚Äôoutil `whoami`
    Server->>Client: Retourne 401 Non autoris√©
    Client->>Auth: Initie le flux d‚Äôautorisation
    Auth->>Auth: Compl√®te le flux d‚Äôautorisation
    Auth->>Client: Redirige avec le code d‚Äôautorisation
    Client->>Auth: √âchange le code contre un jeton d‚Äôacc√®s
    Auth->>Client: Retourne le jeton d‚Äôacc√®s
    Client->>Server: Demande `whoami` avec le jeton d‚Äôacc√®s
    Server->>Auth: R√©cup√®re l‚Äôidentit√© utilisateur avec le jeton d‚Äôacc√®s
    Auth->>Server: Retourne l‚Äôidentit√© utilisateur
    Server->>Client: Retourne l‚Äôidentit√© utilisateur
```

## Comprendre votre serveur d‚Äôautorisation \{#understand-your-authorization-server}

### R√©cup√©rer les informations d'identit√© utilisateur \{#retrieving-user-identity-information}

Pour compl√©ter ce tutoriel, votre serveur d‚Äôautorisation doit offrir une API pour r√©cup√©rer les informations d'identit√© utilisateur :

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

[Logto](https://logto.io) est un fournisseur OpenID Connect qui prend en charge l‚Äô[endpoint userinfo](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo) standard pour r√©cup√©rer les informations d'identit√© utilisateur.

Pour obtenir un jeton d‚Äôacc√®s (Access token) utilisable sur l‚Äôendpoint userinfo, au moins deux port√©es (Scopes) sont requises : `openid` et `profile`. Vous pouvez continuer √† lire, car nous aborderons la configuration des port√©es plus loin.

</TabItem>
<TabItem value="keycloak" label="Keycloak">

[Keycloak](https://www.keycloak.org) est une solution open-source de gestion des identit√©s et des acc√®s qui prend en charge plusieurs protocoles, dont OpenID Connect (OIDC). En tant que fournisseur OIDC, il impl√©mente l‚Äô[endpoint userinfo](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo) standard pour r√©cup√©rer les informations d'identit√© utilisateur.

Pour obtenir un jeton d‚Äôacc√®s (Access token) utilisable sur l‚Äôendpoint userinfo, au moins deux port√©es (Scopes) sont requises : `openid` et `profile`. Vous pouvez continuer √† lire, car nous aborderons la configuration des port√©es plus loin.

</TabItem>
<TabItem value="oidc" label="OIDC">

La plupart des fournisseurs OpenID Connect prennent en charge l‚Äô[endpoint userinfo](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo) pour r√©cup√©rer les informations d'identit√© utilisateur.

Consultez la documentation de votre fournisseur pour v√©rifier s‚Äôil prend en charge cet endpoint. Si votre fournisseur prend en charge [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), vous pouvez √©galement v√©rifier si le `userinfo_endpoint` est inclus dans le document de d√©couverte (r√©ponse de l‚Äôendpoint `.well-known/openid-configuration`).

Pour obtenir un jeton d‚Äôacc√®s (Access token) utilisable sur l‚Äôendpoint userinfo, au moins deux port√©es (Scopes) sont requises : `openid` et `profile`. Consultez la documentation de votre fournisseur pour voir la correspondance des port√©es avec les revendications d'identit√© utilisateur.

</TabItem>
<TabItem value="oauth" label="OAuth 2">

Bien que OAuth 2.0 ne d√©finisse pas de m√©thode standard pour r√©cup√©rer les informations d'identit√© utilisateur, de nombreux fournisseurs impl√©mentent leurs propres endpoints √† cet effet. Consultez la documentation de votre fournisseur pour savoir comment r√©cup√©rer les informations d'identit√© utilisateur √† l‚Äôaide d‚Äôun jeton d‚Äôacc√®s (Access token) et quels param√®tres sont requis pour obtenir ce jeton lors de l‚Äôappel du flux d‚Äôautorisation.

</TabItem>
</Tabs>

### Enregistrement dynamique du client \{#dynamic-client-registration}

L‚Äôenregistrement dynamique du client n‚Äôest pas requis pour ce tutoriel, mais il peut √™tre utile si vous souhaitez automatiser le processus d‚Äôenregistrement du client MCP aupr√®s de votre serveur d‚Äôautorisation. Consultez [L‚Äôenregistrement dynamique du client est-il requis ?](../../provider-list.mdx#is-dcr-required) pour plus de d√©tails.

## Configurer le serveur MCP \{#set-up-the-mcp-server}

Nous allons utiliser les [SDK officiels MCP](https://github.com/modelcontextprotocol) pour cr√©er un serveur MCP avec un outil `whoami` qui r√©cup√®re les informations d'identit√© utilisateur depuis le serveur d‚Äôautorisation.

### Cr√©er un nouveau projet \{#create-a-new-project}

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```bash
mkdir mcp-server
cd mcp-server
uv init # Ou utilisez `pipenv` ou `poetry` pour cr√©er un nouvel environnement virtuel
```

</TabItem>
<TabItem value="node" label="Node.js">

Cr√©ez un nouveau projet Node.js :

```bash
mkdir mcp-server
cd mcp-server
npm init -y # Ou utilisez `pnpm init`
npm pkg set type="module"
npm pkg set main="whoami.js"
npm pkg set scripts.start="node whoami.js"
```

</TabItem>
</Tabs>

### Installer le SDK MCP et les d√©pendances \{#install-the-mcp-sdk-and-dependencies}

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```bash
pip install "mcp[cli]" starlette uvicorn
```

Ou tout autre gestionnaire de paquets que vous pr√©f√©rez, comme `uv` ou `poetry`.

</TabItem>
<TabItem value="node" label="Node.js">

```bash
npm install @modelcontextprotocol/sdk express
```

Ou tout autre gestionnaire de paquets que vous pr√©f√©rez, comme `pnpm` ou `yarn`.

</TabItem>
</Tabs>

### Cr√©er le serveur MCP \{#create-the-mcp-server}

Commen√ßons par cr√©er un serveur MCP qui impl√©mente un outil `whoami`.

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

Cr√©ez un fichier nomm√© `whoami.py` et ajoutez le code suivant :

```python
from mcp.server.fastmcp import FastMCP
from starlette.applications import Starlette
from starlette.routing import Mount
from typing import Any

mcp = FastMCP("WhoAmI")

@mcp.tool()
def whoami() -> dict[str, Any]:
    """Un outil qui retourne les informations de l‚Äôutilisateur courant."""
    return {"error": "Not authenticated"}

app = Starlette(
    routes=[Mount('/', app=mcp.sse_app())]
)
```

Lancez le serveur avec :

```bash
uvicorn whoami:app --host 0.0.0.0 --port 3001
```

</TabItem>
<TabItem value="node" label="Node.js">

:::note
Comme l‚Äôimpl√©mentation actuelle de l‚Äôinspecteur MCP ne g√®re pas les flux d‚Äôautorisation, nous utiliserons l‚Äôapproche SSE pour configurer le serveur MCP. Nous mettrons √† jour le code ici d√®s que l‚Äôinspecteur MCP prendra en charge les flux d‚Äôautorisation.
:::

Vous pouvez √©galement utiliser `pnpm` ou `yarn` si vous pr√©f√©rez.

Cr√©ez un fichier nomm√© `whoami.js` et ajoutez le code suivant :

```js
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { SSEServerTransport } from '@modelcontextprotocol/sdk/server/sse.js';
import express from 'express';

// Cr√©ez un serveur MCP
const server = new McpServer({
  name: 'WhoAmI',
  version: '0.0.0',
});

// Ajoutez un outil au serveur qui retourne les informations de l‚Äôutilisateur courant
server.tool('whoami', async () => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not authenticated' }) }],
  };
});

// Ci-dessous, le code standard issu de la documentation du SDK MCP
const PORT = 3001;
const app = express();

const transports = {};

app.get('/sse', async (_req, res) => {
  const transport = new SSEServerTransport('/messages', res);
  transports[transport.sessionId] = transport;

  res.on('close', () => {
    delete transports[transport.sessionId];
  });

  await server.connect(transport);
});

app.post('/messages', async (req, res) => {
  const sessionId = String(req.query.sessionId);
  const transport = transports[sessionId];
  if (transport) {
    await transport.handlePostMessage(req, res, req.body);
  } else {
    res.status(400).send('No transport found for sessionId');
  }
});

app.listen(PORT);
```

Lancez le serveur avec :

```bash
npm start
```

</TabItem>
</Tabs>

## Inspecter le serveur MCP \{#inspect-the-mcp-server}

### Cloner et lancer l‚Äôinspecteur MCP \{#clone-and-run-mcp-inspector}

Maintenant que le serveur MCP fonctionne, nous pouvons utiliser l‚Äôinspecteur MCP pour v√©rifier si l‚Äôoutil `whoami` est disponible.

En raison des limites de l‚Äôimpl√©mentation actuelle, nous avons fork√© l‚Äô[inspecteur MCP](https://github.com/mcp-auth/inspector) pour le rendre plus flexible et √©volutif pour l‚Äôauthentification (Authentication) et l‚Äôautorisation (Authorization). Nous avons √©galement soumis une pull request au d√©p√¥t original pour inclure nos modifications.

Pour lancer l‚Äôinspecteur MCP, vous pouvez utiliser la commande suivante (Node.js est requis) :

```bash
git clone https://github.com/mcp-auth/inspector.git
cd inspector
npm install
npm run dev
```

Ensuite, ouvrez votre navigateur et acc√©dez √† `http://localhost:6274/` (ou √† l‚ÄôURL affich√©e dans le terminal) pour acc√©der √† l‚Äôinspecteur MCP.

### Connecter l‚Äôinspecteur MCP au serveur MCP \{#connect-mcp-inspector-to-the-mcp-server}

Avant de continuer, v√©rifiez la configuration suivante dans l‚Äôinspecteur MCP :

- **Type de transport** : R√©glez sur `SSE`.
- **URL** : R√©glez sur l‚ÄôURL de votre serveur MCP. Dans notre cas, il s‚Äôagit de `http://localhost:3001/sse`.

Vous pouvez maintenant cliquer sur le bouton "Connecter" pour voir si l‚Äôinspecteur MCP peut se connecter au serveur MCP. Si tout est correct, vous devriez voir le statut "Connect√©" dans l‚Äôinspecteur MCP.

### Point de contr√¥le : Ex√©cuter l‚Äôoutil `whoami` \{#checkpoint-run-the-whoami-tool}

1. Dans le menu sup√©rieur de l‚Äôinspecteur MCP, cliquez sur l‚Äôonglet "Outils".
2. Cliquez sur le bouton "Lister les outils".
3. Vous devriez voir l‚Äôoutil `whoami` list√© sur la page. Cliquez dessus pour ouvrir les d√©tails de l‚Äôoutil.
4. Vous devriez voir le bouton "Ex√©cuter l‚Äôoutil" √† droite. Cliquez dessus pour ex√©cuter l‚Äôoutil.
5. Vous devriez voir le r√©sultat de l‚Äôoutil avec la r√©ponse JSON `{"error": "Not authenticated"}`.

![Premi√®re ex√©cution de l‚Äôinspecteur MCP](./assets/inspector-first-run.png)

## Int√©grer avec votre serveur d‚Äôautorisation \{#integrate-with-your-authorization-server}

Pour compl√©ter cette section, plusieurs points sont √† prendre en compte :

<details>
<summary>**L‚ÄôURL de l‚Äô√©metteur (Issuer) de votre serveur d‚Äôautorisation**</summary>

Il s‚Äôagit g√©n√©ralement de l‚ÄôURL de base de votre serveur d‚Äôautorisation, comme `https://auth.example.com`. Certains fournisseurs peuvent avoir un chemin comme `https://example.logto.app/oidc`, alors assurez-vous de v√©rifier la documentation de votre fournisseur.

</details>

<details>
<summary>**Comment r√©cup√©rer les m√©tadonn√©es du serveur d‚Äôautorisation**</summary>

- Si votre serveur d‚Äôautorisation est conforme √† la [sp√©cification OAuth 2.0 Authorization Server Metadata](https://datatracker.ietf.org/doc/html/rfc8414) ou √† [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), vous pouvez utiliser les utilitaires int√©gr√©s de MCP Auth pour r√©cup√©rer automatiquement les m√©tadonn√©es.
- Si votre serveur d‚Äôautorisation n‚Äôest pas conforme √† ces standards, vous devrez sp√©cifier manuellement l‚ÄôURL des m√©tadonn√©es ou les endpoints dans la configuration du serveur MCP. Consultez la documentation de votre fournisseur pour les endpoints sp√©cifiques.

</details>

<details>
<summary>**Comment enregistrer l‚Äôinspecteur MCP comme client dans votre serveur d‚Äôautorisation**</summary>

- Si votre serveur d‚Äôautorisation prend en charge [l‚Äôenregistrement dynamique du client](https://datatracker.ietf.org/doc/html/rfc7591), vous pouvez ignorer cette √©tape car l‚Äôinspecteur MCP s‚Äôenregistrera automatiquement comme client.
- Si votre serveur d‚Äôautorisation ne prend pas en charge l‚Äôenregistrement dynamique du client, vous devrez enregistrer manuellement l‚Äôinspecteur MCP comme client dans votre serveur d‚Äôautorisation.

</details>

<details>
<summary>**Comment r√©cup√©rer les informations d'identit√© utilisateur et comment configurer les param√®tres de la requ√™te d‚Äôautorisation**</summary>

- Pour les fournisseurs OpenID Connect : g√©n√©ralement, vous devez demander au moins les port√©es (Scopes) `openid` et `profile` lors de l‚Äôinitiation du flux d‚Äôautorisation. Cela garantira que le jeton d‚Äôacc√®s (Access token) retourn√© par le serveur d‚Äôautorisation contient les port√©es n√©cessaires pour acc√©der √† l‚Äô[endpoint userinfo](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo) et r√©cup√©rer les informations d'identit√© utilisateur.

  Remarque : certains fournisseurs peuvent ne pas prendre en charge l‚Äôendpoint userinfo.

- Pour les fournisseurs OAuth 2.0 / OAuth 2.1 : consultez la documentation de votre fournisseur pour savoir comment r√©cup√©rer les informations d'identit√© utilisateur √† l‚Äôaide d‚Äôun jeton d‚Äôacc√®s (Access token) et quels param√®tres sont requis pour obtenir ce jeton lors de l‚Äôappel du flux d‚Äôautorisation.

</details>

Bien que chaque fournisseur puisse avoir ses propres exigences sp√©cifiques, les √©tapes suivantes vous guideront dans le processus d‚Äôint√©gration de l‚Äôinspecteur MCP et du serveur MCP avec des configurations sp√©cifiques au fournisseur.

### Enregistrer l‚Äôinspecteur MCP comme client \{#register-mcp-inspector-as-a-client}

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

L‚Äôint√©gration avec [Logto](https://logto.io) est simple puisqu‚Äôil s‚Äôagit d‚Äôun fournisseur OpenID Connect qui prend en charge l‚Äô[endpoint userinfo](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo) standard pour r√©cup√©rer les informations d'identit√© utilisateur.

Comme Logto ne prend pas encore en charge l‚Äôenregistrement dynamique du client, vous devrez enregistrer manuellement l‚Äôinspecteur MCP comme client dans votre tenant Logto :

1. Ouvrez votre inspecteur MCP, cliquez sur le bouton "Configuration OAuth". Copiez la valeur **Redirect URL (auto-populated)**, qui devrait ressembler √† `http://localhost:6274/oauth/callback`.
2. Connectez-vous √† [Logto Console](https://cloud.logto.io) (ou √† votre Logto Console auto-h√©berg√©e).
3. Acc√©dez √† l‚Äôonglet "Applications", cliquez sur "Cr√©er une application". En bas de la page, cliquez sur "Cr√©er une application sans framework".
4. Remplissez les d√©tails de l‚Äôapplication, puis cliquez sur "Cr√©er l‚Äôapplication" :
   - **S√©lectionnez un type d‚Äôapplication** : Choisissez "Application monopage".
   - **Nom de l‚Äôapplication** : Entrez un nom pour votre application, par exemple "MCP Inspector".
5. Dans la section "Param√®tres / URI de redirection", collez la valeur **Redirect URL (auto-populated)** copi√©e depuis l‚Äôinspecteur MCP. Cliquez ensuite sur "Enregistrer les modifications" dans la barre du bas.
6. Dans la carte du haut, vous verrez la valeur "App ID". Copiez-la.
7. Retournez dans l‚Äôinspecteur MCP et collez la valeur "App ID" dans la section "Configuration OAuth" sous "Client ID".
8. Entrez la valeur `{"scope": "openid profile email"}` dans le champ "Auth Params". Cela garantira que le jeton d‚Äôacc√®s (Access token) retourn√© par Logto contient les port√©es n√©cessaires pour acc√©der √† l‚Äôendpoint userinfo.

</TabItem>
<TabItem value="keycloak" label="Keycloak">

[Keycloak](https://www.keycloak.org) est une solution open-source de gestion des identit√©s et des acc√®s qui prend en charge le protocole OpenID Connect.

Bien que Keycloak prenne en charge l‚Äôenregistrement dynamique du client, son endpoint d‚Äôenregistrement ne prend pas en charge CORS, ce qui emp√™che la plupart des clients MCP de s‚Äôenregistrer directement. Nous devrons donc enregistrer notre client manuellement.

:::note
Bien que Keycloak puisse √™tre install√© de [diff√©rentes mani√®res](https://www.keycloak.org/guides#getting-started) (bare metal, kubernetes, etc.), pour ce tutoriel, nous utiliserons Docker pour une configuration rapide et simple.
:::

Configurons une instance Keycloak et adaptons-la √† nos besoins :

1. Lancez une instance Keycloak avec Docker en suivant la [documentation officielle](https://www.keycloak.org/getting-started/getting-started-docker) :

```bash
docker run -p 8080:8080 -e KC_BOOTSTRAP_ADMIN_USERNAME=admin -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak:26.2.4 start-dev
```

2. Acc√©dez √† la console d‚Äôadministration Keycloak (http://localhost:8080/admin) et connectez-vous avec ces identifiants :

   - Nom d‚Äôutilisateur : `admin`
   - Mot de passe : `admin`

3. Cr√©ez un nouveau Realm :

   - Cliquez sur "Create Realm" en haut √† gauche
   - Entrez `mcp-realm` dans le champ "Realm name"
   - Cliquez sur "Create"

4. Cr√©ez un utilisateur de test :

   - Cliquez sur "Users" dans le menu de gauche
   - Cliquez sur "Create new user"
   - Remplissez les informations utilisateur :
     - Nom d‚Äôutilisateur : `testuser`
     - Pr√©nom et nom peuvent √™tre quelconques
   - Cliquez sur "Create"
   - Dans l‚Äôonglet "Credentials", d√©finissez un mot de passe et d√©cochez "Temporary"

5. Enregistrez l‚Äôinspecteur MCP comme client :

   - Ouvrez votre inspecteur MCP, cliquez sur le bouton "Configuration OAuth". Copiez la valeur **Redirect URL (auto-populated)**, qui devrait ressembler √† `http://localhost:6274/oauth/callback`.
   - Dans la console d‚Äôadministration Keycloak, cliquez sur "Clients" dans le menu de gauche
   - Cliquez sur "Create client"
   - Remplissez les d√©tails du client :
     - Type de client : S√©lectionnez "OpenID Connect"
     - Client ID : Entrez `mcp-inspector`
     - Cliquez sur "Next"
   - Sur la page "Capability config" :
     - Assurez-vous que "Standard flow" est activ√©
     - Cliquez sur "Next"
   - Sur la page "Login settings" :
     - Collez l‚ÄôURL de rappel de l‚Äôinspecteur MCP pr√©c√©demment copi√©e dans "Valid redirect URIs"
     - Entrez `http://localhost:6274` dans "Web origins"
     - Cliquez sur "Save"
   - Copiez le "Client ID" (qui est `mcp-inspector`)

6. De retour dans l‚Äôinspecteur MCP :
   - Collez le Client ID copi√© dans le champ "Client ID" de la section "Configuration OAuth"
   - Entrez la valeur suivante dans le champ "Auth Params" pour demander les port√©es n√©cessaires :

```json
{ "scope": "openid profile email" }
```

</TabItem>
<TabItem value="oidc" label="OIDC">

:::note
Ceci est un guide g√©n√©rique d‚Äôint√©gration avec un fournisseur OpenID Connect. Consultez la documentation de votre fournisseur pour les d√©tails sp√©cifiques.
:::

Si votre fournisseur OpenID Connect prend en charge l‚Äôenregistrement dynamique du client, vous pouvez passer directement √† l‚Äô√©tape 8 ci-dessous pour configurer l‚Äôinspecteur MCP ; sinon, vous devrez enregistrer manuellement l‚Äôinspecteur MCP comme client dans votre fournisseur OpenID Connect :

1. Ouvrez votre inspecteur MCP, cliquez sur le bouton "Configuration OAuth". Copiez la valeur **Redirect URL (auto-populated)**, qui devrait ressembler √† `http://localhost:6274/oauth/callback`.
2. Connectez-vous √† la console de votre fournisseur OpenID Connect.
3. Acc√©dez √† la section "Applications" ou "Clients", puis cr√©ez une nouvelle application ou un nouveau client.
4. Si votre fournisseur demande un type de client, s√©lectionnez "Application monopage" ou "Client public".
5. Apr√®s avoir cr√©√© l‚Äôapplication, vous devrez configurer l‚ÄôURI de redirection. Collez la valeur **Redirect URL (auto-populated)** copi√©e depuis l‚Äôinspecteur MCP.
6. Trouvez le "Client ID" ou "Application ID" de la nouvelle application et copiez-le.
7. Retournez dans l‚Äôinspecteur MCP et collez la valeur "Client ID" dans la section "Configuration OAuth" sous "Client ID".
8. Pour les fournisseurs OpenID Connect standards, vous pouvez entrer la valeur suivante dans le champ "Auth Params" pour demander les port√©es n√©cessaires √† l‚Äôacc√®s √† l‚Äôendpoint userinfo :

```json
{ "scope": "openid profile email" }
```

</TabItem>
<TabItem value="oauth" label="OAuth 2">

:::note
Ceci est un guide g√©n√©rique d‚Äôint√©gration avec un fournisseur OAuth 2.0 / OAuth 2.1. Consultez la documentation de votre fournisseur pour les d√©tails sp√©cifiques.
:::

Si votre fournisseur OAuth 2.0 / OAuth 2.1 prend en charge l‚Äôenregistrement dynamique du client, vous pouvez passer directement √† l‚Äô√©tape 8 ci-dessous pour configurer l‚Äôinspecteur MCP ; sinon, vous devrez enregistrer manuellement l‚Äôinspecteur MCP comme client dans votre fournisseur OAuth 2.0 / OAuth 2.1 :

1. Ouvrez votre inspecteur MCP, cliquez sur le bouton "Configuration OAuth". Copiez la valeur **Redirect URL (auto-populated)**, qui devrait ressembler √† `http://localhost:6274/oauth/callback`.
2. Connectez-vous √† la console de votre fournisseur OAuth 2.0 / OAuth 2.1.
3. Acc√©dez √† la section "Applications" ou "Clients", puis cr√©ez une nouvelle application ou un nouveau client.
4. Si votre fournisseur demande un type de client, s√©lectionnez "Application monopage" ou "Client public".
5. Apr√®s avoir cr√©√© l‚Äôapplication, vous devrez configurer l‚ÄôURI de redirection. Collez la valeur **Redirect URL (auto-populated)** copi√©e depuis l‚Äôinspecteur MCP.
6. Trouvez le "Client ID" ou "Application ID" de la nouvelle application et copiez-le.
7. Retournez dans l‚Äôinspecteur MCP et collez la valeur "Client ID" dans la section "Configuration OAuth" sous "Client ID".
8. Consultez la documentation de votre fournisseur pour savoir comment obtenir des jetons d‚Äôacc√®s pour les informations d'identit√© utilisateur. Vous devrez peut-√™tre sp√©cifier les port√©es ou param√®tres requis pour obtenir le jeton d‚Äôacc√®s. Par exemple, si votre fournisseur exige la port√©e `profile` pour acc√©der aux informations d'identit√© utilisateur, vous pouvez entrer la valeur suivante dans le champ "Auth Params" :

```json
{ "scope": "profile" }
```

</TabItem>
</Tabs>

### Configurer MCP Auth \{#set-up-mcp-auth}

Dans votre projet serveur MCP, vous devez installer le SDK MCP Auth et le configurer pour utiliser les m√©tadonn√©es de votre serveur d‚Äôautorisation.

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

D‚Äôabord, installez le paquet `mcpauth` :

```bash
pip install mcpauth
```

Ou tout autre gestionnaire de paquets que vous pr√©f√©rez, comme `uv` ou `poetry`.

</TabItem>
<TabItem value="node" label="Node.js">

D‚Äôabord, installez le paquet `mcp-auth` :

```bash
npm install mcp-auth
```

</TabItem>
</Tabs>

MCP Auth n√©cessite les m√©tadonn√©es du serveur d‚Äôautorisation pour pouvoir s‚Äôinitialiser. Selon votre fournisseur :

<Tabs groupId="provider">

<TabItem value="logto" label="Logto">

L‚ÄôURL de l‚Äô√©metteur (Issuer) se trouve sur la page de d√©tails de votre application dans Logto Console, dans la section "Endpoints & Credentials / Issuer endpoint". Elle devrait ressembler √† `https://my-project.logto.app/oidc`.

<SetupOidc />

</TabItem>

<TabItem value="keycloak" label="Keycloak">

L‚ÄôURL de l‚Äô√©metteur (Issuer) se trouve dans votre console d‚Äôadministration Keycloak. Dans votre 'mcp-realm', acc√©dez √† la section "Realm settings / Endpoints" et cliquez sur le lien "OpenID Endpoint Configuration". Le champ `issuer` dans le document JSON contiendra votre URL d‚Äô√©metteur, qui devrait ressembler √† `http://localhost:8080/realms/mcp-realm`.

<SetupOidc />

</TabItem>

<TabItem value="oidc" label="OIDC">

Le code suivant suppose √©galement que le serveur d‚Äôautorisation prend en charge l‚Äô[endpoint userinfo](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo) pour r√©cup√©rer les informations d'identit√© utilisateur. Si votre fournisseur ne prend pas en charge cet endpoint, vous devrez consulter la documentation de votre fournisseur pour l‚Äôendpoint sp√©cifique et remplacer la variable userinfo endpoint par la bonne URL.

<SetupOidc showAlternative />

</TabItem>
<TabItem value="oauth" label="OAuth 2">

Comme mentionn√© pr√©c√©demment, OAuth 2.0 ne d√©finit pas de m√©thode standard pour r√©cup√©rer les informations d'identit√© utilisateur. Le code suivant suppose que votre fournisseur dispose d‚Äôun endpoint sp√©cifique pour r√©cup√©rer les informations d'identit√© utilisateur √† l‚Äôaide d‚Äôun jeton d‚Äôacc√®s (Access token). Vous devrez consulter la documentation de votre fournisseur pour l‚Äôendpoint sp√©cifique et remplacer la variable userinfo endpoint par la bonne URL.

<SetupOauth />

</TabItem>
</Tabs>

### Mettre √† jour le serveur MCP \{#update-mcp-server}

Nous y sommes presque ! Il est temps de mettre √† jour le serveur MCP pour appliquer la route MCP Auth et la fonction middleware, puis faire en sorte que l‚Äôoutil `whoami` retourne les v√©ritables informations d'identit√© utilisateur.

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```python
@mcp.tool()
def whoami() -> dict[str, Any]:
    """Un outil qui retourne les informations de l‚Äôutilisateur courant."""
    return (
        mcp_auth.auth_info.claims
        if mcp_auth.auth_info # Ceci sera renseign√© par le middleware Bearer auth
        else {"error": "Not authenticated"}
    )

# ...

bearer_auth = Middleware(mcp_auth.bearer_auth_middleware(verify_access_token))
app = Starlette(
    routes=[
        # Ajoutez la route des m√©tadonn√©es (`/.well-known/oauth-authorization-server`)
        mcp_auth.metadata_route(),
        # Prot√©gez le serveur MCP avec le middleware Bearer auth
        Mount('/', app=mcp.sse_app(), middleware=[bearer_auth]),
    ],
)
```

</TabItem>
<TabItem value="node" label="Node.js">

```js
server.tool('whoami', ({ authInfo }) => {
  return {
    content: [
      { type: 'text', text: JSON.stringify(authInfo?.claims ?? { error: 'Not authenticated' }) },
    ],
  };
});

// ...

app.use(mcpAuth.delegatedRouter());
app.use(mcpAuth.bearerAuth(verifyToken));
```

</TabItem>
</Tabs>

## Point de contr√¥le : Ex√©cuter l‚Äôoutil `whoami` avec authentification \{#checkpoint-run-the-whoami-tool-with-authentication}

Red√©marrez votre serveur MCP et ouvrez l‚Äôinspecteur MCP dans votre navigateur. Lorsque vous cliquez sur le bouton "Connecter", vous devriez √™tre redirig√© vers la page de connexion de votre serveur d‚Äôautorisation.

Une fois connect√© et de retour dans l‚Äôinspecteur MCP, r√©p√©tez les actions du point de contr√¥le pr√©c√©dent pour ex√©cuter l‚Äôoutil `whoami`. Cette fois, vous devriez voir les informations d'identit√© utilisateur retourn√©es par le serveur d‚Äôautorisation.

![R√©sultat de l‚Äôoutil whoami dans l‚Äôinspecteur MCP](./assets/result.png)

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

:::info
Consultez le [d√©p√¥t du SDK MCP Auth Python](https://github.com/mcp-auth/python/blob/master/samples/server/whoami.py) pour le code complet du serveur MCP (version OIDC).
:::

</TabItem>
<TabItem value="node" label="Node.js">

:::info
Consultez le [d√©p√¥t du SDK MCP Auth Node.js](https://github.com/mcp-auth/js/blob/master/packages/sample-servers/src) pour le code complet du serveur MCP (version OIDC). Ce r√©pertoire contient les versions TypeScript et JavaScript du code.
:::

</TabItem>
</Tabs>

## Notes de cl√¥ture \{#closing-notes}

üéä F√©licitations ! Vous avez termin√© avec succ√®s le tutoriel. R√©capitulons ce que nous avons fait :

- Mise en place d‚Äôun serveur MCP basique avec l‚Äôoutil `whoami`
- Int√©gration du serveur MCP avec un serveur d‚Äôautorisation via MCP Auth
- Configuration de l‚Äôinspecteur MCP pour authentifier les utilisateurs et r√©cup√©rer leurs informations d'identit√©

Vous pouvez √©galement explorer des sujets avanc√©s, notamment :

- Utiliser [JWT (JSON Web Token)](https://auth.wiki/jwt) pour l‚Äôauthentification (Authentication) et l‚Äôautorisation (Authorization)
- Exploiter les [indicateurs de ressource (RFC 8707)](https://auth-wiki.logto.io/resource-indicator) pour sp√©cifier les ressources acc√©d√©es
- Impl√©menter des m√©canismes de contr√¥le d‚Äôacc√®s personnalis√©s, tels que le [contr√¥le d‚Äôacc√®s bas√© sur les r√¥les (RBAC)](https://auth.wiki/rbac) ou le [contr√¥le d‚Äôacc√®s bas√© sur les attributs (ABAC)](https://auth.wiki/abac)

N‚Äôh√©sitez pas √† consulter d‚Äôautres tutoriels et la documentation pour tirer le meilleur parti de MCP Auth.