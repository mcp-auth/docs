---
sidebar_position: 2
sidebar_label: 'æ•™å­¸ï¼šæ‰“é€ ä¸€å€‹å¾…è¾¦äº‹é …ç®¡ç†å™¨'
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';


# æ•™å­¸ï¼šæ‰“é€ ä¸€å€‹å¾…è¾¦äº‹é …ç®¡ç†å™¨

åœ¨æœ¬æ•™å­¸ä¸­ï¼Œæˆ‘å€‘å°‡å»ºç«‹ä¸€å€‹å…·å‚™ä½¿ç”¨è€…é©—è­‰ (Authentication) èˆ‡æˆæ¬Š (Authorization) çš„ todo manager MCP ä¼ºæœå™¨ã€‚æ ¹æ“šæœ€æ–°çš„ MCP è¦ç¯„ï¼Œæˆ‘å€‘çš„ MCP ä¼ºæœå™¨å°‡ä½œç‚º OAuth 2.0 **è³‡æºä¼ºæœå™¨ (Resource Server)**ï¼Œè² è²¬é©—è­‰å­˜å–æ¬Šæ– (Access token) ä¸¦å¼·åˆ¶åŸ·è¡ŒåŸºæ–¼æ¬Šé™ç¯„åœ (Scope) çš„æ¬Šé™ã€‚

å®Œæˆæœ¬æ•™å­¸å¾Œï¼Œä½ å°‡æ“æœ‰ï¼š

- âœ… åŸºæœ¬ç­è§£å¦‚ä½•åœ¨ MCP ä¼ºæœå™¨ä¸­è¨­å®šè§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC, Role-based access control)
- âœ… ä¸€å€‹ä½œç‚ºè³‡æºä¼ºæœå™¨ (Resource Server) çš„ MCP ä¼ºæœå™¨ï¼Œèƒ½æ¶ˆè€—ç”±æˆæ¬Šä¼ºæœå™¨ (Authorization Server) ç™¼å‡ºçš„å­˜å–æ¬Šæ– (Access token)
- âœ… ä¸€å€‹å¯é‹ä½œçš„åŸºæ–¼æ¬Šé™ç¯„åœ (Scope) çš„æ¬Šé™æ§ç®¡å¯¦ä½œï¼Œé©ç”¨æ–¼ todo æ“ä½œ

## æ¦‚è¦½ \{#overview}

æœ¬æ•™å­¸å°‡åŒ…å«ä»¥ä¸‹å…ƒä»¶ï¼š

- **MCP ç”¨æˆ¶ç«¯ (MCP Inspector)**ï¼šä¸€å€‹ç”¨æ–¼æ¸¬è©¦ MCP ä¼ºæœå™¨çš„è¦–è¦ºåŒ–å·¥å…·ï¼Œä½œç‚º OAuth 2.0 / OIDC ç”¨æˆ¶ç«¯ã€‚å®ƒæœƒå•Ÿå‹•æˆæ¬Šæµç¨‹ï¼Œä¸¦å‘ MCP ä¼ºæœå™¨ç™¼é€å¸¶æœ‰å­˜å–æ¬Šæ– (Access token) çš„è«‹æ±‚ã€‚
- **æˆæ¬Šä¼ºæœå™¨ (Authorization Server)**ï¼šä¸€å€‹ OAuth 2.1 æˆ– OpenID Connect ç°½ç™¼è€… (Issuer)ï¼Œè² è²¬ç®¡ç†ä½¿ç”¨è€…èº«åˆ†ã€é©—è­‰ä½¿ç”¨è€…ï¼Œä¸¦å‘æˆæ¬Šç”¨æˆ¶ç«¯ç™¼å‡ºå¸¶æœ‰é©ç•¶æ¬Šé™ç¯„åœ (Scope) çš„å­˜å–æ¬Šæ– (Access token)ã€‚
- **MCP ä¼ºæœå™¨ (Resource Server)**ï¼šæ ¹æ“šæœ€æ–° MCP è¦ç¯„ï¼ŒMCP ä¼ºæœå™¨åœ¨ OAuth 2.0 æ¶æ§‹ä¸­ä½œç‚ºè³‡æºä¼ºæœå™¨ (Resource Server)ã€‚å®ƒé©—è­‰æˆæ¬Šä¼ºæœå™¨ç™¼å‡ºçš„å­˜å–æ¬Šæ– (Access token)ï¼Œä¸¦æ ¹æ“šæ¬Šé™ç¯„åœ (Scope) å¼·åˆ¶åŸ·è¡Œ todo æ“ä½œçš„æ¬Šé™ã€‚

æ­¤æ¶æ§‹éµå¾ªæ¨™æº– OAuth 2.0 æµç¨‹ï¼š

- **MCP Inspector** ä»£è¡¨ä½¿ç”¨è€…è«‹æ±‚å—ä¿è­·è³‡æº
- **æˆæ¬Šä¼ºæœå™¨ (Authorization Server)** é©—è­‰ä½¿ç”¨è€…ä¸¦ç™¼å‡ºå­˜å–æ¬Šæ– (Access token)
- **MCP ä¼ºæœå™¨ (Resource Server)** é©—è­‰æ¬Šæ–ä¸¦æ ¹æ“šæˆæ¬Šæ¬Šé™æä¾›å—ä¿è­·è³‡æº

ä»¥ä¸‹æ˜¯é€™äº›å…ƒä»¶äº’å‹•çš„é«˜éšæµç¨‹åœ–ï¼š

```mermaid
sequenceDiagram
  autonumber
  participant Client as MCP Inspector<br/>(OAuth ç”¨æˆ¶ç«¯)
  participant RS as MCP ä¼ºæœå™¨<br/>(è³‡æºä¼ºæœå™¨)
  participant AS as æˆæ¬Šä¼ºæœå™¨ (Authorization Server)

  Client->>RS: MCP è«‹æ±‚ï¼ˆç„¡æ¬Šæ–ï¼‰
  RS-->>Client: 401 æœªæˆæ¬Š (WWW-Authenticate)
  Note over Client: å¾ WWW-Authenticate æ¨™é ­<br/>æ“·å– resource_metadata URL

  Client->>RS: GET /.well-known/oauth-protected-resource (resource_metadata)
  RS-->>Client: å—ä¿è­·è³‡æºä¸­ç¹¼è³‡æ–™<br/>(åŒ…å«æˆæ¬Šä¼ºæœå™¨ URL)

  Client->>AS: GET /.well-known/oauth-authorization-server
  AS-->>Client: æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™
  Client->>AS: OAuth æˆæ¬Šï¼ˆç™»å…¥èˆ‡åŒæ„ï¼‰
  AS-->>Client: å­˜å–æ¬Šæ– (Access token)

  Client->>RS: MCP è«‹æ±‚ (Authorization: Bearer <token>)
  RS->>RS: é©—è­‰å­˜å–æ¬Šæ–æœ‰æ•ˆä¸”å·²æˆæ¬Š
  RS-->>Client: MCP å›æ‡‰
```

## ç­è§£ä½ çš„æˆæ¬Šä¼ºæœå™¨ \{#understand-your-authorization-server}

### å…·å‚™æ¬Šé™ç¯„åœ (Scope) çš„å­˜å–æ¬Šæ– (Access tokens) \{#access-tokens-with-scopes}

è‹¥è¦åœ¨ MCP ä¼ºæœå™¨ä¸­å¯¦ä½œ [è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC)](https://auth.wiki/rbac)ï¼Œä½ çš„æˆæ¬Šä¼ºæœå™¨éœ€æ”¯æ´ç™¼å‡ºå¸¶æœ‰æ¬Šé™ç¯„åœ (Scope) çš„å­˜å–æ¬Šæ– (Access token)ã€‚æ¬Šé™ç¯„åœ (Scope) ä»£è¡¨ä½¿ç”¨è€…è¢«æˆäºˆçš„æ¬Šé™ã€‚

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

[Logto](https://logto.io) é€éå…¶ API è³‡æº (API resources)ï¼ˆç¬¦åˆ [RFC 8707: OAuth 2.0 è³‡æºæ¨™ç¤ºç¬¦ (Resource Indicators)](https://datatracker.ietf.org/doc/html/rfc8707)ï¼‰èˆ‡è§’è‰² (Roles) åŠŸèƒ½æä¾› RBAC æ”¯æ´ã€‚è¨­å®šæ–¹å¼å¦‚ä¸‹ï¼š

1. ç™»å…¥ [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ¶ Logto Consoleï¼‰

2. å»ºç«‹ API è³‡æºèˆ‡æ¬Šé™ç¯„åœ (Scope)ï¼š

   - å‰å¾€ã€ŒAPI è³‡æºã€
   - å»ºç«‹ä¸€å€‹åç‚ºã€ŒTodo Managerã€çš„æ–° API è³‡æº
   - æ–°å¢ä»¥ä¸‹æ¬Šé™ç¯„åœ (Scope)ï¼š
     - `create:todos`ï¼šã€Œå»ºç«‹æ–°çš„å¾…è¾¦äº‹é …ã€
     - `read:todos`ï¼šã€Œè®€å–æ‰€æœ‰å¾…è¾¦äº‹é …ã€
     - `delete:todos`ï¼šã€Œåˆªé™¤ä»»ä¸€å¾…è¾¦äº‹é …ã€

3. å»ºç«‹è§’è‰²ï¼ˆå»ºè­°ä»¥ä¾¿ç®¡ç†ï¼‰ï¼š

   - å‰å¾€ã€Œè§’è‰²ã€
   - å»ºç«‹ã€ŒAdminã€è§’è‰²ä¸¦æŒ‡æ´¾æ‰€æœ‰æ¬Šé™ç¯„åœï¼ˆ`create:todos`ã€`read:todos`ã€`delete:todos`ï¼‰
   - å»ºç«‹ã€ŒUserã€è§’è‰²ä¸¦åƒ…æŒ‡æ´¾ `create:todos` æ¬Šé™ç¯„åœ

4. æŒ‡æ´¾æ¬Šé™ï¼š
   - å‰å¾€ã€Œä½¿ç”¨è€…ã€
   - é¸æ“‡ä¸€ä½ä½¿ç”¨è€…
   - ä½ å¯ä»¥ï¼š
     - åœ¨ã€Œè§’è‰²ã€åˆ†é æŒ‡æ´¾è§’è‰²ï¼ˆå»ºè­°ï¼‰
     - æˆ–ç›´æ¥åœ¨ã€Œæ¬Šé™ã€åˆ†é æŒ‡æ´¾æ¬Šé™ç¯„åœ

æ¬Šé™ç¯„åœ (Scope) æœƒä»¥ç©ºæ ¼åˆ†éš”å­—ä¸²çš„å½¢å¼åŒ…å«åœ¨ JWT å­˜å–æ¬Šæ– (Access token) çš„ `scope` å®£å‘Š (Claim) ä¸­ã€‚

</TabItem>
<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

OAuth 2.0 / OIDC ç°½ç™¼è€… (Issuer) é€šå¸¸æ”¯æ´åŸºæ–¼æ¬Šé™ç¯„åœ (Scope) çš„å­˜å–æ§åˆ¶ã€‚å¯¦ä½œ RBAC æ™‚ï¼š

1. åœ¨æˆæ¬Šä¼ºæœå™¨ä¸­å®šç¾©æ‰€éœ€çš„æ¬Šé™ç¯„åœ (Scope)
2. è¨­å®šç”¨æˆ¶ç«¯åœ¨æˆæ¬Šæµç¨‹ä¸­è«‹æ±‚é€™äº›æ¬Šé™ç¯„åœ
3. ç¢ºä¿æˆæ¬Šä¼ºæœå™¨åœ¨å­˜å–æ¬Šæ– (Access token) ä¸­åŒ…å«æˆäºˆçš„æ¬Šé™ç¯„åœ
4. æ¬Šé™ç¯„åœé€šå¸¸æœƒåŒ…å«åœ¨ JWT å­˜å–æ¬Šæ–çš„ `scope` å®£å‘Š (Claim) ä¸­

è«‹æŸ¥é–±ä½ çš„ç°½ç™¼è€… (Issuer) æ–‡ä»¶ä»¥ç­è§£ï¼š

- å¦‚ä½•å®šç¾©èˆ‡ç®¡ç†æ¬Šé™ç¯„åœ (Scope)
- æ¬Šé™ç¯„åœå¦‚ä½•åŒ…å«åœ¨å­˜å–æ¬Šæ– (Access token) ä¸­
- æ˜¯å¦æœ‰é¡å¤–çš„ RBAC åŠŸèƒ½å¦‚è§’è‰²ç®¡ç†

</TabItem>
</Tabs>

### æ¬Šæ–é©—è­‰èˆ‡æ¬Šé™æª¢æŸ¥ \{#validating-tokens-and-checking-permissions}

æ ¹æ“šæœ€æ–° MCP è¦ç¯„ï¼ŒMCP ä¼ºæœå™¨åœ¨ OAuth 2.0 æ¶æ§‹ä¸­ä½œç‚º **è³‡æºä¼ºæœå™¨ (Resource Server)**ã€‚ä½œç‚ºè³‡æºä¼ºæœå™¨ï¼ŒMCP ä¼ºæœå™¨æœ‰ä»¥ä¸‹è·è²¬ï¼š

1. **æ¬Šæ–é©—è­‰**ï¼šé©—è­‰å¾ MCP ç”¨æˆ¶ç«¯æ”¶åˆ°çš„å­˜å–æ¬Šæ– (Access token) çš„çœŸå¯¦æ€§èˆ‡å®Œæ•´æ€§
2. **æ¬Šé™ç¯„åœå¼·åˆ¶åŸ·è¡Œ**ï¼šå¾å­˜å–æ¬Šæ–ä¸­æ“·å–ä¸¦é©—è­‰æ¬Šé™ç¯„åœ (Scope)ï¼Œä»¥æ±ºå®šç”¨æˆ¶ç«¯è¢«æˆæ¬ŠåŸ·è¡Œå“ªäº›æ“ä½œ
3. **è³‡æºä¿è­·**ï¼šåƒ…åœ¨ç”¨æˆ¶ç«¯æä¾›æœ‰æ•ˆä¸”å…·å‚™è¶³å¤ æ¬Šé™çš„æ¬Šæ–æ™‚ï¼Œæ‰æä¾›å—ä¿è­·è³‡æºï¼ˆåŸ·è¡Œå·¥å…·ï¼‰

ç•¶ MCP ä¼ºæœå™¨æ”¶åˆ°è«‹æ±‚æ™‚ï¼ŒæœƒåŸ·è¡Œä»¥ä¸‹é©—è­‰æµç¨‹ï¼š

1. å¾ `Authorization` æ¨™é ­æ“·å–å­˜å–æ¬Šæ–ï¼ˆBearer æ¬Šæ–æ ¼å¼ï¼‰
2. é©—è­‰å­˜å–æ¬Šæ–çš„ç°½ç« èˆ‡æœ‰æ•ˆæœŸé™
3. å¾å·²é©—è­‰çš„æ¬Šæ–ä¸­æ“·å–æ¬Šé™ç¯„åœèˆ‡ä½¿ç”¨è€…è³‡è¨Š
4. æª¢æŸ¥æ¬Šæ–æ˜¯å¦å…·å‚™åŸ·è¡Œè«‹æ±‚æ“ä½œæ‰€éœ€çš„æ¬Šé™ç¯„åœ

ä¾‹å¦‚ï¼Œè‹¥ä½¿ç”¨è€…è¦å»ºç«‹æ–°çš„å¾…è¾¦äº‹é …ï¼Œå…¶å­˜å–æ¬Šæ–å¿…é ˆåŒ…å« `create:todos` æ¬Šé™ç¯„åœã€‚ä»¥ä¸‹ç‚ºè³‡æºä¼ºæœå™¨é©—è­‰æµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant Client as MCP ç”¨æˆ¶ç«¯
    participant Server as MCP ä¼ºæœå™¨<br/>(è³‡æºä¼ºæœå™¨)
    participant Auth as æˆæ¬Šä¼ºæœå™¨ (Authorization Server)

    Client->>Server: å¸¶å­˜å–æ¬Šæ–çš„è«‹æ±‚<br/>(Authorization: Bearer <token>)

    alt JWT é©—è­‰ï¼ˆæ¨è–¦ï¼‰
        Server->>Auth: å–å¾— JWKSï¼ˆè‹¥æœªå¿«å–ï¼‰
        Auth-->>Server: å›å‚³ JWKS
        Server->>Server: æœ¬åœ°é©—è­‰ JWT ç°½ç« èˆ‡å®£å‘Š
    else æ¬Šæ–å…§çœï¼ˆå‚™ç”¨ï¼‰
        Server->>Auth: POST /introspect<br/>(token=access_token)
        Auth-->>Server: å›å‚³æ¬Šæ–è³‡è¨Š<br/>(active, scope, user_id, ç­‰)
    end

    Server->>Server: å¾å·²é©—è­‰æ¬Šæ–æ“·å–æ¬Šé™ç¯„åœèˆ‡ä½¿ç”¨è€…ä¸Šä¸‹æ–‡

    alt å…·å‚™æ‰€éœ€æ¬Šé™ç¯„åœ
        Server->>Server: åŸ·è¡Œè«‹æ±‚æ“ä½œ
        Server->>Client: å›å‚³æ“ä½œçµæœ
    else æ¬ ç¼ºæ‰€éœ€æ¬Šé™ç¯„åœ
        Server->>Client: å›å‚³ 403 Forbidden<br/>(insufficient_scope error)
    end
```

### å‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Š (Dynamic Client Registration) \{#dynamic-client-registration}

æœ¬æ•™å­¸ä¸å¼·åˆ¶è¦æ±‚å‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Šï¼Œä½†è‹¥ä½ æƒ³è‡ªå‹•åŒ– MCP ç”¨æˆ¶ç«¯åœ¨æˆæ¬Šä¼ºæœå™¨çš„è¨»å†Šæµç¨‹ï¼Œå¯åƒè€ƒ [æ˜¯å¦éœ€è¦å‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Šï¼Ÿ](/provider-list#is-dcr-required) ä»¥å–å¾—æ›´å¤šè³‡è¨Šã€‚

## ç­è§£ todo manager ä¸­çš„ RBAC \{#understand-rbac-in-todo-manager}

ç‚ºäº†ç¤ºç¯„ï¼Œæˆ‘å€‘æœƒåœ¨ todo manager MCP ä¼ºæœå™¨ä¸­å¯¦ä½œä¸€å€‹ç°¡å–®çš„è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC) ç³»çµ±ã€‚é€™å°‡è®“ä½ ç­è§£ RBAC çš„åŸºæœ¬åŸç†ï¼ŒåŒæ™‚ä¿æŒå¯¦ä½œç°¡æ½”ã€‚

:::note
é›–ç„¶æœ¬æ•™å­¸ä»¥ RBAC ç‚ºåŸºç¤é€²è¡Œæ¬Šé™ç¯„åœç®¡ç†ï¼Œä½†éœ€æ³¨æ„ä¸¦éæ‰€æœ‰é©—è­‰ (Authentication) ç°½ç™¼è€… (Issuer) éƒ½é€éè§’è‰²ä¾†ç®¡ç†æ¬Šé™ç¯„åœã€‚æœ‰äº›ç°½ç™¼è€…å¯èƒ½æœ‰è‡ªå·±ç¨ç‰¹çš„å­˜å–æ§åˆ¶èˆ‡æ¬Šé™ç®¡ç†æ©Ÿåˆ¶ã€‚
:::

### å·¥å…·èˆ‡æ¬Šé™ç¯„åœ (Scope) \{#tools-and-scopes}

æˆ‘å€‘çš„ todo manager MCP ä¼ºæœå™¨æä¾›ä¸‰å€‹ä¸»è¦å·¥å…·ï¼š

- `create-todo`ï¼šå»ºç«‹æ–°çš„å¾…è¾¦äº‹é …
- `get-todos`ï¼šåˆ—å‡ºæ‰€æœ‰å¾…è¾¦äº‹é …
- `delete-todo`ï¼šæ ¹æ“š ID åˆªé™¤å¾…è¾¦äº‹é …

ç‚ºäº†æ§ç®¡é€™äº›å·¥å…·çš„å­˜å–ï¼Œæˆ‘å€‘å®šç¾©ä»¥ä¸‹æ¬Šé™ç¯„åœ (Scope)ï¼š

- `create:todos`ï¼šå…è¨±å»ºç«‹æ–°çš„å¾…è¾¦äº‹é …
- `delete:todos`ï¼šå…è¨±åˆªé™¤ç¾æœ‰å¾…è¾¦äº‹é …
- `read:todos`ï¼šå…è¨±æŸ¥è©¢ä¸¦å–å¾—æ‰€æœ‰å¾…è¾¦äº‹é …åˆ—è¡¨

### è§’è‰²èˆ‡æ¬Šé™ \{#roles-and-permissions}

æˆ‘å€‘å°‡å®šç¾©å…©å€‹ä¸åŒå­˜å–å±¤ç´šçš„è§’è‰²ï¼š

| è§’è‰²  | create:todos | read:todos | delete:todos |
| ----- | ------------ | ---------- | ------------ |
| Admin | âœ…           | âœ…         | âœ…           |
| User  | âœ…           |            |              |

- **User**ï¼šä¸€èˆ¬ä½¿ç”¨è€…ï¼Œå¯å»ºç«‹å¾…è¾¦äº‹é …ï¼Œåƒ…èƒ½æª¢è¦–æˆ–åˆªé™¤è‡ªå·±çš„å¾…è¾¦äº‹é …
- **Admin**ï¼šç®¡ç†å“¡ï¼Œå¯å»ºç«‹ã€æª¢è¦–ä¸¦åˆªé™¤æ‰€æœ‰å¾…è¾¦äº‹é …ï¼Œä¸è«–æ“æœ‰è€…ç‚ºèª°

### è³‡æºæ“æœ‰æ¬Š \{#resource-ownership}

é›–ç„¶ä¸Šè¡¨æ˜ç¢ºåˆ—å‡ºæ¯å€‹è§’è‰²è¢«æŒ‡æ´¾çš„æ¬Šé™ç¯„åœ (Scope)ï¼Œä½†é‚„æœ‰ä¸€å€‹é‡è¦çš„è³‡æºæ“æœ‰æ¬ŠåŸå‰‡ï¼š

- **User** æ²’æœ‰ `read:todos` æˆ– `delete:todos` æ¬Šé™ç¯„åœï¼Œä½†ä»å¯ï¼š
  - æª¢è¦–è‡ªå·±çš„å¾…è¾¦äº‹é …
  - åˆªé™¤è‡ªå·±çš„å¾…è¾¦äº‹é …
- **Admin** å…·å‚™å®Œæ•´æ¬Šé™ï¼ˆ`read:todos` èˆ‡ `delete:todos`ï¼‰ï¼Œå¯ï¼š
  - æª¢è¦–ç³»çµ±ä¸­æ‰€æœ‰å¾…è¾¦äº‹é …
  - åˆªé™¤ä»»ä½•å¾…è¾¦äº‹é …ï¼Œä¸è«–æ“æœ‰è€…ç‚ºèª°

é€™å±•ç¾äº† RBAC ç³»çµ±ä¸­å¸¸è¦‹çš„æ¨¡å¼ï¼šè³‡æºæ“æœ‰æ¬Šæœƒéš±å«æˆäºˆä½¿ç”¨è€…å°è‡ªå·±è³‡æºçš„æ¬Šé™ï¼Œè€Œç®¡ç†è§’è‰²å‰‡ç²å¾—å°æ‰€æœ‰è³‡æºçš„æ˜ç¢ºæ¬Šé™ã€‚

:::tip æ·±å…¥å­¸ç¿’
æƒ³æ›´æ·±å…¥ç­è§£ RBAC æ¦‚å¿µèˆ‡æœ€ä½³å¯¦è¸ï¼Œè«‹åƒè€ƒ [ç²¾é€š RBACï¼šå®Œæ•´å¯¦æˆ°ç¯„ä¾‹](https://blog.logto.io/mastering-rbac)ã€‚
:::

## åœ¨ä½ çš„ç°½ç™¼è€… (Issuer) ä¸­è¨­å®šæˆæ¬Š (Authorization) \{#configure-authorization-in-your-provider}

è¦å¯¦ä½œä¸Šè¿°å­˜å–æ§åˆ¶ç³»çµ±ï¼Œä½ éœ€è¦åœ¨æˆæ¬Šä¼ºæœå™¨è¨­å®šæ‰€éœ€çš„æ¬Šé™ç¯„åœ (Scope)ã€‚ä»¥ä¸‹æ˜¯ä¸åŒç°½ç™¼è€…çš„è¨­å®šæ–¹å¼ï¼š

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

[Logto](https://logto.io) é€é API è³‡æºèˆ‡è§’è‰²åŠŸèƒ½æä¾› RBAC æ”¯æ´ã€‚è¨­å®šæ–¹å¼å¦‚ä¸‹ï¼š

1. ç™»å…¥ [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ¶ Logto Consoleï¼‰

2. å»ºç«‹ API è³‡æºèˆ‡æ¬Šé™ç¯„åœ (Scope)ï¼š

   - å‰å¾€ã€ŒAPI è³‡æºã€
   - å»ºç«‹ä¸€å€‹åç‚ºã€ŒTodo Managerã€çš„æ–° API è³‡æºï¼Œä¸¦å°‡ `http://localhost:3001` è¨­ç‚ºè³‡æºæ¨™ç¤ºç¬¦ (Resource indicator)ã€‚
     - **é‡è¦**ï¼šè³‡æºæ¨™ç¤ºç¬¦å¿…é ˆèˆ‡ä½ çš„ MCP ä¼ºæœå™¨ URL ç›¸ç¬¦ã€‚æœ¬æ•™å­¸ä½¿ç”¨ `http://localhost:3001`ï¼Œå›  MCP ä¼ºæœå™¨é‹è¡Œæ–¼ 3001 åŸ ã€‚æ­£å¼ç’°å¢ƒè«‹ä½¿ç”¨å¯¦éš› MCP ä¼ºæœå™¨ URLï¼ˆå¦‚ `https://your-mcp-server.example.com`ï¼‰ã€‚
   - å»ºç«‹ä»¥ä¸‹æ¬Šé™ç¯„åœ (Scope)ï¼š
     - `create:todos`ï¼šã€Œå»ºç«‹æ–°çš„å¾…è¾¦äº‹é …ã€
     - `read:todos`ï¼šã€Œè®€å–æ‰€æœ‰å¾…è¾¦äº‹é …ã€
     - `delete:todos`ï¼šã€Œåˆªé™¤ä»»ä¸€å¾…è¾¦äº‹é …ã€

3. å»ºç«‹è§’è‰²ï¼ˆå»ºè­°ä»¥ä¾¿ç®¡ç†ï¼‰ï¼š

   - å‰å¾€ã€Œè§’è‰²ã€
   - å»ºç«‹ã€ŒAdminã€è§’è‰²ä¸¦æŒ‡æ´¾æ‰€æœ‰æ¬Šé™ç¯„åœï¼ˆ`create:todos`ã€`read:todos`ã€`delete:todos`ï¼‰
   - å»ºç«‹ã€ŒUserã€è§’è‰²ä¸¦åƒ…æŒ‡æ´¾ `create:todos` æ¬Šé™ç¯„åœ
   - åœ¨ã€ŒUserã€è§’è‰²è©³ç´°é åˆ‡æ›è‡³ã€Œä¸€èˆ¬ã€åˆ†é ï¼Œå°‡ã€ŒUserã€è¨­ç‚ºã€Œé è¨­è§’è‰²ã€

4. ç®¡ç†ä½¿ç”¨è€…è§’è‰²èˆ‡æ¬Šé™ï¼š
   - æ–°ä½¿ç”¨è€…ï¼š
     - ç”±æ–¼å·²è¨­ç‚ºé è¨­è§’è‰²ï¼Œå°‡è‡ªå‹•ç²å¾—ã€ŒUserã€è§’è‰²
   - ç¾æœ‰ä½¿ç”¨è€…ï¼š
     - å‰å¾€ã€Œä½¿ç”¨è€…ç®¡ç†ã€
     - é¸æ“‡ä¸€ä½ä½¿ç”¨è€…
     - åœ¨ã€Œè§’è‰²ã€åˆ†é æŒ‡æ´¾è§’è‰²

:::tip ç¨‹å¼åŒ–è§’è‰²ç®¡ç†
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Logto çš„ [Management API](https://docs.logto.io/integrate-logto/interact-with-management-api) ä»¥ç¨‹å¼æ–¹å¼ç®¡ç†ä½¿ç”¨è€…è§’è‰²ã€‚é€™å°è‡ªå‹•åŒ–ä½¿ç”¨è€…ç®¡ç†æˆ–å»ºç«‹ç®¡ç†å¾Œå°ç‰¹åˆ¥æœ‰ç”¨ã€‚
:::

è«‹æ±‚å­˜å–æ¬Šæ–æ™‚ï¼ŒLogto æœƒæ ¹æ“šä½¿ç”¨è€…è§’è‰²æ¬Šé™å°‡æ¬Šé™ç¯„åœ (Scope) åŠ å…¥æ¬Šæ–çš„ `scope` å®£å‘Š (Claim)ã€‚

</TabItem>
<TabItem value="oauth-or-oidc" label="OAuth 2 / OIDC">

å°æ–¼ OAuth 2.0 æˆ– OpenID Connect ç°½ç™¼è€… (Issuer)ï¼Œä½ éœ€è¦è¨­å®šä»£è¡¨ä¸åŒæ¬Šé™çš„æ¬Šé™ç¯„åœ (Scope)ã€‚å…·é«”æ­¥é©Ÿä¾ç°½ç™¼è€…è€Œç•°ï¼Œä½†ä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼š

1. å®šç¾©æ¬Šé™ç¯„åœ (Scope)ï¼š

   - è¨­å®šæˆæ¬Šä¼ºæœå™¨æ”¯æ´ï¼š
     - `create:todos`
     - `read:todos`
     - `delete:todos`

2. è¨­å®šç”¨æˆ¶ç«¯ï¼š

   - è¨»å†Šæˆ–æ›´æ–°ç”¨æˆ¶ç«¯ä»¥è«‹æ±‚é€™äº›æ¬Šé™ç¯„åœ
   - ç¢ºä¿æ¬Šé™ç¯„åœæœƒåŒ…å«åœ¨å­˜å–æ¬Šæ–ä¸­

3. æŒ‡æ´¾æ¬Šé™ï¼š
   - ä½¿ç”¨ç°½ç™¼è€…ä»‹é¢å°‡é©ç•¶æ¬Šé™ç¯„åœæŒ‡æ´¾çµ¦ä½¿ç”¨è€…
   - æœ‰äº›ç°½ç™¼è€…æ”¯æ´åŸºæ–¼è§’è‰²çš„ç®¡ç†ï¼Œæœ‰äº›å‰‡ç›´æ¥æŒ‡æ´¾æ¬Šé™ç¯„åœ
   - è«‹æŸ¥é–±ç°½ç™¼è€…æ–‡ä»¶ä»¥ç²å¾—å»ºè­°åšæ³•

:::tip
å¤§å¤šæ•¸ç°½ç™¼è€…æœƒå°‡æˆäºˆçš„æ¬Šé™ç¯„åœåŒ…å«åœ¨å­˜å–æ¬Šæ–çš„ `scope` å®£å‘Š (Claim) ä¸­ã€‚æ ¼å¼é€šå¸¸ç‚ºä»¥ç©ºæ ¼åˆ†éš”çš„æ¬Šé™ç¯„åœå­—ä¸²ã€‚
:::

</TabItem>
</Tabs>

è¨­å®šå¥½æˆæ¬Šä¼ºæœå™¨å¾Œï¼Œä½¿ç”¨è€…å°‡æ”¶åˆ°åŒ…å«å…¶æˆæ¬Šæ¬Šé™ç¯„åœçš„å­˜å–æ¬Šæ–ã€‚MCP ä¼ºæœå™¨æœƒæ ¹æ“šé€™äº›æ¬Šé™ç¯„åœåˆ¤æ–·ï¼š

- ä½¿ç”¨è€…æ˜¯å¦èƒ½å»ºç«‹æ–°çš„å¾…è¾¦äº‹é …ï¼ˆ`create:todos`ï¼‰
- ä½¿ç”¨è€…æ˜¯å¦èƒ½æª¢è¦–æ‰€æœ‰å¾…è¾¦äº‹é …ï¼ˆ`read:todos`ï¼‰æˆ–åƒ…èƒ½æª¢è¦–è‡ªå·±çš„
- ä½¿ç”¨è€…æ˜¯å¦èƒ½åˆªé™¤ä»»ä¸€å¾…è¾¦äº‹é …ï¼ˆ`delete:todos`ï¼‰æˆ–åƒ…èƒ½åˆªé™¤è‡ªå·±çš„

## å»ºç«‹ MCP ä¼ºæœå™¨ \{#set-up-the-mcp-server}

æˆ‘å€‘å°‡ä½¿ç”¨ [MCP å®˜æ–¹ SDK](https://github.com/modelcontextprotocol) ä¾†å»ºç«‹ todo manager MCP ä¼ºæœå™¨ã€‚

### å»ºç«‹æ–°å°ˆæ¡ˆ \{#create-a-new-project}

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

å»ºç«‹æ–°çš„ Python å°ˆæ¡ˆï¼š

```bash
mkdir mcp-todo-server
cd mcp-todo-server

# åˆå§‹åŒ–æ–°çš„ Python å°ˆæ¡ˆ
uv init

# ä½¿ç”¨ uv å»ºç«‹è™›æ“¬ç’°å¢ƒ
uv venv

# å•Ÿç”¨è™›æ“¬ç’°å¢ƒï¼ˆä½¿ç”¨ 'uv run' æ™‚å¯é¸æ“‡æ€§ç•¥éï¼‰
source .venv/bin/activate
```

:::note
æœ¬å°ˆæ¡ˆä½¿ç”¨ `uv` é€²è¡Œå¥—ä»¶ç®¡ç†ï¼Œä½†ä½ ä¹Ÿå¯ä»¥é¸æ“‡ `pip`ã€`poetry` æˆ– `conda` ç­‰å…¶ä»–å¥—ä»¶ç®¡ç†å·¥å…·ã€‚
:::

</TabItem>
<TabItem value="node" label="Node.js">

å»ºç«‹æ–°çš„ Node.js å°ˆæ¡ˆï¼š

```bash
mkdir mcp-server
cd mcp-server
npm init -y # æˆ–ä½¿ç”¨ `pnpm init`
npm pkg set type="module"
npm pkg set main="todo-manager.ts"
npm pkg set scripts.start="node --experimental-strip-types todo-manager.ts"
```

:::note
æˆ‘å€‘çš„ç¯„ä¾‹ä½¿ç”¨ TypeScriptï¼Œå› ç‚º Node.js v22.6.0+ åŸç”Ÿæ”¯æ´ `--experimental-strip-types` åŸ·è¡Œ TypeScriptã€‚è‹¥ä½ ä½¿ç”¨ JavaScriptï¼Œç¨‹å¼ç¢¼å¤§è‡´ç›¸åŒï¼Œåªéœ€ç¢ºä¿ Node.js ç‰ˆæœ¬ç‚º v22.6.0 æˆ–ä»¥ä¸Šã€‚è©³æƒ…è«‹åƒé–± Node.js å®˜æ–¹æ–‡ä»¶ã€‚
:::

</TabItem>
</Tabs>

### å®‰è£ MCP SDK èˆ‡ç›¸ä¾å¥—ä»¶ \{#install-the-mcp-sdk-and-dependencies}

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

å®‰è£æ‰€éœ€ç›¸ä¾å¥—ä»¶ï¼š

```bash
uv add "mcp[cli]" uvicorn starlette
```

</TabItem>
<TabItem value="node" label="Node.js">

```bash
npm install @modelcontextprotocol/sdk express zod
```

æˆ–ä½ åå¥½çš„å…¶ä»–å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œå¦‚ `pnpm` æˆ– `yarn`ã€‚

</TabItem>
</Tabs>

### å»ºç«‹ MCP ä¼ºæœå™¨ \{#create-the-mcp-server}

é¦–å…ˆï¼Œè®“æˆ‘å€‘å»ºç«‹ä¸€å€‹åŒ…å«å·¥å…·å®šç¾©çš„åŸºæœ¬ MCP ä¼ºæœå™¨ï¼š

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

å»ºç«‹åç‚º `server.py` çš„æª”æ¡ˆä¸¦åŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š

```python
# server.py

import contextlib
from typing import Any
from mcp.server.fastmcp import FastMCP
from starlette.applications import Starlette
from starlette.routing import Mount

# åˆå§‹åŒ– FastMCP ä¼ºæœå™¨
mcp = FastMCP(name="Todo Manager", stateless_http=True, streamable_http_path='/')

@mcp.tool()
def create_todo(content: str) -> dict[str, Any]:
    """å»ºç«‹æ–°çš„å¾…è¾¦äº‹é …ã€‚éœ€ 'create:todos' æ¬Šé™ç¯„åœã€‚"""
    return {"error": "Not implemented"}

@mcp.tool()
def get_todos() -> dict[str, Any]:
    """åˆ—å‡ºå¾…è¾¦äº‹é …ã€‚å…·å‚™ 'read:todos' æ¬Šé™ç¯„åœçš„ä½¿ç”¨è€…å¯æª¢è¦–æ‰€æœ‰å¾…è¾¦äº‹é …ã€‚"""
    return {"error": "Not implemented"}

@mcp.tool()
def delete_todo(id: str) -> dict[str, Any]:
    """æ ¹æ“š id åˆªé™¤å¾…è¾¦äº‹é …ã€‚ä½¿ç”¨è€…å¯åˆªé™¤è‡ªå·±çš„å¾…è¾¦äº‹é …ã€‚"""
    return {"error": "Not implemented"}

@contextlib.asynccontextmanager
async def lifespan(app: Starlette):
    async with contextlib.AsyncExitStack() as stack:
        await stack.enter_async_context(mcp.session_manager.run())
        yield

# å»ºç«‹ app
app = Starlette(
    routes=[
        Mount("/", app=mcp.streamable_http_app()),
    ],
    lifespan=lifespan,
)
```

ä»¥ä»¥ä¸‹æŒ‡ä»¤å•Ÿå‹•ä¼ºæœå™¨ï¼š

```bash
# ä½¿ç”¨ uvicorn å•Ÿå‹• Todo Manager ä¼ºæœå™¨
uvicorn server:app --host 127.0.0.1 --port 3001

# æˆ–ä½¿ç”¨ uv:
# uv run uvicorn server:app --host 127.0.0.1 --port 3001
```

</TabItem>
<TabItem value="node" label="Node.js">

å»ºç«‹åç‚º `todo-manager.ts` çš„æª”æ¡ˆä¸¦åŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š

```ts
// todo-manager.ts

import { z } from 'zod';
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StreamableHTTPServerTransport } from '@modelcontextprotocol/sdk/server/streamableHttp.js';
import express, { type Request, type Response } from 'express';

// å»ºç«‹ MCP ä¼ºæœå™¨
const server = new McpServer({
  name: 'Todo Manager',
  version: '0.0.0',
});

server.tool('create-todo', 'Create a new todo', { content: z.string() }, async ({ content }) => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

server.tool('get-todos', 'List all todos', async () => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

server.tool('delete-todo', 'Delete a todo by id', { id: z.string() }, async ({ id }) => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

// ä»¥ä¸‹ç‚º MCP SDK æ–‡ä»¶ç¯„ä¾‹æ¨£æ¿
const PORT = 3001;
const app = express();

app.post('/', async (request: Request, response: Response) => {
  // åœ¨ stateless æ¨¡å¼ä¸‹ï¼Œæ¯å€‹è«‹æ±‚éƒ½å»ºç«‹æ–°çš„ transport èˆ‡ server å¯¦ä¾‹ä»¥ç¢ºä¿å®Œå…¨éš”é›¢ã€‚
  // å–®ä¸€å¯¦ä¾‹æœƒå°è‡´å¤šç”¨æˆ¶ç«¯åŒæ™‚é€£ç·šæ™‚è«‹æ±‚ ID è¡çªã€‚

  try {
    const transport: StreamableHTTPServerTransport = new StreamableHTTPServerTransport({
      sessionIdGenerator: undefined,
    });
    response.on('close', async () => {
      console.log('Request closed');
      await transport.close();
      await server.close();
    });
    await server.connect(transport);
    await transport.handleRequest(request, response, request.body);
  } catch (error) {
    console.error('Error handling MCP request:', error);
    if (!response.headersSent) {
      response.status(500).json({
        jsonrpc: '2.0',
        error: {
          code: -32_603,
          message: 'Internal server error',
        },
        id: null,
      });
    }
  }
});

// stateless æ¨¡å¼ä¸‹ä¸æ”¯æ´ SSE é€šçŸ¥
app.get('/', async (request: Request, response: Response) => {
  console.log('Received GET MCP request');
  response.writeHead(405).end(
    JSON.stringify({
      jsonrpc: '2.0',
      error: {
        code: -32_000,
        message: 'Method not allowed.',
      },
      id: null,
    })
  );
});

// stateless æ¨¡å¼ä¸‹ä¸éœ€çµ‚æ­¢ session
app.delete('/', async (request: Request, response: Response) => {
  console.log('Received DELETE MCP request');
  response.writeHead(405).end(
    JSON.stringify({
      jsonrpc: '2.0',
      error: {
        code: -32_000,
        message: 'Method not allowed.',
      },
      id: null,
    })
  );
});

app.listen(PORT);
```

ä»¥ä»¥ä¸‹æŒ‡ä»¤å•Ÿå‹•ä¼ºæœå™¨ï¼š

```bash
npm start
```

</TabItem>
</Tabs>

## æª¢æŸ¥ MCP ä¼ºæœå™¨ \{#inspect-the-mcp-server}

### ä¸‹è¼‰ä¸¦åŸ·è¡Œ MCP inspector \{#clone-and-run-mcp-inspector}

ç¾åœ¨ MCP ä¼ºæœå™¨å·²å•Ÿå‹•ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ MCP inspector ä¾†æª¢æŸ¥å·¥å…·æ˜¯å¦å¯ç”¨ã€‚

å®˜æ–¹ MCP inspector v0.16.2 æœ‰äº› bug æœƒå½±éŸ¿é©—è­‰ (Authentication) åŠŸèƒ½ã€‚ç‚ºäº†è§£æ±ºé€™äº›å•é¡Œï¼Œæˆ‘å€‘å»ºç«‹äº† [ä¿®æ­£ç‰ˆ MCP inspector](https://github.com/mcp-auth/inspector/tree/patch/0.16.2-fixes)ï¼Œå·²åŒ…å« OAuth / OIDC é©—è­‰æµç¨‹æ‰€éœ€ä¿®æ­£ã€‚æˆ‘å€‘ä¹Ÿå·²å‘å®˜æ–¹å€‰åº«æäº¤ PRã€‚

åŸ·è¡Œ MCP inspectorï¼š

```bash
git clone https://github.com/mcp-auth/inspector.git -b patch/0.16.2-fixes
cd inspector
npm install
npm run dev
```

MCP inspector æœƒè‡ªå‹•åœ¨é è¨­ç€è¦½å™¨é–‹å•Ÿï¼Œæˆ–ä½ ä¹Ÿå¯ä»¥æ‰‹å‹•é»æ“Šçµ‚ç«¯æ©Ÿè¼¸å‡ºçš„é€£çµï¼ˆè«‹å‹™å¿…é»æ“ŠåŒ…å« `MCP_PROXY_AUTH_TOKEN` åƒæ•¸çš„é€£çµï¼Œå¦‚ `http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=458ae4a4...acab1907`ï¼‰ã€‚

### é€£æ¥ MCP inspector è‡³ MCP ä¼ºæœå™¨ \{#connect-mcp-inspector-to-the-mcp-server}

ç¹¼çºŒå‰è«‹æª¢æŸ¥ MCP inspector çš„ä»¥ä¸‹è¨­å®šï¼š

- **Transport Type**ï¼šè¨­ç‚º `Streamable HTTP`
- **URL**ï¼šè¨­ç‚º MCP ä¼ºæœå™¨çš„ URLï¼Œæœ¬ä¾‹ç‚º `http://localhost:3001`

ç¾åœ¨ä½ å¯ä»¥é»æ“Šã€ŒConnectã€æŒ‰éˆ•ï¼Œæª¢æŸ¥ MCP inspector æ˜¯å¦èƒ½é€£ç·šè‡³ MCP ä¼ºæœå™¨ã€‚è‹¥ä¸€åˆ‡æ­£å¸¸ï¼ŒMCP inspector æœƒé¡¯ç¤ºã€ŒConnectedã€ç‹€æ…‹ã€‚

### æª¢æŸ¥é»ï¼šåŸ·è¡Œ todo manager å·¥å…· \{#checkpoint-run-todo-manager-tools}

1. åœ¨ MCP inspector ä¸Šæ–¹é¸å–®é»é¸ã€ŒToolsã€åˆ†é 
2. é»æ“Šã€ŒList Toolsã€æŒ‰éˆ•
3. ä½ æ‡‰è©²æœƒçœ‹åˆ° `create-todo`ã€`get-todos`ã€`delete-todo` å·¥å…·åˆ—åœ¨é é¢ä¸Šï¼Œé»æ“Šå¯æª¢è¦–å·¥å…·ç´°ç¯€
4. å³å´æœƒå‡ºç¾ã€ŒRun Toolã€æŒ‰éˆ•ï¼Œé»æ“Šä¸¦è¼¸å…¥å¿…è¦åƒæ•¸åŸ·è¡Œå·¥å…·
5. ä½ æœƒçœ‹åˆ°å·¥å…·å›å‚³çš„ JSON çµæœ `{"error": "Not implemented"}`

![MCP inspector é¦–æ¬¡åŸ·è¡Œç•«é¢](/docs-assets/images/tutorials/todo-manager/inspector-first-run.png)

## èˆ‡æˆæ¬Šä¼ºæœå™¨æ•´åˆ \{#integrate-with-your-authorization-server}

å®Œæˆæœ¬ç¯€éœ€è€ƒæ…®ä»¥ä¸‹å¹¾é»ï¼š

<details>
<summary>**ä½ çš„æˆæ¬Šä¼ºæœå™¨ç°½ç™¼è€… (Issuer) URL**</summary>

é€šå¸¸æ˜¯ä½ çš„æˆæ¬Šä¼ºæœå™¨åŸºç¤ URLï¼Œå¦‚ `https://auth.example.com`ã€‚æœ‰äº›ç°½ç™¼è€…å¯èƒ½ç‚º `https://example.logto.app/oidc`ï¼Œè«‹åƒè€ƒä½ çš„ç°½ç™¼è€…æ–‡ä»¶ã€‚

</details>

<details>
<summary>**å¦‚ä½•å–å¾—æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™**</summary>

- è‹¥ä½ çš„æˆæ¬Šä¼ºæœå™¨ç¬¦åˆ [OAuth 2.0 æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™](https://datatracker.ietf.org/doc/html/rfc8414) æˆ– [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html)ï¼Œå¯ç”¨ MCP Auth å…§å»ºå·¥å…·è‡ªå‹•å–å¾—ä¸­ç¹¼è³‡æ–™
- è‹¥ä¸ç¬¦åˆï¼Œéœ€æ‰‹å‹•åœ¨ MCP ä¼ºæœå™¨è¨­å®šä¸­æŒ‡å®šä¸­ç¹¼è³‡æ–™ URL æˆ–ç«¯é»ï¼Œè«‹æŸ¥é–±ç°½ç™¼è€…æ–‡ä»¶

</details>

<details>
<summary>**å¦‚ä½•å°‡ MCP inspector è¨»å†Šç‚ºæˆæ¬Šä¼ºæœå™¨ç”¨æˆ¶ç«¯**</summary>

- è‹¥æˆæ¬Šä¼ºæœå™¨æ”¯æ´ [å‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Š (Dynamic Client Registration)](https://datatracker.ietf.org/doc/html/rfc7591)ï¼ŒMCP inspector æœƒè‡ªå‹•è¨»å†Š
- è‹¥ä¸æ”¯æ´ï¼Œéœ€æ‰‹å‹•å°‡ MCP inspector è¨»å†Šç‚ºç”¨æˆ¶ç«¯

</details>

<details>
<summary>**ç­è§£æ¬Šæ–è«‹æ±‚åƒæ•¸**</summary>

å‘ä¸åŒæˆæ¬Šä¼ºæœå™¨è«‹æ±‚å­˜å–æ¬Šæ–æ™‚ï¼ŒæŒ‡å®šç›®æ¨™è³‡æºèˆ‡æ¬Šé™çš„æ–¹å¼å¯èƒ½ä¸åŒï¼Œä¸»è¦æœ‰ï¼š

- **è³‡æºæ¨™ç¤ºç¬¦ (Resource indicator) æ¨¡å¼**ï¼š

  - ä½¿ç”¨ `resource` åƒæ•¸æŒ‡å®šç›®æ¨™ APIï¼ˆåƒè¦‹ [RFC 8707: OAuth 2.0 è³‡æºæ¨™ç¤ºç¬¦]ï¼‰
  - ç¾ä»£ OAuth 2.0 å¸¸è¦‹
  - ç¯„ä¾‹è«‹æ±‚ï¼š
    ```json
    {
      "resource": "http://localhost:3001",
      "scope": "create:todos read:todos"
    }
    ```
  - ä¼ºæœå™¨æœƒç™¼å‡ºå°ˆå±¬æ–¼è©²è³‡æºçš„æ¬Šæ–

- **å—çœ¾ (Audience) æ¨¡å¼**ï¼š

  - ä½¿ç”¨ `audience` åƒæ•¸æŒ‡å®šæ¬Šæ–ç›®æ¨™
  - èˆ‡è³‡æºæ¨™ç¤ºç¬¦é¡ä¼¼ä½†èªæ„ä¸åŒ
  - ç¯„ä¾‹è«‹æ±‚ï¼š
    ```json
    {
      "audience": "todo-api",
      "scope": "create:todos read:todos"
    }
    ```

- **ç´”æ¬Šé™ç¯„åœ (Scope) æ¨¡å¼**ï¼š
  - åƒ…ä¾æ¬Šé™ç¯„åœï¼Œä¸å¸¶ resource / audience åƒæ•¸
  - å‚³çµ± OAuth 2.0 ä½œæ³•
  - ç¯„ä¾‹è«‹æ±‚ï¼š
    ```json
    {
      "scope": "todo-api:create todo-api:read openid profile"
    }
    ```
  - å¸¸ä»¥å‰ç¶´å‘½åç©ºé–“æ¬Šé™ç¯„åœ
  - ç°¡å–® OAuth 2.0 å¯¦ä½œå¸¸è¦‹

:::tip æœ€ä½³å¯¦è¸

- æŸ¥é–±ç°½ç™¼è€…æ–‡ä»¶ä»¥ç¢ºèªæ”¯æ´å“ªäº›åƒæ•¸
- æœ‰äº›ç°½ç™¼è€…åŒæ™‚æ”¯æ´å¤šç¨®æ–¹å¼
- è³‡æºæ¨™ç¤ºç¬¦å¯æå‡å®‰å…¨æ€§ï¼ˆé™åˆ¶å—çœ¾ï¼‰
- å»ºè­°æœ‰æ”¯æ´æ™‚å„ªå…ˆä½¿ç”¨è³‡æºæ¨™ç¤ºç¬¦ä»¥å¼·åŒ–å­˜å–æ§åˆ¶
  :::

</details>

æ¯å€‹ç°½ç™¼è€…å¯èƒ½æœ‰ä¸åŒéœ€æ±‚ï¼Œä»¥ä¸‹æ­¥é©Ÿå°‡å¼•å°ä½ æ•´åˆ MCP inspector èˆ‡ MCP ä¼ºæœå™¨ä¸¦é€²è¡Œå°ˆå±¬è¨­å®šã€‚

### è¨»å†Š MCP inspector ç‚ºç”¨æˆ¶ç«¯ \{#register-mcp-inspector-as-a-client}

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

å°‡ todo manager èˆ‡ [Logto](https://logto.io) æ•´åˆéå¸¸ç°¡å–®ï¼Œå› å…¶ç‚ºæ”¯æ´è³‡æºæ¨™ç¤ºç¬¦èˆ‡æ¬Šé™ç¯„åœçš„ OpenID Connect ç°½ç™¼è€…ï¼Œå¯ç”¨ `http://localhost:3001` ä½œç‚ºè³‡æºæ¨™ç¤ºç¬¦ä¿è­· todo APIã€‚

ç”±æ–¼ Logto å°šæœªæ”¯æ´å‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Šï¼Œä½ éœ€æ‰‹å‹•å°‡ MCP inspector è¨»å†Šç‚º Logto ç§Ÿæˆ¶çš„ç”¨æˆ¶ç«¯ï¼š

1. é–‹å•Ÿ MCP inspectorï¼Œé€²å…¥é©—è­‰ (Authentication) è¨­å®šä¸¦é»æ“Šã€ŒOAuth2.0 Flowã€è¨­å®šã€‚è¤‡è£½ **Redirect URI**ï¼Œå¦‚ `http://localhost:6274/oauth/callback`
2. ç™»å…¥ [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ¶ Logto Consoleï¼‰
3. å‰å¾€ã€Œæ‡‰ç”¨ç¨‹å¼ã€åˆ†é ï¼Œé»æ“Šã€Œå»ºç«‹æ‡‰ç”¨ç¨‹å¼ã€ã€‚é é¢åº•éƒ¨é»é¸ã€Œä¸ä½¿ç”¨æ¡†æ¶å»ºç«‹æ‡‰ç”¨ç¨‹å¼ã€
4. å¡«å¯«æ‡‰ç”¨ç¨‹å¼è³‡è¨Šå¾Œé»æ“Šã€Œå»ºç«‹æ‡‰ç”¨ç¨‹å¼ã€ï¼š
   - **é¸æ“‡æ‡‰ç”¨ç¨‹å¼é¡å‹**ï¼šé¸ã€Œå–®é æ‡‰ç”¨ç¨‹å¼ã€
   - **æ‡‰ç”¨ç¨‹å¼åç¨±**ï¼šå¦‚ã€ŒMCP Inspectorã€
5. åœ¨ã€Œè¨­å®š / Redirect URIsã€å€å¡Šè²¼ä¸Šå‰›æ‰è¤‡è£½çš„ **Redirect URI**ï¼Œç„¶å¾Œé»æ“Šåº•éƒ¨ã€Œå„²å­˜è®Šæ›´ã€
6. é é¢ä¸Šæ–¹å¡ç‰‡æœƒé¡¯ç¤ºã€ŒApp IDã€ï¼Œè«‹è¤‡è£½
7. å›åˆ° MCP inspectorï¼Œå°‡ã€ŒApp IDã€è²¼åˆ°é©—è­‰ (Authentication) è¨­å®šçš„ã€ŒOAuth2.0 Flowã€ä¸‹çš„ã€ŒClient IDã€æ¬„ä½
8. åœ¨ã€ŒScopeã€æ¬„ä½è¼¸å…¥ï¼š`create:todos read:todos delete:todos`ï¼Œç¢ºä¿ Logto å›å‚³çš„å­˜å–æ¬Šæ–åŒ…å« todo manager æ‰€éœ€æ¬Šé™ç¯„åœ

</TabItem>
<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

:::note
é€™æ˜¯é€šç”¨ OAuth 2.0 / OpenID Connect ç°½ç™¼è€…æ•´åˆæŒ‡å¼•ã€‚å…©è€…æ­¥é©Ÿé¡ä¼¼ï¼Œå›  OIDC å»ºç«‹æ–¼ OAuth 2.0 ä¹‹ä¸Šã€‚è«‹æŸ¥é–±ä½ çš„ç°½ç™¼è€…æ–‡ä»¶ä»¥ç²å¾—ç´°ç¯€ã€‚
:::

è‹¥ä½ çš„ç°½ç™¼è€…æ”¯æ´å‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Šï¼Œå¯ç›´æ¥è·³è‡³ç¬¬ 8 æ­¥è¨­å®š MCP inspectorï¼›å¦å‰‡éœ€æ‰‹å‹•è¨»å†Šï¼š

1. é–‹å•Ÿ MCP inspectorï¼Œé€²å…¥é©—è­‰ (Authentication) è¨­å®šä¸¦é»æ“Šã€ŒOAuth2.0 Flowã€è¨­å®šã€‚è¤‡è£½ **Redirect URI**ï¼Œå¦‚ `http://localhost:6274/oauth/callback`

2. ç™»å…¥ä½ çš„ç°½ç™¼è€…ç®¡ç†å¾Œå°

3. å‰å¾€ã€Œæ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€Œç”¨æˆ¶ç«¯ã€å€å¡Šï¼Œå»ºç«‹æ–°æ‡‰ç”¨ç¨‹å¼æˆ–ç”¨æˆ¶ç«¯

4. è‹¥éœ€é¸æ“‡ç”¨æˆ¶ç«¯é¡å‹ï¼Œè«‹é¸ã€Œå–®é æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€Œå…¬é–‹ç”¨æˆ¶ç«¯ã€

5. å»ºç«‹æ‡‰ç”¨ç¨‹å¼å¾Œï¼Œéœ€è¨­å®š redirect URIï¼Œè²¼ä¸Šå‰›æ‰è¤‡è£½çš„ **Redirect URI**

6. æ‰¾åˆ°æ–°æ‡‰ç”¨ç¨‹å¼çš„ã€ŒClient IDã€æˆ–ã€ŒApplication IDã€ä¸¦è¤‡è£½

7. å›åˆ° MCP inspectorï¼Œå°‡ã€ŒClient IDã€è²¼åˆ°é©—è­‰ (Authentication) è¨­å®šçš„ã€ŒOAuth2.0 Flowã€ä¸‹çš„ã€ŒClient IDã€æ¬„ä½

8. åœ¨ã€ŒScopeã€æ¬„ä½è¼¸å…¥ä»¥ä¸‹æ¬Šé™ç¯„åœä»¥è«‹æ±‚ todo æ“ä½œæ‰€éœ€æ¬Šé™ï¼š

```text
create:todos read:todos delete:todos
```

</TabItem>
</Tabs>

### è¨­å®š MCP Auth \{#set-up-mcp-auth}

é¦–å…ˆï¼Œåœ¨ MCP ä¼ºæœå™¨å°ˆæ¡ˆä¸­å®‰è£ MCP Auth SDKã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```bash
uv add mcpauth==0.2.0b1
```

</TabItem>
<TabItem value="node" label="Node.js">

```bash
npm install mcp-auth@0.2.0-beta.1
```

</TabItem>
</Tabs>

æ¥ä¸‹ä¾†éœ€åœ¨ MCP ä¼ºæœå™¨åˆå§‹åŒ– MCP Authï¼Œä¸»è¦åˆ†å…©æ­¥ï¼š

1. **å–å¾—æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™**ï¼šä¾› MCP Auth é©—è­‰æˆæ¬Šä¼ºæœå™¨ç™¼å‡ºçš„å­˜å–æ¬Šæ–ï¼Œä¸¦å°‡ç°½ç™¼è€… (Issuer) è­˜åˆ¥è³‡è¨Šç´å…¥è³‡æºä¸­ç¹¼è³‡æ–™
2. **è¨­å®šå—ä¿è­·è³‡æºä¸­ç¹¼è³‡æ–™**ï¼šå®šç¾© MCP ä¼ºæœå™¨çš„è³‡æºæ¨™ç¤ºç¬¦èˆ‡æ”¯æ´çš„æ¬Šé™ç¯„åœ

#### æ­¥é©Ÿ 1ï¼šå–å¾—æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™ \{#step-1-fetch-authorization-server-metadata\}

æ ¹æ“š OAuth / OIDC è¦ç¯„ï¼Œå¯æ ¹æ“šæˆæ¬Šä¼ºæœå™¨ç°½ç™¼è€… (Issuer) URL å–å¾—ä¸­ç¹¼è³‡æ–™ã€‚

<Tabs groupId="provider">

<TabItem value="logto" label="Logto">

åœ¨ Logtoï¼Œä½ å¯æ–¼ Logto Console çš„æ‡‰ç”¨ç¨‹å¼è©³ç´°é ã€ŒEndpoints & Credentials / Issuer endpointã€å€å¡Šæ‰¾åˆ°ç°½ç™¼è€… (Issuer) URLï¼Œæ ¼å¼å¦‚ `https://my-project.logto.app/oidc`ã€‚

</TabItem>

<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

å°æ–¼ OAuth 2.0 ç°½ç™¼è€…ï¼Œè«‹ï¼š

1. æŸ¥é–±ç°½ç™¼è€…æ–‡ä»¶å–å¾—æˆæ¬Šä¼ºæœå™¨ URLï¼ˆå¸¸ç¨± issuer URL æˆ– base URLï¼‰
2. æœ‰äº›ç°½ç™¼è€…æœƒåœ¨ `https://{your-domain}/.well-known/oauth-authorization-server` æä¾›
3. æ–¼ç®¡ç†å¾Œå° OAuth / API è¨­å®šä¸­æŸ¥æ‰¾

</TabItem>

</Tabs>

ç¾åœ¨ï¼Œä½¿ç”¨ MCP Auth å·¥å…·å‡½å¼å–å¾—æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™ï¼š

<Tabs groupId="sdk">

<TabItem value="python" label="Python">
```python
from mcpauth import MCPAuth
from mcpauth.config import AuthServerType
from mcpauth.utils import fetch_server_config

issuer_url = "<issuer-url>"  # è«‹æ›¿æ›ç‚ºä½ çš„æˆæ¬Šä¼ºæœå™¨ç°½ç™¼è€… (Issuer) URL

# å–å¾—æˆæ¬Šä¼ºæœå™¨è¨­å®š
auth_server_config = fetch_server_config(issuer_url, AuthServerType.OIDC) # æˆ– AuthServerType.OAUTH
```

</TabItem>
<TabItem value="node" label="Node.js">
```js
import { MCPAuth, fetchServerConfig } from 'mcp-auth';

const issuerUrl = '<issuer-url>'; // è«‹æ›¿æ›ç‚ºä½ çš„æˆæ¬Šä¼ºæœå™¨ç°½ç™¼è€… (Issuer) URL

// å–å¾—æˆæ¬Šä¼ºæœå™¨è¨­å®šï¼ˆOIDC Discoveryï¼‰
const authServerConfig = await fetchServerConfig(issuerUrl, { type: 'oidc' }); // æˆ– { type: 'oauth' }
```

</TabItem>
</Tabs>

è‹¥éœ€å…¶ä»–æ–¹å¼å–å¾—æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™æˆ–è‡ªè¨‚è¨­å®šï¼Œè«‹åƒè€ƒ [å…¶ä»–è¨­å®šæ–¹å¼](/docs/configure-server/mcp-auth#other-ways)ã€‚

#### æ­¥é©Ÿ 2ï¼šè¨­å®šå—ä¿è­·è³‡æºä¸­ç¹¼è³‡æ–™ \{#step-2-configure-protected-resource-metadata}

æ¥è‘—ï¼Œåœ¨å»ºç«‹ MCP Auth å¯¦ä¾‹æ™‚è¨­å®šå—ä¿è­·è³‡æºä¸­ç¹¼è³‡æ–™ã€‚MCP ä¼ºæœå™¨å°‡é€é MCP Auth å°å¤–å…¬é–‹é€™äº›è³‡æºä¸­ç¹¼è³‡æ–™ã€‚

<Tabs groupId="sdk">

<TabItem value="python" label="Python">
```python
# server.py

# å…¶ä»– import...
from mcpauth.types import ResourceServerConfig, ResourceServerMetadata

# å®šç¾©æœ¬ MCP ä¼ºæœå™¨çš„è³‡æºæ¨™ç¤ºç¬¦
resource_id = "http://localhost:3001"

mcp_auth = MCPAuth(
    protected_resources=ResourceServerConfig(
        metadata=ResourceServerMetadata(
            resource=resource_id,
            # ä¸Šä¸€æ­¥å–å¾—çš„æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™
            authorization_servers=[auth_server_config],
            # æœ¬ MCP ä¼ºæœå™¨æ”¯æ´çš„æ¬Šé™ç¯„åœ
            scopes_supported=[
                "create:todos",
                "read:todos",
                "delete:todos"
            ]
        )
    )
)
```
</TabItem>

<TabItem value="node" label="Node.js">
```js
// todo-manager.ts

// å®šç¾©æœ¬ MCP ä¼ºæœå™¨çš„è³‡æºæ¨™ç¤ºç¬¦
const resourceId = 'http://localhost:3001';

// è¨­å®š MCP Auth å—ä¿è­·è³‡æºä¸­ç¹¼è³‡æ–™
const mcpAuth = new MCPAuth({
  protectedResources: {
    metadata: {
      resource: resourceId,
      // ä¸Šä¸€æ­¥å–å¾—çš„æˆæ¬Šä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™
      authorizationServers: [authServerConfig],
      // æœ¬ MCP ä¼ºæœå™¨æ”¯æ´çš„æ¬Šé™ç¯„åœ
      scopesSupported: [
        "create:todos",
        "read:todos",
        "delete:todos"
      ]
    }
  }
});
```
</TabItem>

</Tabs>

### æ›´æ–° MCP ä¼ºæœå™¨ \{#update-mcp-server}

å¿«å®Œæˆäº†ï¼ç¾åœ¨è¦æ›´æ–° MCP ä¼ºæœå™¨ï¼Œå¥—ç”¨ MCP Auth è·¯ç”±èˆ‡ä¸­ä»‹è»Ÿé«” (middleware)ï¼Œä¸¦æ ¹æ“šä½¿ç”¨è€…æ¬Šé™ç¯„åœå¯¦ä½œ todo manager å·¥å…·çš„æ¬Šé™æ§ç®¡ã€‚

é¦–å…ˆï¼Œå¥—ç”¨å—ä¿è­·è³‡æºä¸­ç¹¼è³‡æ–™è·¯ç”±ï¼Œè®“ MCP ç”¨æˆ¶ç«¯å¯å¾ MCP ä¼ºæœå™¨å–å¾—è³‡æºä¸­ç¹¼è³‡æ–™ã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">
```python
# server.py

# ..å…¶ä»–ç¨‹å¼ç¢¼

app = Starlette(
    routes=[
        # è¨­å®šå—ä¿è­·è³‡æºä¸­ç¹¼è³‡æ–™è·¯ç”±
        # è®“ OAuth ç”¨æˆ¶ç«¯å¯å–å¾—æœ¬è³‡æºä¼ºæœå™¨çš„ä¸­ç¹¼è³‡æ–™
        *mcp_auth.resource_metadata_router().routes,
        Mount("/", app=mcp.streamable_http_app()),
    ],
    lifespan=lifespan,
)
```
</TabItem>
<TabItem value="node" label="Node.js">

```ts
// todo-manager.ts

// è¨­å®šå—ä¿è­·è³‡æºä¸­ç¹¼è³‡æ–™è·¯ç”±
// è®“ OAuth ç”¨æˆ¶ç«¯å¯å–å¾—æœ¬è³‡æºä¼ºæœå™¨çš„ä¸­ç¹¼è³‡æ–™
app.use(mcpAuth.protectedResourceMetadataRouter());

```
</TabItem>
</Tabs>

æ¥è‘—ï¼Œå¥—ç”¨ MCP Auth ä¸­ä»‹è»Ÿé«”è‡³ MCP ä¼ºæœå™¨ã€‚æ­¤ä¸­ä»‹è»Ÿé«”å°‡è™•ç†æ‰€æœ‰é€²ä¾†è«‹æ±‚çš„é©—è­‰ (Authentication) èˆ‡æˆæ¬Š (Authorization)ï¼Œç¢ºä¿åªæœ‰æˆæ¬Šä½¿ç”¨è€…èƒ½å­˜å– todo manager å·¥å…·ã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">
```python
# server.py

# å…¶ä»– import...
from starlette.middleware import Middleware

# å…¶ä»–ç¨‹å¼ç¢¼...

# å»ºç«‹ä¸­ä»‹è»Ÿé«”
bearer_auth = Middleware(mcp_auth.bearer_auth_middleware('jwt', resource=resource_id, audience=resource_id))

app = Starlette(
    routes=[
        *mcp_auth.resource_metadata_router().routes,
        # å¥—ç”¨ MCP Auth ä¸­ä»‹è»Ÿé«”
        Mount("/", app=mcp.streamable_http_app(), middleware=[bearer_auth]),
    ],
    lifespan=lifespan,
)
```
</TabItem>
<TabItem value="node" label="Node.js">

```ts
// todo-manager.ts

app.use(mcpAuth.protectedResourceMetadataRouter());

// å¥—ç”¨ MCP Auth ä¸­ä»‹è»Ÿé«”
app.use(
  mcpAuth.bearerAuth('jwt', {
    resource: resourceId,
    audience: resourceId,
  })
);
```
</TabItem>
</Tabs>

ç¾åœ¨å¯ä»¥æ›´æ–° todo manager å·¥å…·ï¼Œè®“å…¶é€é MCP Auth ä¸­ä»‹è»Ÿé«”é€²è¡Œé©—è­‰ (Authentication) èˆ‡æˆæ¬Š (Authorization)ã€‚

è®“æˆ‘å€‘ä¾†æ›´æ–°å·¥å…·å¯¦ä½œã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">
```python
# server.py

# å…¶ä»– import...

from typing import Any, List, Optional
from mcpauth.exceptions import MCPAuthBearerAuthException, BearerAuthExceptionCode
from mcpauth.types import AuthInfo, ResourceServerConfig, ResourceServerMetadata

# ä¸‹ä¸€ç¯€æœƒæåˆ°
from service import TodoService

def assert_user_id(auth_info: Optional[AuthInfo]) -> str:
    """ç¢ºèª auth_info åŒ…å«æœ‰æ•ˆ user ID ä¸¦å›å‚³ã€‚"""
    if not auth_info or not auth_info.subject:
        raise Exception("Invalid auth info")
    return auth_info.subject

def has_required_scopes(user_scopes: List[str], required_scopes: List[str]) -> bool:
    """æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·å‚™æ‰€æœ‰å¿…è¦æ¬Šé™ç¯„åœã€‚"""
    return all(scope in user_scopes for scope in required_scopes)

# å»ºç«‹ TodoService å¯¦ä¾‹
todo_service = TodoService()

@mcp.tool()
def create_todo(content: str) -> dict[str, Any]:
    """å»ºç«‹æ–°çš„å¾…è¾¦äº‹é …ã€‚éœ€ 'create:todos' æ¬Šé™ç¯„åœã€‚"""
    auth_info = mcp_auth.auth_info
    user_id = assert_user_id(auth_info)
    
    # åªæœ‰å…·å‚™ 'create:todos' æ¬Šé™ç¯„åœçš„ä½¿ç”¨è€…å¯å»ºç«‹
    user_scopes = auth_info.scopes if auth_info else []
    if not has_required_scopes(user_scopes, ["create:todos"]):
        raise MCPAuthBearerAuthException(BearerAuthExceptionCode.MISSING_REQUIRED_SCOPES)
    
    created_todo = todo_service.create_todo(content=content, owner_id=user_id)
    return created_todo

@mcp.tool()
def get_todos() -> dict[str, Any]:
    """
    åˆ—å‡ºå¾…è¾¦äº‹é …ã€‚å…·å‚™ 'read:todos' æ¬Šé™ç¯„åœçš„ä½¿ç”¨è€…å¯æª¢è¦–æ‰€æœ‰å¾…è¾¦äº‹é …ï¼Œ
    å¦å‰‡åƒ…èƒ½æª¢è¦–è‡ªå·±çš„ã€‚
    """
    auth_info = mcp_auth.auth_info
    user_id = assert_user_id(auth_info)
    
    # æœ‰ 'read:todos' æ¬Šé™ç¯„åœå¯å­˜å–æ‰€æœ‰ï¼Œå¦å‰‡åƒ…èƒ½å­˜å–è‡ªå·±çš„
    user_scopes = auth_info.scopes if auth_info else []
    todo_owner_id = None if has_required_scopes(user_scopes, ["read:todos"]) else user_id
    
    todos = todo_service.get_all_todos(todo_owner_id)
    return {"todos": todos}

@mcp.tool()
def delete_todo(id: str) -> dict[str, Any]:
    """
    æ ¹æ“š id åˆªé™¤å¾…è¾¦äº‹é …ã€‚ä½¿ç”¨è€…å¯åˆªé™¤è‡ªå·±çš„ï¼Œ
    å…·å‚™ 'delete:todos' æ¬Šé™ç¯„åœè€…å¯åˆªé™¤ä»»ä½•å¾…è¾¦äº‹é …ã€‚
    """
    auth_info = mcp_auth.auth_info
    user_id = assert_user_id(auth_info)
    
    todo = todo_service.get_todo_by_id(id)
    
    if not todo:
        return {"error": "Failed to delete todo"}
    
    # åªæœ‰è‡ªå·±çš„å¯åˆªé™¤ï¼Œå…·å‚™ 'delete:todos' æ¬Šé™ç¯„åœè€…å¯åˆªé™¤ä»»ä½•
    user_scopes = auth_info.scopes if auth_info else []
    if todo.owner_id != user_id and not has_required_scopes(user_scopes, ["delete:todos"]):
        return {"error": "Failed to delete todo"}
    
    deleted_todo = todo_service.delete_todo(id)
    
    if deleted_todo:
        return {
            "message": f"Todo {id} deleted",
            "details": deleted_todo
        }
    else:
        return {"error": "Failed to delete todo"}
```
</TabItem>

<TabItem value="node" label="Node.js">
```js
// todo-manager.ts

// å…¶ä»– import...
import assert from 'node:assert';
import { fetchServerConfig, MCPAuth, MCPAuthBearerAuthError } from 'mcp-auth';
import { type AuthInfo } from '@modelcontextprotocol/sdk/server/auth/types.js';

// ä¸‹ä¸€ç¯€æœƒæåˆ°
import { TodoService } from './todo-service.js';

const assertUserId = (authInfo?: AuthInfo) => {
  const { subject } = authInfo ?? {};
  assert(subject, 'Invalid auth info');
  return subject;
};

const hasRequiredScopes = (userScopes: string[], requiredScopes: string[]): boolean => {
  return requiredScopes.every((scope) => userScopes.includes(scope));
};

const todoService = new TodoService();

server.tool(
  'create-todo',
  'Create a new todo',
  { content: z.string() },
  ({ content }: { content: string }, { authInfo }) => {
    const userId = assertUserId(authInfo);

    /**
     * åªæœ‰å…·å‚™ 'create:todos' æ¬Šé™ç¯„åœçš„ä½¿ç”¨è€…å¯å»ºç«‹
     */
    if (!hasRequiredScopes(authInfo?.scopes ?? [], ['create:todos'])) {
      throw new MCPAuthBearerAuthError('missing_required_scopes');
    }

    const createdTodo = todoService.createTodo({ content, ownerId: userId });

    return {
      content: [{ type: 'text', text: JSON.stringify(createdTodo) }],
    };
  }
);

server.tool('get-todos', 'List all todos', ({ authInfo }) => {
  const userId = assertUserId(authInfo);

  /**
   * æœ‰ 'read:todos' æ¬Šé™ç¯„åœå¯å­˜å–æ‰€æœ‰ï¼ˆtodoOwnerId = undefinedï¼‰
   * å¦å‰‡åƒ…èƒ½å­˜å–è‡ªå·±çš„ï¼ˆtodoOwnerId = userIdï¼‰
   */
  const todoOwnerId = hasRequiredScopes(authInfo?.scopes ?? [], ['read:todos'])
    ? undefined
    : userId;

  const todos = todoService.getAllTodos(todoOwnerId);

  return {
    content: [{ type: 'text', text: JSON.stringify(todos) }],
  };
});

server.tool(
  'delete-todo',
  'Delete a todo by id',
  { id: z.string() },
  ({ id }: { id: string }, { authInfo }) => {
    const userId = assertUserId(authInfo);

    const todo = todoService.getTodoById(id);

    if (!todo) {
      return {
        content: [{ type: 'text', text: JSON.stringify({ error: 'Failed to delete todo' }) }],
      };
    }

    /**
     * åªæœ‰è‡ªå·±çš„å¯åˆªé™¤ï¼Œå…·å‚™ 'delete:todos' æ¬Šé™ç¯„åœè€…å¯åˆªé™¤ä»»ä½•
     */
    if (todo.ownerId !== userId && !hasRequiredScopes(authInfo?.scopes ?? [], ['delete:todos'])) {
      return {
        content: [
          {
            type: 'text',
            text: JSON.stringify({ error: 'Failed to delete todo' }),
          },
        ],
      };
    }

    const deletedTodo = todoService.deleteTodo(id);

    return {
      content: [
        {
          type: 'text',
          text: JSON.stringify({
            message: `Todo ${id} deleted`,
            details: deletedTodo,
          }),
        },
      ],
    };
  }
);
```
</TabItem>
</Tabs>

ç¾åœ¨ï¼Œå»ºç«‹ä¸Šè¿°ç¨‹å¼ç¢¼æ‰€ç”¨çš„ã€ŒTodo serviceã€ä»¥å¯¦ä½œç›¸é—œåŠŸèƒ½ï¼š

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

å»ºç«‹ `service.py` ä½œç‚º Todo serviceï¼š

```python
"""
ç°¡æ˜“ Todo æœå‹™ï¼Œåƒ…ä¾›ç¤ºç¯„ç”¨é€”ã€‚
ä»¥è¨˜æ†¶é«”åˆ—è¡¨å„²å­˜ todosã€‚
"""

from datetime import datetime
from typing import List, Optional, Dict, Any
import random
import string

class Todo:
    """ä»£è¡¨ä¸€å€‹å¾…è¾¦äº‹é …ã€‚"""
    
    def __init__(self, id: str, content: str, owner_id: str, created_at: str):
        self.id = id
        self.content = content
        self.owner_id = owner_id
        self.created_at = created_at
    
    def to_dict(self) -> Dict[str, Any]:
        """è½‰æ›ç‚º dict ä»¥ä¾› JSON åºåˆ—åŒ–ã€‚"""
        return {
            "id": self.id,
            "content": self.content,
            "ownerId": self.owner_id,
            "createdAt": self.created_at
        }


class TodoService:
    """ç°¡æ˜“ Todo æœå‹™ï¼Œåƒ…ä¾›ç¤ºç¯„ç”¨é€”ã€‚"""
    
    def __init__(self):
        self._todos: List[Todo] = []
    
    def get_all_todos(self, owner_id: Optional[str] = None) -> List[Dict[str, Any]]:
        """
        å–å¾—æ‰€æœ‰ todosï¼Œå¯é¸æ“‡ä¾ owner_id éæ¿¾ã€‚
        
        Args:
            owner_id: è‹¥æä¾›ï¼Œåƒ…å›å‚³è©²ä½¿ç”¨è€…çš„ todos
            
        Returns:
            todo å­—å…¸åˆ—è¡¨
        """
        if owner_id:
            filtered_todos = [todo for todo in self._todos if todo.owner_id == owner_id]
            return [todo.to_dict() for todo in filtered_todos]
        return [todo.to_dict() for todo in self._todos]
    
    def get_todo_by_id(self, todo_id: str) -> Optional[Todo]:
        """
        ä¾ ID å–å¾— todoã€‚
        
        Args:
            todo_id: æ¬²å–å¾—çš„ todo ID
            
        Returns:
            æ‰¾åˆ°å‰‡å›å‚³ Todo ç‰©ä»¶ï¼Œå¦å‰‡ None
        """
        for todo in self._todos:
            if todo.id == todo_id:
                return todo
        return None
    
    def create_todo(self, content: str, owner_id: str) -> Dict[str, Any]:
        """
        å»ºç«‹æ–° todoã€‚
        
        Args:
            content: todo å…§å®¹
            owner_id: æ“æœ‰è€… ID
            
        Returns:
            å»ºç«‹çš„ todo å­—å…¸
        """
        todo = Todo(
            id=self._generate_id(),
            content=content,
            owner_id=owner_id,
            created_at=datetime.now().isoformat()
        )
        self._todos.append(todo)
        return todo.to_dict()
    
    def delete_todo(self, todo_id: str) -> Optional[Dict[str, Any]]:
        """
        ä¾ ID åˆªé™¤ todoã€‚
        
        Args:
            todo_id: æ¬²åˆªé™¤çš„ todo ID
            
        Returns:
            åˆªé™¤çš„ todo å­—å…¸ï¼Œè‹¥æœªæ‰¾åˆ°å‰‡ None
        """
        for i, todo in enumerate(self._todos):
            if todo.id == todo_id:
                deleted_todo = self._todos.pop(i)
                return deleted_todo.to_dict()
        return None
    
    def _generate_id(self) -> str:
        """ç”¢ç”Ÿéš¨æ©Ÿ todo IDã€‚"""
        return ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))
```

</TabItem>
<TabItem value="node" label="Node.js">

å»ºç«‹ `todo-service.ts` ä½œç‚º Todo serviceï¼š

```ts
// todo-service.ts

type Todo = {
  id: string;
  content: string;
  ownerId: string;
  createdAt: string;
};

/**
 * ç°¡æ˜“ Todo æœå‹™ï¼Œåƒ…ä¾›ç¤ºç¯„ç”¨é€”ã€‚
 * ä»¥è¨˜æ†¶é«”é™£åˆ—å„²å­˜ todos
 */
export class TodoService {
  private readonly todos: Todo[] = [];

  getAllTodos(ownerId?: string): Todo[] {
    if (ownerId) {
      return this.todos.filter((todo) => todo.ownerId === ownerId);
    }
    return this.todos;
  }

  getTodoById(id: string): Todo | undefined {
    return this.todos.find((todo) => todo.id === id);
  }

  createTodo({ content, ownerId }: { content: string; ownerId: string }): Todo {
    const todo: Todo = {
      id: this.genId(),
      content,
      ownerId,
      createdAt: new Date().toISOString(),
    };

    // eslint-disable-next-line @silverhand/fp/no-mutating-methods
    this.todos.push(todo);
    return todo;
  }

  deleteTodo(id: string): Todo | undefined {
    const index = this.todos.findIndex((todo) => todo.id === id);

    if (index === -1) {
      return undefined;
    }

    // eslint-disable-next-line @silverhand/fp/no-mutating-methods
    const [deleted] = this.todos.splice(index, 1);
    return deleted;
  }

  private genId(): string {
    return Math.random().toString(36).slice(2, 10);
  }
}
```

</TabItem>
</Tabs>

ğŸ‰ æ­å–œï¼æˆ‘å€‘å·²æˆåŠŸå¯¦ä½œä¸€å€‹å…·å‚™é©—è­‰ (Authentication) èˆ‡æˆæ¬Š (Authorization) çš„å®Œæ•´ MCP ä¼ºæœå™¨ï¼

ä½ ä¹Ÿå¯ä»¥åƒè€ƒæˆ‘å€‘çš„ç¯„ä¾‹ç¨‹å¼ç¢¼ï¼š

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

:::info
å®Œæ•´ MCP ä¼ºæœå™¨ï¼ˆOIDC ç‰ˆæœ¬ï¼‰ç¨‹å¼ç¢¼è«‹åƒè€ƒ [MCP Auth Python SDK repository](https://github.com/mcp-auth/python/tree/master/samples/current/todo-manager)ã€‚
:::

</TabItem>
<TabItem value="node" label="Node.js">

:::info
å®Œæ•´ MCP ä¼ºæœå™¨ï¼ˆOIDC ç‰ˆæœ¬ï¼‰ç¨‹å¼ç¢¼è«‹åƒè€ƒ [MCP Auth Node.js SDK repository](https://github.com/mcp-auth/js/blob/master/packages/sample-servers/src)ã€‚
:::

</TabItem>
</Tabs>

## æª¢æŸ¥é»ï¼šåŸ·è¡Œ `todo-manager` å·¥å…· \{#checkpoint-run-the-todo-manager-tools}

é‡æ–°å•Ÿå‹• MCP ä¼ºæœå™¨ä¸¦æ–¼ç€è¦½å™¨é–‹å•Ÿ MCP inspectorã€‚é»æ“Šã€ŒConnectã€æŒ‰éˆ•æ™‚ï¼Œä½ æ‡‰æœƒè¢«å°å‘æˆæ¬Šä¼ºæœå™¨çš„ç™»å…¥é é¢ã€‚

ç™»å…¥ä¸¦è¿”å› MCP inspector å¾Œï¼Œé‡è¤‡å‰è¿°æ­¥é©ŸåŸ·è¡Œ todo manager å·¥å…·ã€‚é€™æ¬¡ä½ å°‡ä»¥å·²é©—è­‰ (Authentication) çš„ä½¿ç”¨è€…èº«åˆ†ä½¿ç”¨é€™äº›å·¥å…·ã€‚å·¥å…·è¡Œç‚ºæœƒæ ¹æ“šä½ å¸³è™Ÿçš„è§’è‰²èˆ‡æ¬Šé™è€Œç•°ï¼š

- è‹¥ä»¥ **User**ï¼ˆåƒ…æœ‰ `create:todos` æ¬Šé™ç¯„åœï¼‰ç™»å…¥ï¼š

  - å¯ç”¨ `create-todo` å·¥å…·å»ºç«‹æ–°å¾…è¾¦äº‹é …
  - åƒ…èƒ½æª¢è¦–èˆ‡åˆªé™¤è‡ªå·±çš„å¾…è¾¦äº‹é …
  - ç„¡æ³•æª¢è¦–æˆ–åˆªé™¤å…¶ä»–ä½¿ç”¨è€…çš„å¾…è¾¦äº‹é …

- è‹¥ä»¥ **Admin**ï¼ˆå…·å‚™æ‰€æœ‰æ¬Šé™ç¯„åœï¼š`create:todos`ã€`read:todos`ã€`delete:todos`ï¼‰ç™»å…¥ï¼š
  - å¯å»ºç«‹æ–°å¾…è¾¦äº‹é …
  - å¯ç”¨ `get-todos` å·¥å…·æª¢è¦–ç³»çµ±æ‰€æœ‰å¾…è¾¦äº‹é …
  - å¯ç”¨ `delete-todo` å·¥å…·åˆªé™¤ä»»ä½•å¾…è¾¦äº‹é …ï¼Œä¸è«–æ“æœ‰è€…

ä½ å¯ä»¥é€éä»¥ä¸‹æ–¹å¼æ¸¬è©¦ä¸åŒæ¬Šé™å±¤ç´šï¼š

1. ç™»å‡ºç›®å‰ sessionï¼ˆæ–¼ MCP inspector é»æ“Šã€ŒDisconnectã€ï¼‰
2. ä»¥ä¸åŒæ¬Šé™çš„å¸³è™Ÿç™»å…¥
3. é‡è¤‡åŸ·è¡Œç›¸åŒå·¥å…·ï¼Œè§€å¯Ÿè¡Œç‚ºå¦‚ä½•éš¨ä½¿ç”¨è€…æ¬Šé™è®ŠåŒ–

é€™å±•ç¾äº†è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC) çš„å¯¦éš›é‹ä½œï¼Œä¸åŒä½¿ç”¨è€…å°ç³»çµ±åŠŸèƒ½æœ‰ä¸åŒå­˜å–å±¤ç´šã€‚

![MCP inspector todo manager å·¥å…·çµæœ](/docs-assets/images/tutorials/todo-manager/result.png)

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

:::info
å®Œæ•´ MCP ä¼ºæœå™¨ï¼ˆOIDC ç‰ˆæœ¬ï¼‰ç¨‹å¼ç¢¼è«‹åƒè€ƒ [MCP Auth Python SDK repository](https://github.com/mcp-auth/python)ã€‚
:::

</TabItem>
<TabItem value="node" label="Node.js">

:::info
å®Œæ•´ MCP ä¼ºæœå™¨ï¼ˆOIDC ç‰ˆæœ¬ï¼‰ç¨‹å¼ç¢¼è«‹åƒè€ƒ [MCP Auth Node.js SDK repository](https://github.com/mcp-auth/js/blob/master/packages/sample-servers/src)ã€‚
:::

</TabItem>
</Tabs>

## çµèª \{#closing-notes}

ğŸŠ æ­å–œï¼ä½ å·²é †åˆ©å®Œæˆæœ¬æ•™å­¸ã€‚è®“æˆ‘å€‘å›é¡§ä¸€ä¸‹ï¼š

- å»ºç«‹å…·å‚™ todo ç®¡ç†å·¥å…·ï¼ˆ`create-todo`ã€`get-todos`ã€`delete-todo`ï¼‰çš„åŸºæœ¬ MCP ä¼ºæœå™¨
- å¯¦ä½œä¸åŒä½¿ç”¨è€…èˆ‡ç®¡ç†å“¡æ¬Šé™å±¤ç´šçš„è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC)
- é€é MCP Auth å°‡ MCP ä¼ºæœå™¨èˆ‡æˆæ¬Šä¼ºæœå™¨æ•´åˆ
- è¨­å®š MCP Inspector ä»¥é©—è­‰ (Authentication) ä½¿ç”¨è€…ä¸¦ä½¿ç”¨å¸¶æœ‰æ¬Šé™ç¯„åœçš„å­˜å–æ¬Šæ–å‘¼å«å·¥å…·

æ­¡è¿åƒé–±å…¶ä»–æ•™å­¸èˆ‡æ–‡ä»¶ï¼Œå……åˆ†ç™¼æ® MCP Auth çš„å¼·å¤§åŠŸèƒ½ã€‚
