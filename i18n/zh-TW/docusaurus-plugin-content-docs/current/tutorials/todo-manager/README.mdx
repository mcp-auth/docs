---
sidebar_position: 2
sidebar_label: 'æ•™å­¸ï¼šæ‰“é€ å¾…è¾¦äº‹é …ç®¡ç†å™¨ (Tutorial: Build a todo manager)'
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import SetupOauthOrOidc from './_setup-oauth-or-oidc.mdx';
import SetupOidc from './_setup-oidc.mdx';

# æ•™å­¸ï¼šæ‰“é€ å¾…è¾¦äº‹é …ç®¡ç†å™¨ (Tutorial: Build a todo manager)

åœ¨æœ¬æ•™å­¸ä¸­ï¼Œæˆ‘å€‘å°‡å»ºç«‹ä¸€å€‹å…·å‚™ä½¿ç”¨è€…é©—è­‰ (Authentication) èˆ‡æˆæ¬Š (Authorization) çš„ todo manager MCP ä¼ºæœå™¨ã€‚

å®Œæˆæœ¬æ•™å­¸å¾Œï¼Œä½ å°‡æœƒï¼š

- âœ… åŸºæœ¬ç­è§£å¦‚ä½•åœ¨ MCP ä¼ºæœå™¨ä¸­è¨­å®šè§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC, Role-based Access Control)
- âœ… æ“æœ‰ä¸€å€‹å¯ä»¥ç®¡ç†å€‹äººå¾…è¾¦æ¸…å–®çš„ MCP ä¼ºæœå™¨

:::note
åœ¨é–‹å§‹ä¹‹å‰ï¼Œå¦‚æœä½ å° MCP ä¼ºæœå™¨èˆ‡ OAuth 2 ä¸ç†Ÿæ‚‰ï¼Œå¼·çƒˆå»ºè­°å…ˆé–±è®€ [Who am I æ•™å­¸](./whoami)ã€‚
:::

## æ¦‚è¦½ (Overview) \{#overview}

æœ¬æ•™å­¸å°‡åŒ…å«ä»¥ä¸‹å…ƒä»¶ï¼š

- **MCP ä¼ºæœå™¨**ï¼šä¸€å€‹ç°¡å–®çš„ MCP ä¼ºæœå™¨ï¼Œä½¿ç”¨ MCP å®˜æ–¹ SDK è™•ç†è«‹æ±‚ï¼Œä¸¦æ•´åˆ Todo æœå‹™ä¾†ç®¡ç†ä½¿ç”¨è€…çš„å¾…è¾¦äº‹é …ã€‚
- **MCP inspector**ï¼šä¸€å€‹ MCP ä¼ºæœå™¨çš„è¦–è¦ºåŒ–æ¸¬è©¦å·¥å…·ï¼ŒåŒæ™‚ä½œç‚º OAuth / OIDC ç”¨æˆ¶ç«¯ï¼Œå•Ÿå‹•æˆæ¬Šæµç¨‹ä¸¦å–å¾—å­˜å–æ¬Šæ– (Access token)ã€‚
- **æˆæ¬Šä¼ºæœå™¨ (Authorization server)**ï¼šä¸€å€‹ OAuth 2.1 æˆ– OpenID Connect æä¾›è€…ï¼Œè² è²¬ç®¡ç†ä½¿ç”¨è€…èº«åˆ†ä¸¦ç°½ç™¼å­˜å–æ¬Šæ– (Access token)ã€‚

ä»¥ä¸‹æ˜¯é€™äº›å…ƒä»¶é–“äº’å‹•çš„é«˜éšåœ–ç¤ºï¼š

```mermaid
sequenceDiagram
    participant Client as MCP Inspector
    participant Server as MCP Server
    participant Auth as æˆæ¬Šä¼ºæœå™¨ (Authorization Server)

    Client->>Server: è«‹æ±‚å¾…è¾¦äº‹é …æ“ä½œ (Request todo operation)
    Server->>Client: å›å‚³ 401 æœªæˆæ¬Š (Return 401 Unauthorized)
    Client->>Auth: å•Ÿå‹•æˆæ¬Šæµç¨‹ (Initiate authorization flow)
    Auth->>Auth: å®Œæˆæˆæ¬Šæµç¨‹ (Complete authorization flow)
    Auth->>Client: å¸¶æˆæ¬Šç¢¼é‡å°å›ä¾† (Redirect back with authorization code)
    Client->>Auth: ç”¨æˆæ¬Šç¢¼æ›å–å­˜å–æ¬Šæ– (Exchange code for access token)
    Auth->>Client: å›å‚³å­˜å–æ¬Šæ– (Return access token)
    Client->>Server: æ”œå¸¶å­˜å–æ¬Šæ–è«‹æ±‚å¾…è¾¦äº‹é …æ“ä½œ (Request todo operation with access token)
    Server->>Server: é©—è­‰å­˜å–æ¬Šæ–ä¸¦å–å¾—ä½¿ç”¨è€…æ¬Šé™ç¯„åœ (Validate access token and get user scopes form access token)
    Note over Server: åŸ·è¡Œå¾…è¾¦äº‹é …æ“ä½œ (Execute todo operation)
    Server->>Client: å›å‚³æ“ä½œçµæœ (Return todo operation result)
```

## ç­è§£ä½ çš„æˆæ¬Šä¼ºæœå™¨ (Understand your authorization server) \{#understand-your-authorization-server}

### å…·æœ‰æ¬Šé™ç¯„åœ (Scopes) çš„å­˜å–æ¬Šæ– (Access tokens) \{#access-tokens-with-scopes}

è¦åœ¨ MCP ä¼ºæœå™¨ä¸­å¯¦ä½œ [è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC, Role-based Access Control)](https://auth.wiki/rbac)ï¼Œä½ çš„æˆæ¬Šä¼ºæœå™¨éœ€æ”¯æ´ç°½ç™¼å¸¶æœ‰æ¬Šé™ç¯„åœ (Scopes) çš„å­˜å–æ¬Šæ– (Access tokens)ã€‚æ¬Šé™ç¯„åœ (Scopes) ä»£è¡¨ä½¿ç”¨è€…è¢«æˆäºˆçš„æ¬Šé™ã€‚

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

[Logto](https://logto.io) é€é API è³‡æº (API resources)ï¼ˆç¬¦åˆ [RFC 8707: Resource Indicators for OAuth 2.0](https://datatracker.ietf.org/doc/html/rfc8707)ï¼‰èˆ‡è§’è‰² (Roles) åŠŸèƒ½æ”¯æ´ RBACã€‚è¨­å®šæ–¹å¼å¦‚ä¸‹ï¼š

1. ç™»å…¥ [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ¶ Logto Consoleï¼‰

2. å»ºç«‹ API è³‡æºèˆ‡æ¬Šé™ç¯„åœ (Scopes)ï¼š

   - å‰å¾€ã€ŒAPI è³‡æº (API Resources)ã€
   - å»ºç«‹ä¸€å€‹åç‚ºã€ŒTodo Managerã€çš„æ–° API è³‡æº
   - æ–°å¢ä»¥ä¸‹æ¬Šé™ç¯„åœï¼š
     - `create:todos`ï¼šã€Œå»ºç«‹æ–°å¾…è¾¦äº‹é …ã€
     - `read:todos`ï¼šã€Œè®€å–æ‰€æœ‰å¾…è¾¦äº‹é …ã€
     - `delete:todos`ï¼šã€Œåˆªé™¤ä»»ä¸€å¾…è¾¦äº‹é …ã€

3. å»ºç«‹è§’è‰²ï¼ˆå»ºè­°ä»¥ä¾¿ç®¡ç†ï¼‰ï¼š

   - å‰å¾€ã€Œè§’è‰² (Roles)ã€
   - å»ºç«‹ã€ŒAdminã€è§’è‰²ä¸¦æŒ‡æ´¾æ‰€æœ‰æ¬Šé™ç¯„åœï¼ˆ`create:todos`ã€`read:todos`ã€`delete:todos`ï¼‰
   - å»ºç«‹ã€ŒUserã€è§’è‰²ä¸¦åƒ…æŒ‡æ´¾ `create:todos` æ¬Šé™ç¯„åœ

4. æŒ‡æ´¾æ¬Šé™ï¼š
   - å‰å¾€ã€Œä½¿ç”¨è€… (Users)ã€
   - é¸æ“‡ä¸€ä½ä½¿ç”¨è€…
   - ä½ å¯ä»¥ï¼š
     - åœ¨ã€Œè§’è‰² (Roles)ã€åˆ†é æŒ‡æ´¾è§’è‰²ï¼ˆå»ºè­°ï¼‰
     - æˆ–ç›´æ¥åœ¨ã€Œæ¬Šé™ (Permissions)ã€åˆ†é æŒ‡æ´¾æ¬Šé™ç¯„åœ

é€™äº›æ¬Šé™ç¯„åœæœƒä»¥ç©ºæ ¼åˆ†éš”å­—ä¸²çš„å½¢å¼åŒ…å«åœ¨ JWT å­˜å–æ¬Šæ–çš„ `scope` å®£å‘Š (Claim) ä¸­ã€‚

</TabItem>
<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

OAuth 2.0 / OIDC æä¾›è€…é€šå¸¸æ”¯æ´åŸºæ–¼æ¬Šé™ç¯„åœ (Scope) çš„å­˜å–æ§åˆ¶ã€‚å¯¦ä½œ RBAC æ™‚ï¼š

1. åœ¨æˆæ¬Šä¼ºæœå™¨ä¸­å®šç¾©æ‰€éœ€çš„æ¬Šé™ç¯„åœ
2. è¨­å®šç”¨æˆ¶ç«¯åœ¨æˆæ¬Šæµç¨‹ä¸­è«‹æ±‚é€™äº›æ¬Šé™ç¯„åœ
3. ç¢ºä¿æˆæ¬Šä¼ºæœå™¨å°‡æˆäºˆçš„æ¬Šé™ç¯„åœåŒ…å«åœ¨å­˜å–æ¬Šæ–ä¸­
4. æ¬Šé™ç¯„åœé€šå¸¸æœƒåŒ…å«åœ¨ JWT å­˜å–æ¬Šæ–çš„ `scope` å®£å‘Š (Claim) ä¸­

è«‹æŸ¥é–±ä½ çš„æä¾›è€…æ–‡ä»¶ä»¥ç­è§£ï¼š

- å¦‚ä½•å®šç¾©èˆ‡ç®¡ç†æ¬Šé™ç¯„åœ
- æ¬Šé™ç¯„åœå¦‚ä½•åŒ…å«åœ¨å­˜å–æ¬Šæ–ä¸­
- æ˜¯å¦æœ‰é¡å¤–çš„ RBAC åŠŸèƒ½å¦‚è§’è‰²ç®¡ç†

</TabItem>
</Tabs>

### æ¬Šæ–é©—è­‰èˆ‡æ¬Šé™æª¢æŸ¥ (Validating tokens and checking permissions) \{#validating-tokens-and-checking-permissions}

ç•¶ MCP ä¼ºæœå™¨æ”¶åˆ°è«‹æ±‚æ™‚ï¼Œéœ€åŸ·è¡Œï¼š

1. é©—è­‰å­˜å–æ¬Šæ–çš„ç°½ç« èˆ‡æœ‰æ•ˆæœŸé™
2. å¾é©—è­‰å¾Œçš„æ¬Šæ–ä¸­æ“·å–æ¬Šé™ç¯„åœ (Scopes)
3. æª¢æŸ¥æ¬Šæ–æ˜¯å¦å…·å‚™åŸ·è¡Œè©²æ“ä½œæ‰€éœ€çš„æ¬Šé™ç¯„åœ

ä¾‹å¦‚ï¼Œè‹¥ä½¿ç”¨è€…è¦å»ºç«‹æ–°å¾…è¾¦äº‹é …ï¼Œå…¶å­˜å–æ¬Šæ–å¿…é ˆåŒ…å« `create:todos` æ¬Šé™ç¯„åœã€‚æµç¨‹å¦‚ä¸‹ï¼š

```mermaid
sequenceDiagram
    participant Client
    participant MCP Server
    participant Auth Server

    Client->>MCP Server: æ”œå¸¶å­˜å–æ¬Šæ–è«‹æ±‚ (Request with access token)

    alt JWT é©—è­‰ (JWT Validation)
        MCP Server->>Auth Server: å–å¾— JWKS (Fetch JWKS)
        Auth Server-->>MCP Server: å›å‚³ JWKS (Return JWKS)
        MCP Server->>MCP Server: æœ¬åœ°é©—è­‰ JWT (Validate JWT locally)
    else æ¬Šæ–å…§çœ (Token Introspection)
        MCP Server->>Auth Server: POST /introspect<br/>(token=access_token)
        Auth Server-->>MCP Server: å›å‚³æ¬Šæ–è³‡è¨Š<br/>(active, scope, etc.)
    end

    MCP Server->>MCP Server: æ“·å–ä¸¦æª¢æŸ¥æ¬Šé™ç¯„åœ (Extract & check scopes)

    alt å…·å‚™æ‰€éœ€æ¬Šé™ç¯„åœ (Has required scopes)
        MCP Server->>Client: å…è¨±æ“ä½œ (Allow operation)
    else æ¬ ç¼ºæ¬Šé™ç¯„åœ (Missing scopes)
        MCP Server->>Client: å›å‚³ 403 ç¦æ­¢ (Return 403 Forbidden)
    end
```

### å‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Š (Dynamic Client Registration) \{#dynamic-client-registration}

æœ¬æ•™å­¸ä¸å¼·åˆ¶éœ€è¦å‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Šï¼Œä½†è‹¥ä½ æƒ³è‡ªå‹•åŒ– MCP ç”¨æˆ¶ç«¯è¨»å†Šæµç¨‹ï¼Œå¯åƒè€ƒ [æ˜¯å¦éœ€è¦ Dynamic Client Registration?](../../provider-list.mdx#is-dcr-required)ã€‚

## ç­è§£ todo manager çš„ RBAC (Understand RBAC in todo manager) \{#understand-rbac-in-todo-manager}

ç‚ºäº†ç¤ºç¯„ï¼Œæˆ‘å€‘æœƒåœ¨ todo manager MCP ä¼ºæœå™¨ä¸­å¯¦ä½œä¸€å€‹ç°¡å–®çš„è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC) ç³»çµ±ï¼Œè®“ä½ ç­è§£ RBAC çš„åŸºæœ¬åŸå‰‡ï¼ŒåŒæ™‚ä¿æŒå¯¦ä½œç°¡å–®ã€‚

:::note
é›–ç„¶æœ¬æ•™å­¸ä»¥ RBAC æ¬Šé™ç¯„åœç®¡ç†ç‚ºä¾‹ï¼Œä½†ä¸¦éæ‰€æœ‰é©—è­‰ (Authentication) æä¾›è€…éƒ½é€éè§’è‰² (Role) ä¾†ç®¡ç†æ¬Šé™ç¯„åœ (Scope)ã€‚æœ‰äº›æä¾›è€…å¯èƒ½æœ‰è‡ªå·±ç¨ç‰¹çš„å­˜å–æ§åˆ¶èˆ‡æ¬Šé™ç®¡ç†æ©Ÿåˆ¶ã€‚
:::

### å·¥å…·èˆ‡æ¬Šé™ç¯„åœ (Tools and scopes) \{#tools-and-scopes}

æˆ‘å€‘çš„ todo manager MCP ä¼ºæœå™¨æä¾›ä¸‰å€‹ä¸»è¦å·¥å…·ï¼š

- `create-todo`ï¼šå»ºç«‹æ–°å¾…è¾¦äº‹é …
- `get-todos`ï¼šåˆ—å‡ºæ‰€æœ‰å¾…è¾¦äº‹é …
- `delete-todo`ï¼šä¾ ID åˆªé™¤å¾…è¾¦äº‹é …

ç‚ºäº†æ§åˆ¶é€™äº›å·¥å…·çš„å­˜å–ï¼Œæˆ‘å€‘å®šç¾©ä»¥ä¸‹æ¬Šé™ç¯„åœï¼š

- `create:todos`ï¼šå…è¨±å»ºç«‹æ–°å¾…è¾¦äº‹é …
- `delete:todos`ï¼šå…è¨±åˆªé™¤ç¾æœ‰å¾…è¾¦äº‹é …
- `read:todos`ï¼šå…è¨±æŸ¥è©¢ä¸¦å–å¾—æ‰€æœ‰å¾…è¾¦äº‹é …æ¸…å–®

### è§’è‰²èˆ‡æ¬Šé™ (Roles and permissions) \{#roles-and-permissions}

æˆ‘å€‘å°‡å®šç¾©å…©å€‹ä¸åŒå­˜å–å±¤ç´šçš„è§’è‰²ï¼š

| è§’è‰² (Role) | create:todos | read:todos | delete:todos |
| ----------- | ------------ | ---------- | ------------ |
| Admin       | âœ…           | âœ…         | âœ…           |
| User        | âœ…           |            |              |

- **User**ï¼šä¸€èˆ¬ä½¿ç”¨è€…ï¼Œå¯å»ºç«‹å¾…è¾¦äº‹é …ï¼Œåƒ…èƒ½æª¢è¦–æˆ–åˆªé™¤è‡ªå·±çš„å¾…è¾¦äº‹é …
- **Admin**ï¼šç®¡ç†å“¡ï¼Œå¯å»ºç«‹ã€æª¢è¦–åŠåˆªé™¤æ‰€æœ‰å¾…è¾¦äº‹é …ï¼Œä¸è«–æ“æœ‰è€…ç‚ºèª°

### è³‡æºæ“æœ‰æ¬Š (Resource ownership) \{#resource-ownership}

é›–ç„¶ä¸Šè¡¨é¡¯ç¤ºæ¯å€‹è§’è‰²æ˜ç¢ºè¢«æŒ‡æ´¾çš„æ¬Šé™ç¯„åœï¼Œä½†é‚„æœ‰ä¸€å€‹é‡è¦çš„ã€Œè³‡æºæ“æœ‰æ¬Šã€åŸå‰‡ï¼š

- **User** æ²’æœ‰ `read:todos` æˆ– `delete:todos` æ¬Šé™ç¯„åœï¼Œä½†ä»å¯ï¼š
  - è®€å–è‡ªå·±çš„å¾…è¾¦äº‹é …
  - åˆªé™¤è‡ªå·±çš„å¾…è¾¦äº‹é …
- **Admin** æ“æœ‰å®Œæ•´æ¬Šé™ï¼ˆ`read:todos` èˆ‡ `delete:todos`ï¼‰ï¼Œå¯ï¼š
  - æª¢è¦–ç³»çµ±ä¸­æ‰€æœ‰å¾…è¾¦äº‹é …
  - åˆªé™¤ä»»ä½•å¾…è¾¦äº‹é …ï¼Œä¸è«–æ“æœ‰è€…

é€™å±•ç¾äº† RBAC ç³»çµ±ä¸­å¸¸è¦‹çš„æ¨¡å¼ï¼šè³‡æºæ“æœ‰æ¬Šæœƒéš±å«æˆäºˆä½¿ç”¨è€…å°è‡ªå·±è³‡æºçš„æ¬Šé™ï¼Œè€Œç®¡ç†è§’è‰²å‰‡ç²å¾—å°æ‰€æœ‰è³‡æºçš„æ˜ç¢ºæ¬Šé™ã€‚

:::tip é€²ä¸€æ­¥ç­è§£
æƒ³æ·±å…¥ç­è§£ RBAC æ¦‚å¿µèˆ‡æœ€ä½³å¯¦è¸ï¼Œè«‹åƒé–± [ç²¾é€š RBACï¼šå®Œæ•´å¯¦ä¾‹è§£æ (Mastering RBAC: A Comprehensive Real-World Example)](https://blog.logto.io/mastering-rbac)ã€‚
:::

## åœ¨ä½ çš„æä¾›è€…ä¸­è¨­å®šæˆæ¬Š (Configure authorization in your provider) \{#configure-authorization-in-your-provider}

è¦å¯¦ä½œä¸Šè¿°å­˜å–æ§åˆ¶ç³»çµ±ï¼Œä½ éœ€è¦åœ¨æˆæ¬Šä¼ºæœå™¨ä¸­è¨­å®šæ‰€éœ€çš„æ¬Šé™ç¯„åœã€‚ä»¥ä¸‹æ˜¯ä¸åŒæä¾›è€…çš„è¨­å®šæ–¹å¼ï¼š

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

[Logto](https://logto.io) é€é API è³‡æº (API resources) èˆ‡è§’è‰² (Roles) åŠŸèƒ½æ”¯æ´ RBACã€‚è¨­å®šæ–¹å¼å¦‚ä¸‹ï¼š

1. ç™»å…¥ [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ¶ Logto Consoleï¼‰

2. å»ºç«‹ API è³‡æºèˆ‡æ¬Šé™ç¯„åœï¼š

   - å‰å¾€ã€ŒAPI è³‡æº (API Resources)ã€
   - å»ºç«‹ä¸€å€‹åç‚ºã€ŒTodo Managerã€çš„æ–° API è³‡æºï¼Œä¸¦ä»¥ `https://todo.mcp-server.app`ï¼ˆåƒ…ä¾›ç¤ºç¯„ï¼‰ä½œç‚ºè³‡æºæ¨™ç¤ºç¬¦ (indicator)ã€‚
   - å»ºç«‹ä»¥ä¸‹æ¬Šé™ç¯„åœï¼š
     - `create:todos`ï¼šã€Œå»ºç«‹æ–°å¾…è¾¦äº‹é …ã€
     - `read:todos`ï¼šã€Œè®€å–æ‰€æœ‰å¾…è¾¦äº‹é …ã€
     - `delete:todos`ï¼šã€Œåˆªé™¤ä»»ä¸€å¾…è¾¦äº‹é …ã€

3. å»ºç«‹è§’è‰²ï¼ˆå»ºè­°ä»¥ä¾¿ç®¡ç†ï¼‰ï¼š

   - å‰å¾€ã€Œè§’è‰² (Roles)ã€
   - å»ºç«‹ã€ŒAdminã€è§’è‰²ä¸¦æŒ‡æ´¾æ‰€æœ‰æ¬Šé™ç¯„åœï¼ˆ`create:todos`ã€`read:todos`ã€`delete:todos`ï¼‰
   - å»ºç«‹ã€ŒUserã€è§’è‰²ä¸¦åƒ…æŒ‡æ´¾ `create:todos` æ¬Šé™ç¯„åœ
   - åœ¨ã€ŒUserã€è§’è‰²è©³ç´°é åˆ‡æ›åˆ°ã€Œä¸€èˆ¬ (General)ã€åˆ†é ï¼Œå°‡ã€ŒUserã€è¨­ç‚ºã€Œé è¨­è§’è‰² (Default role)ã€

4. ç®¡ç†ä½¿ç”¨è€…è§’è‰²èˆ‡æ¬Šé™ï¼š
   - æ–°ä½¿ç”¨è€…ï¼š
     - æœƒè‡ªå‹•ç²å¾—ã€ŒUserã€è§’è‰²ï¼ˆå› å·²è¨­ç‚ºé è¨­è§’è‰²ï¼‰
   - ç¾æœ‰ä½¿ç”¨è€…ï¼š
     - å‰å¾€ã€Œä½¿ç”¨è€…ç®¡ç† (User management)ã€
     - é¸æ“‡ä¸€ä½ä½¿ç”¨è€…
     - åœ¨ã€Œè§’è‰² (Roles)ã€åˆ†é æŒ‡æ´¾è§’è‰²

:::tip ç¨‹å¼åŒ–è§’è‰²ç®¡ç† (Programmatic Role Management)
ä½ ä¹Ÿå¯ä»¥é€é Logto çš„ [Management API](https://docs.logto.io/integrate-logto/interact-with-management-api) ç¨‹å¼åŒ–ç®¡ç†ä½¿ç”¨è€…è§’è‰²ã€‚é€™å°è‡ªå‹•åŒ–ä½¿ç”¨è€…ç®¡ç†æˆ–å»ºç«‹ç®¡ç†å¾Œå°ç‰¹åˆ¥æœ‰ç”¨ã€‚
:::

è«‹æ±‚å­˜å–æ¬Šæ–æ™‚ï¼ŒLogto æœƒæ ¹æ“šä½¿ç”¨è€…è§’è‰²æ¬Šé™å°‡æ¬Šé™ç¯„åœåŒ…å«åœ¨æ¬Šæ–çš„ `scope` å®£å‘Šä¸­ã€‚

</TabItem>
<TabItem value="keycloak" label="Keycloak">

åœ¨ [Keycloak](https://www.keycloak.org) ä¸­ï¼Œä½ å¯ä»¥é€é client scopes è¨­å®šæ‰€éœ€æ¬Šé™ï¼š

1. å»ºç«‹ client scopesï¼š

   - åœ¨ä½ çš„ realm ä¸­ï¼Œå‰å¾€ã€ŒClient scopesã€
   - å»ºç«‹ä¸‰å€‹æ–° client scopesï¼š
     - `create:todos`
     - `read:todos`
     - `delete:todos`

2. è¨­å®šç”¨æˆ¶ç«¯ï¼š

   - å‰å¾€ä½ çš„ client è¨­å®š
   - åœ¨ã€ŒClient scopesã€åˆ†é æ–°å¢æ‰€æœ‰å·²å»ºç«‹çš„ scopes
   - ç¢ºèª token mapper å·²è¨­å®šç‚ºåŒ…å« scopes

3. é¸ç”¨ï¼šä½¿ç”¨è§’è‰²æ–¹ä¾¿ç®¡ç†
   - è‹¥åå¥½è§’è‰²å‹ç®¡ç†ï¼š
     - å»ºç«‹ä¸åŒå­˜å–å±¤ç´šçš„ realm roles
     - å°‡ scopes æ˜ å°„åˆ°è§’è‰²
     - æŒ‡æ´¾è§’è‰²çµ¦ä½¿ç”¨è€…
   - å¦å‰‡å¯ç›´æ¥æŒ‡æ´¾ scopes çµ¦ä½¿ç”¨è€…æˆ–é€é client-level permissions

Keycloak æœƒå°‡æˆäºˆçš„ scopes åŒ…å«åœ¨å­˜å–æ¬Šæ–çš„ `scope` å®£å‘Šä¸­ã€‚

</TabItem>
<TabItem value="oauth-or-oidc" label="OAuth 2 / OIDC">

å°æ–¼ OAuth 2.0 æˆ– OpenID Connect æä¾›è€…ï¼Œä½ éœ€è¦è¨­å®šä»£è¡¨ä¸åŒæ¬Šé™çš„ scopesã€‚å…·é«”æ­¥é©Ÿä¾æä¾›è€…è€Œç•°ï¼Œä½†ä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼š

1. å®šç¾© scopesï¼š

   - è¨­å®šæˆæ¬Šä¼ºæœå™¨æ”¯æ´ï¼š
     - `create:todos`
     - `read:todos`
     - `delete:todos`

2. è¨­å®šç”¨æˆ¶ç«¯ï¼š

   - è¨»å†Šæˆ–æ›´æ–°ç”¨æˆ¶ç«¯ä»¥è«‹æ±‚é€™äº› scopes
   - ç¢ºèª scopes æœƒåŒ…å«åœ¨å­˜å–æ¬Šæ–ä¸­

3. æŒ‡æ´¾æ¬Šé™ï¼š
   - é€éæä¾›è€…ä»‹é¢æˆäºˆä½¿ç”¨è€…é©ç•¶çš„ scopes
   - æœ‰äº›æä¾›è€…æ”¯æ´è§’è‰²å‹ç®¡ç†ï¼Œæœ‰äº›å‰‡ç›´æ¥æŒ‡æ´¾ scopes
   - è«‹æŸ¥é–±æä¾›è€…æ–‡ä»¶ä»¥ç²å¾—å»ºè­°åšæ³•

:::tip
å¤§å¤šæ•¸æä¾›è€…æœƒå°‡æˆäºˆçš„ scopes åŒ…å«åœ¨å­˜å–æ¬Šæ–çš„ `scope` å®£å‘Šä¸­ï¼Œæ ¼å¼é€šå¸¸ç‚ºç©ºæ ¼åˆ†éš”çš„ scope å­—ä¸²ã€‚
:::

</TabItem>
</Tabs>

è¨­å®šå¥½æˆæ¬Šä¼ºæœå™¨å¾Œï¼Œä½¿ç”¨è€…å°‡å–å¾—åŒ…å«å…¶æˆæ¬Š scopes çš„å­˜å–æ¬Šæ–ã€‚MCP ä¼ºæœå™¨æœƒæ ¹æ“šé€™äº› scopes åˆ¤æ–·ï¼š

- ä½¿ç”¨è€…æ˜¯å¦èƒ½å»ºç«‹æ–°å¾…è¾¦äº‹é …ï¼ˆ`create:todos`ï¼‰
- ä½¿ç”¨è€…æ˜¯å¦èƒ½æª¢è¦–æ‰€æœ‰å¾…è¾¦äº‹é …ï¼ˆ`read:todos`ï¼‰æˆ–åƒ…èƒ½æª¢è¦–è‡ªå·±çš„
- ä½¿ç”¨è€…æ˜¯å¦èƒ½åˆªé™¤ä»»ä¸€å¾…è¾¦äº‹é …ï¼ˆ`delete:todos`ï¼‰æˆ–åƒ…èƒ½åˆªé™¤è‡ªå·±çš„

## è¨­å®š MCP ä¼ºæœå™¨ (Set up the MCP server) \{#set-up-the-mcp-server}

æˆ‘å€‘å°‡ä½¿ç”¨ [MCP å®˜æ–¹ SDK](https://github.com/modelcontextprotocol) å»ºç«‹ todo manager MCP ä¼ºæœå™¨ã€‚

### å»ºç«‹æ–°å°ˆæ¡ˆ (Create a new project) \{#create-a-new-project}

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```bash
mkdir mcp-server
cd mcp-server
uv init # æˆ–ä½¿ç”¨ `pipenv` æˆ– `poetry` å»ºç«‹æ–°è™›æ“¬ç’°å¢ƒ
```

</TabItem>
<TabItem value="node" label="Node.js">

å»ºç«‹æ–°çš„ Node.js å°ˆæ¡ˆï¼š

```bash
mkdir mcp-server
cd mcp-server
npm init -y # æˆ–ä½¿ç”¨ `pnpm init`
npm pkg set type="module"
npm pkg set main="todo-manager.ts"
npm pkg set scripts.start="node --experimental-strip-types todo-manager.ts"
```

:::note
æˆ‘å€‘ç¯„ä¾‹ä¸­ä½¿ç”¨ TypeScriptï¼Œå› ç‚º Node.js v22.6.0+ åŸç”Ÿæ”¯æ´ `--experimental-strip-types` åŸ·è¡Œ TypeScriptã€‚å¦‚æœä½ ç”¨ JavaScriptï¼Œç¨‹å¼ç¢¼ä¹Ÿå¾ˆé¡ä¼¼â€”â€”åªè¦ç¢ºä¿ Node.js ç‰ˆæœ¬ç‚º v22.6.0 æˆ–ä»¥ä¸Šã€‚è©³æƒ…è«‹åƒé–± Node.js æ–‡ä»¶ã€‚
:::

</TabItem>
</Tabs>

### å®‰è£ MCP SDK èˆ‡ç›¸ä¾å¥—ä»¶ (Install the MCP SDK and dependencies) \{#install-the-mcp-sdk-and-dependencies}

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```bash
pip install "mcp[cli]" starlette uvicorn
```

æˆ–ä½ åå¥½çš„å…¶ä»–å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œå¦‚ `uv` æˆ– `poetry`ã€‚

</TabItem>
<TabItem value="node" label="Node.js">

```bash
npm install @modelcontextprotocol/sdk express zod
```

æˆ–ä½ åå¥½çš„å…¶ä»–å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œå¦‚ `pnpm` æˆ– `yarn`ã€‚

</TabItem>
</Tabs>

### å»ºç«‹ MCP ä¼ºæœå™¨ (Create the MCP server) \{#create-the-mcp-server}

é¦–å…ˆï¼Œå»ºç«‹ä¸€å€‹åŸºæœ¬çš„ MCP ä¼ºæœå™¨ä¸¦å®šç¾©å·¥å…·ï¼š

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

å»ºç«‹ `todo-manager.py` æª”æ¡ˆä¸¦åŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š

```python
from typing import Any
from mcp.server.fastmcp import FastMCP
from starlette.applications import Starlette
from starlette.routing import Mount

mcp = FastMCP("Todo Manager")

@mcp.tool()
def create_todo(content: str) -> dict[str, Any]:
    """Create a new todo."""
    return {"error": "Not implemented"}

@mcp.tool()
def get_todos() -> dict[str, Any]:
    """List all todos."""
    return {"error": "Not implemented"}

@mcp.tool()
def delete_todo(id: str) -> dict[str, Any]:
    """Delete a todo by id."""
    return {"error": "Not implemented"}

app = Starlette(
    routes=[Mount('/', app=mcp.sse_app())]
)
```

å•Ÿå‹•ä¼ºæœå™¨ï¼š

```bash
uvicorn todo_manager:app --host 0.0.0.0 --port 3001
```

</TabItem>
<TabItem value="node" label="Node.js">

:::note
ç›®å‰ MCP inspector å°šæœªæ”¯æ´æˆæ¬Šæµç¨‹ï¼Œå› æ­¤æˆ‘å€‘æ¡ç”¨ SSE æ–¹å¼è¨­å®š MCP ä¼ºæœå™¨ã€‚å¾… MCP inspector æ”¯æ´æˆæ¬Šæµç¨‹å¾Œæœƒæ›´æ–°æ­¤è™•ç¨‹å¼ç¢¼ã€‚
:::

ä½ ä¹Ÿå¯ä»¥ç”¨ `pnpm` æˆ– `yarn`ã€‚

å»ºç«‹ `todo-manager.ts` æª”æ¡ˆä¸¦åŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š

```ts
// todo-manager.ts

import { z } from 'zod';
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { SSEServerTransport } from '@modelcontextprotocol/sdk/server/sse.js';
import express from 'express';

// å»ºç«‹ MCP ä¼ºæœå™¨
const server = new McpServer({
  name: 'Todo Manager',
  version: '0.0.0',
});

server.tool('create-todo', 'Create a new todo', { content: z.string() }, async ({ content }) => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

server.tool('get-todos', 'List all todos', async () => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

server.tool('delete-todo', 'Delete a todo by id', { id: z.string() }, async ({ id }) => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

// ä»¥ä¸‹ç‚º MCP SDK æ–‡ä»¶ç¯„ä¾‹æ¨£æ¿
const PORT = 3001;
const app = express();

const transports = {};

app.get('/sse', async (_req, res) => {
  const transport = new SSEServerTransport('/messages', res);
  transports[transport.sessionId] = transport;

  res.on('close', () => {
    delete transports[transport.sessionId];
  });

  await server.connect(transport);
});

app.post('/messages', async (req, res) => {
  const sessionId = String(req.query.sessionId);
  const transport = transports[sessionId];
  if (transport) {
    await transport.handlePostMessage(req, res, req.body);
  } else {
    res.status(400).send('No transport found for sessionId');
  }
});

app.listen(PORT);
```

å•Ÿå‹•ä¼ºæœå™¨ï¼š

```bash
npm start
```

</TabItem>
</Tabs>

## æª¢æŸ¥ MCP ä¼ºæœå™¨ (Inspect the MCP server) \{#inspect-the-mcp-server}

### è¤‡è£½ä¸¦åŸ·è¡Œ MCP inspector \{#clone-and-run-mcp-inspector}

ç¾åœ¨ MCP ä¼ºæœå™¨å·²å•Ÿå‹•ï¼Œå¯ä»¥ç”¨ MCP inspector æª¢æŸ¥ `whoami` å·¥å…·æ˜¯å¦å¯ç”¨ã€‚

ç”±æ–¼ç¾æœ‰å¯¦ä½œé™åˆ¶ï¼Œæˆ‘å€‘ fork äº† [MCP inspector](https://github.com/mcp-auth/inspector) ä»¥æå‡å…¶å½ˆæ€§èˆ‡å¯æ“´å±•æ€§ï¼Œä¸¦å·²å‘åŸå°ˆæ¡ˆæäº¤ PRã€‚

åŸ·è¡Œ MCP inspectorï¼š

```bash
git clone https://github.com/mcp-auth/inspector.git
cd inspector
npm install
npm run dev
```

ç„¶å¾Œåœ¨ç€è¦½å™¨é–‹å•Ÿ `http://localhost:6274/`ï¼ˆæˆ–çµ‚ç«¯æ©Ÿé¡¯ç¤ºçš„å…¶ä»–ç¶²å€ï¼‰å³å¯å­˜å– MCP inspectorã€‚

### é€£æ¥ MCP inspector èˆ‡ MCP ä¼ºæœå™¨ \{#connect-mcp-inspector-to-the-mcp-server}

ç¹¼çºŒå‰è«‹æª¢æŸ¥ MCP inspector è¨­å®šï¼š

- **Transport Type**ï¼šè¨­ç‚º `SSE`
- **URL**ï¼šè¨­ç‚º MCP ä¼ºæœå™¨çš„ URLï¼Œæœ¬ä¾‹ç‚º `http://localhost:3001/sse`

ç¾åœ¨é»æ“Šã€ŒConnectã€æŒ‰éˆ•ï¼Œæª¢æŸ¥ MCP inspector æ˜¯å¦èƒ½é€£ä¸Š MCP ä¼ºæœå™¨ã€‚è‹¥ä¸€åˆ‡æ­£å¸¸ï¼Œæ‡‰æœƒçœ‹åˆ° MCP inspector é¡¯ç¤ºã€ŒConnectedã€ç‹€æ…‹ã€‚

### æª¢æŸ¥é»ï¼šåŸ·è¡Œ todo manager å·¥å…· \{#checkpoint-run-todo-manager-tools}

1. åœ¨ MCP inspector é ‚éƒ¨é¸å–®é»é¸ã€ŒToolsã€åˆ†é 
2. é»æ“Šã€ŒList Toolsã€æŒ‰éˆ•
3. æ‡‰æœƒçœ‹åˆ° `create-todo`ã€`get-todos`ã€`delete-todo` å·¥å…·åˆ—æ–¼é é¢ï¼Œé»æ“Šå¯æª¢è¦–å·¥å…·è©³æƒ…
4. å³å´æœƒæœ‰ã€ŒRun Toolã€æŒ‰éˆ•ï¼Œé»æ“Šä¸¦è¼¸å…¥å¿…è¦åƒæ•¸åŸ·è¡Œå·¥å…·
5. æ‡‰æœƒçœ‹åˆ°å·¥å…·å›å‚³çµæœç‚º `{"error": "Not implemented"}` çš„ JSON

![MCP inspector é¦–æ¬¡åŸ·è¡Œç•«é¢](/docs-assets/images/tutorials/todo-manager/inspector-first-run.png)

## èˆ‡æˆæ¬Šä¼ºæœå™¨æ•´åˆ (Integrate with your authorization server) \{#integrate-with-your-authorization-server}

å®Œæˆæœ¬ç¯€éœ€è€ƒæ…®ä»¥ä¸‹å¹¾é»ï¼š

<details>
<summary>**ä½ çš„æˆæ¬Šä¼ºæœå™¨çš„ç°½ç™¼è€… (Issuer) URL**</summary>

é€šå¸¸æ˜¯æˆæ¬Šä¼ºæœå™¨çš„åŸºç¤ç¶²å€ï¼Œå¦‚ `https://auth.example.com`ã€‚æœ‰äº›æä¾›è€…å¯èƒ½æœƒæ˜¯ `https://example.logto.app/oidc` é€™é¡è·¯å¾‘ï¼Œè«‹æŸ¥é–±æä¾›è€…æ–‡ä»¶ã€‚

</details>

<details>
<summary>**å¦‚ä½•å–å¾—æˆæ¬Šä¼ºæœå™¨ metadata**</summary>

- è‹¥ä½ çš„æˆæ¬Šä¼ºæœå™¨ç¬¦åˆ [OAuth 2.0 Authorization Server Metadata](https://datatracker.ietf.org/doc/html/rfc8414) æˆ– [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html)ï¼Œå¯ç”¨ MCP Auth å…§å»ºå·¥å…·è‡ªå‹•æŠ“å– metadataã€‚
- è‹¥ä¸ç¬¦åˆï¼Œéœ€æ‰‹å‹•æŒ‡å®š metadata URL æˆ–ç«¯é»æ–¼ MCP ä¼ºæœå™¨è¨­å®šï¼Œè«‹æŸ¥é–±æä¾›è€…æ–‡ä»¶ã€‚

</details>

<details>
<summary>**å¦‚ä½•å°‡ MCP inspector è¨»å†Šç‚ºæˆæ¬Šä¼ºæœå™¨ç”¨æˆ¶ç«¯**</summary>

- è‹¥æˆæ¬Šä¼ºæœå™¨æ”¯æ´ [Dynamic Client Registration](https://datatracker.ietf.org/doc/html/rfc7591)ï¼ŒMCP inspector æœƒè‡ªå‹•è¨»å†Šç‚ºç”¨æˆ¶ç«¯ï¼Œå¯ç•¥éæ­¤æ­¥é©Ÿã€‚
- è‹¥ä¸æ”¯æ´ï¼Œéœ€æ‰‹å‹•å°‡ MCP inspector è¨»å†Šç‚ºç”¨æˆ¶ç«¯ã€‚

</details>

<details>
<summary>**ç­è§£æ¬Šæ–è«‹æ±‚åƒæ•¸**</summary>

å‘ä¸åŒæˆæ¬Šä¼ºæœå™¨è«‹æ±‚å­˜å–æ¬Šæ–æ™‚ï¼ŒæŒ‡å®šç›®æ¨™è³‡æºèˆ‡æ¬Šé™çš„æ–¹å¼å¯èƒ½ä¸åŒï¼Œä¸»è¦æœ‰ï¼š

- **åŸºæ–¼è³‡æºæ¨™ç¤ºç¬¦ (Resource indicator based)**ï¼š

  - ä½¿ç”¨ `resource` åƒæ•¸æŒ‡å®šç›®æ¨™ APIï¼ˆåƒè¦‹ [RFC 8707: Resource Indicators for OAuth 2.0](https://datatracker.ietf.org/doc/html/rfc8707)ï¼‰
  - ç¾ä»£ OAuth 2.0 å¸¸è¦‹
  - ç¯„ä¾‹è«‹æ±‚ï¼š
    ```json
    {
      "resource": "https://todo.mcp-server.app",
      "scope": "create:todos read:todos"
    }
    ```
  - ä¼ºæœå™¨æœƒç°½ç™¼å°ˆå±¬æ–¼è©²è³‡æºçš„æ¬Šæ–

- **åŸºæ–¼å—çœ¾ (Audience based)**ï¼š

  - ä½¿ç”¨ `audience` åƒæ•¸æŒ‡å®šæ¬Šæ–é æœŸæ¥æ”¶è€…
  - èˆ‡è³‡æºæ¨™ç¤ºç¬¦é¡ä¼¼ä½†èªæ„ä¸åŒ
  - ç¯„ä¾‹è«‹æ±‚ï¼š
    ```json
    {
      "audience": "todo-api",
      "scope": "create:todos read:todos"
    }
    ```

- **ç´”æ¬Šé™ç¯„åœ (Pure scope based)**ï¼š
  - åƒ…ä¾ scopesï¼Œä¸å¸¶ resource/audience åƒæ•¸
  - å‚³çµ± OAuth 2.0 ä½œæ³•
  - ç¯„ä¾‹è«‹æ±‚ï¼š
    ```json
    {
      "scope": "todo-api:create todo-api:read openid profile"
    }
    ```
  - å¸¸ç”¨å‰ç¶´å‘½åç©ºé–“æ¬Šé™
  - ç°¡å–® OAuth 2.0 å¸¸è¦‹

:::tip æœ€ä½³å¯¦è¸ (Best Practices)

- æŸ¥é–±æä¾›è€…æ–‡ä»¶ç¢ºèªæ”¯æ´å“ªäº›åƒæ•¸
- æœ‰äº›æä¾›è€…åŒæ™‚æ”¯æ´å¤šç¨®æ–¹å¼
- è³‡æºæ¨™ç¤ºç¬¦å¯æå‡å®‰å…¨æ€§ï¼ˆé™åˆ¶å—çœ¾ï¼‰
- å»ºè­°æœ‰æ”¯æ´æ™‚å„ªå…ˆæ¡ç”¨è³‡æºæ¨™ç¤ºç¬¦
  :::

</details>

æ¯å€‹æä¾›è€…ç´°ç¯€ä¸åŒï¼Œä»¥ä¸‹æ­¥é©Ÿå¯å”åŠ©ä½ ä¾æä¾›è€…è¨­å®š MCP inspector èˆ‡ MCP ä¼ºæœå™¨ã€‚

### è¨»å†Š MCP inspector ç‚ºç”¨æˆ¶ç«¯ \{#register-mcp-inspector-as-a-client}

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

å°‡ todo manager èˆ‡ [Logto](https://logto.io) æ•´åˆå¾ˆç°¡å–®ï¼Œå› ç‚ºå®ƒæ˜¯æ”¯æ´è³‡æºæ¨™ç¤ºç¬¦èˆ‡æ¬Šé™ç¯„åœçš„ OpenID Connect æä¾›è€…ï¼Œå¯ç”¨ `https://todo.mcp-server.app` ä½œç‚ºè³‡æºæ¨™ç¤ºç¬¦ä¿è­· todo APIã€‚

Logto å°šæœªæ”¯æ´ Dynamic Client Registrationï¼Œå› æ­¤éœ€æ‰‹å‹•å°‡ MCP inspector è¨»å†Šç‚ºç”¨æˆ¶ç«¯ï¼š

1. é–‹å•Ÿ MCP inspectorï¼Œé»æ“Šã€ŒOAuth Configurationã€æŒ‰éˆ•ï¼Œè¤‡è£½ **Redirect URL (auto-populated)**ï¼Œæ‡‰é¡ä¼¼ `http://localhost:6274/oauth/callback`
2. ç™»å…¥ [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ¶ Logto Consoleï¼‰
3. å‰å¾€ã€Œæ‡‰ç”¨ç¨‹å¼ (Applications)ã€åˆ†é ï¼Œé»æ“Šã€Œå»ºç«‹æ‡‰ç”¨ç¨‹å¼ (Create application)ã€ï¼Œé é¢åº•éƒ¨é»ã€ŒCreate app without frameworkã€
4. å¡«å¯«æ‡‰ç”¨ç¨‹å¼è³‡è¨Šå¾Œé»ã€Œå»ºç«‹æ‡‰ç”¨ç¨‹å¼ (Create application)ã€ï¼š
   - **é¸æ“‡æ‡‰ç”¨ç¨‹å¼é¡å‹**ï¼šé¸ã€Œå–®é æ‡‰ç”¨ç¨‹å¼ (Single-page application)ã€
   - **æ‡‰ç”¨ç¨‹å¼åç¨±**ï¼šå¦‚ã€ŒMCP Inspectorã€
5. åœ¨ã€Œè¨­å®š / Redirect URIsã€å€å¡Šè²¼ä¸Šå‰›æ‰è¤‡è£½çš„ Redirect URLï¼Œç„¶å¾Œé»åº•éƒ¨ã€Œå„²å­˜è®Šæ›´ (Save changes)ã€
6. é ‚éƒ¨å¡ç‰‡æœƒé¡¯ç¤ºã€ŒApp IDã€ï¼Œè¤‡è£½å®ƒ
7. å›åˆ° MCP inspectorï¼Œå°‡ã€ŒApp IDã€è²¼åˆ°ã€ŒOAuth Configurationã€çš„ã€ŒClient IDã€
8. åœ¨ã€ŒAuth Paramsã€æ¬„ä½è¼¸å…¥ `{"scope": "create:todos read:todos delete:todos", "resource": "https://todo.mcp-server.app"}`ï¼Œç¢ºä¿ Logto å›å‚³çš„å­˜å–æ¬Šæ–åŒ…å«å­˜å– todo manager æ‰€éœ€çš„æ¬Šé™ç¯„åœ

</TabItem>
<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

:::note
é€™æ˜¯é€šç”¨ OAuth 2.0 / OpenID Connect æä¾›è€…æ•´åˆæŒ‡å¼•ã€‚å…©è€…æ­¥é©Ÿé¡ä¼¼ï¼Œå›  OIDC å»ºç«‹æ–¼ OAuth 2.0 ä¹‹ä¸Šã€‚è«‹æŸ¥é–±ä½ çš„æä¾›è€…æ–‡ä»¶ä»¥ç²å¾—ç´°ç¯€ã€‚
:::

è‹¥ä½ çš„æä¾›è€…æ”¯æ´ Dynamic Client Registrationï¼Œå¯ç›´æ¥è·³åˆ°ç¬¬ 8 æ­¥è¨­å®š MCP inspectorï¼›å¦å‰‡éœ€æ‰‹å‹•è¨»å†Š MCP inspector ç‚ºç”¨æˆ¶ç«¯ï¼š

1. é–‹å•Ÿ MCP inspectorï¼Œé»æ“Šã€ŒOAuth Configurationã€æŒ‰éˆ•ï¼Œè¤‡è£½ **Redirect URL (auto-populated)**ï¼Œæ‡‰é¡ä¼¼ `http://localhost:6274/oauth/callback`

2. ç™»å…¥ä½ çš„æä¾›è€…ç®¡ç†å¾Œå°

3. å‰å¾€ã€Œæ‡‰ç”¨ç¨‹å¼ (Applications)ã€æˆ–ã€Œç”¨æˆ¶ç«¯ (Clients)ã€å€å¡Šï¼Œå»ºç«‹æ–°æ‡‰ç”¨ç¨‹å¼æˆ–ç”¨æˆ¶ç«¯

4. è‹¥éœ€é¸æ“‡ç”¨æˆ¶ç«¯é¡å‹ï¼Œè«‹é¸ã€Œå–®é æ‡‰ç”¨ç¨‹å¼ (Single-page application)ã€æˆ–ã€Œå…¬é–‹ç”¨æˆ¶ç«¯ (Public client)ã€

5. å»ºç«‹æ‡‰ç”¨ç¨‹å¼å¾Œï¼Œéœ€è¨­å®š redirect URIï¼Œè²¼ä¸Šå‰›æ‰è¤‡è£½çš„ Redirect URL

6. æ‰¾åˆ°æ–°æ‡‰ç”¨ç¨‹å¼çš„ã€ŒClient IDã€æˆ–ã€ŒApplication IDã€ä¸¦è¤‡è£½

7. å›åˆ° MCP inspectorï¼Œå°‡ã€ŒClient IDã€è²¼åˆ°ã€ŒOAuth Configurationã€çš„ã€ŒClient IDã€

8. åœ¨ã€ŒAuth Paramsã€æ¬„ä½è¼¸å…¥ä»¥ä¸‹å…§å®¹ä»¥è«‹æ±‚ todo æ“ä½œæ‰€éœ€æ¬Šé™ç¯„åœï¼š

```json
{ "scope": "create:todos read:todos delete:todos" }
```

</TabItem>
</Tabs>

### è¨­å®š MCP Auth \{#set-up-mcp-auth}

åœ¨ MCP ä¼ºæœå™¨å°ˆæ¡ˆä¸­ï¼Œéœ€å®‰è£ MCP Auth SDK ä¸¦è¨­å®šä½¿ç”¨ä½ çš„æˆæ¬Šä¼ºæœå™¨ metadataã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

å…ˆå®‰è£ `mcpauth` å¥—ä»¶ï¼š

```bash
pip install mcpauth
```

æˆ–ä½ åå¥½çš„å…¶ä»–å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œå¦‚ `uv` æˆ– `poetry`ã€‚

</TabItem>
<TabItem value="node" label="Node.js">

å…ˆå®‰è£ `mcp-auth` å¥—ä»¶ï¼š

```bash
npm install mcp-auth
```

</TabItem>
</Tabs>

MCP Auth éœ€è¦æˆæ¬Šä¼ºæœå™¨ metadata ä¾†åˆå§‹åŒ–ã€‚ä¾ä½ çš„æä¾›è€…è€Œå®šï¼š

<Tabs groupId="provider">

<TabItem value="logto" label="Logto">

ç°½ç™¼è€… (Issuer) URL å¯åœ¨ Logto Console æ‡‰ç”¨ç¨‹å¼è©³æƒ…é ã€ŒEndpoints & Credentials / Issuer endpointã€å€å¡Šæ‰¾åˆ°ï¼Œæ ¼å¼å¦‚ `https://my-project.logto.app/oidc`ã€‚

<SetupOidc />

</TabItem>

<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

å°æ–¼ OAuth 2.0 æä¾›è€…ï¼Œä½ éœ€è¦ï¼š

1. æŸ¥é–±æä¾›è€…æ–‡ä»¶å–å¾—æˆæ¬Šä¼ºæœå™¨ URLï¼ˆå¸¸ç¨± issuer URL æˆ– base URLï¼‰
2. æœ‰äº›æä¾›è€…æœƒåœ¨ `https://{your-domain}/.well-known/oauth-authorization-server` æä¾›
3. ä¹Ÿå¯åœ¨ç®¡ç†å¾Œå° OAuth/API è¨­å®šä¸­æ‰¾åˆ°

<SetupOauthOrOidc />

</TabItem>

</Tabs>

<Tabs groupId="sdk">

<TabItem value="python" label="Python">

æ›´æ–° `todo-manager.py` åŠ å…¥ MCP Auth è¨­å®šï¼š

```python
from mcpauth import MCPAuth
from mcpauth.config import AuthServerType
from mcpauth.utils import fetch_server_config

auth_issuer = '<issuer-endpoint>'  # è«‹æ›¿æ›ç‚ºä½ çš„ issuer endpoint
auth_server_config = fetch_server_config(auth_issuer, type=AuthServerType.OIDC)
mcp_auth = MCPAuth(server=auth_server_config)
```

</TabItem>
<TabItem value="node" label="Node.js">

æ›´æ–° `todo-manager.ts` åŠ å…¥ MCP Auth è¨­å®šï¼š

```ts
// todo-manager.ts

import { MCPAuth, fetchServerConfig } from 'mcp-auth';

const authIssuer = '<issuer-endpoint>'; // è«‹æ›¿æ›ç‚ºä½ çš„ issuer endpoint
const mcpAuth = new MCPAuth({
  server: await fetchServerConfig(authIssuer, { type: 'oidc' }),
});
```

</TabItem>
</Tabs>

### æ›´æ–° MCP ä¼ºæœå™¨ (Update MCP server) \{#update-mcp-server}

å¿«å®Œæˆäº†ï¼ç¾åœ¨è¦æ›´æ–° MCP ä¼ºæœå™¨ï¼Œå¥—ç”¨ MCP Auth è·¯ç”±èˆ‡ä¸­ä»‹è»Ÿé«”ï¼Œä¸¦æ ¹æ“šä½¿ç”¨è€…æ¬Šé™ç¯„åœå¯¦ä½œ todo manager å·¥å…·çš„æ¬Šé™å­˜å–æ§åˆ¶ã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```python
@mcp.tool()
def create_todo(content: str) -> dict[str, Any]:
    """Create a new todo."""
    return (
        mcp_auth.auth_info.scopes
        if mcp_auth.auth_info # é€™æœƒç”± Bearer auth middleware å¡«å…¥
        else {"error": "Not authenticated"}
    )

# ...

bearer_auth = Middleware(mcp_auth.bearer_auth_middleware("jwt"))
app = Starlette(
    routes=[
        # åŠ å…¥ metadata è·¯ç”± (`/.well-known/oauth-authorization-server`)
        mcp_auth.metadata_route(),
        # ç”¨ Bearer auth middleware ä¿è­· MCP ä¼ºæœå™¨
        Mount('/', app=mcp.sse_app(), middleware=[bearer_auth]),
    ],
)
```

</TabItem>
<TabItem value="node" label="Node.js">

```js
server.tool(
  'create-todo',
  'Create a new todo',
  { content: z.string() },
  async ({ content, authInfo }) => {
    return {
      content: [
        { type: 'text', text: JSON.stringify(authInfo?.scopes ?? { error: 'Not authenticated' }) },
      ],
    };
  }
);

// ...

app.use(mcpAuth.delegatedRouter());
app.use(mcpAuth.bearerAuth('jwt'));
```

</TabItem>
</Tabs>

æ¥ä¸‹ä¾†å¯¦ä½œå…·é«”å·¥å…·ã€‚

é¦–å…ˆå»ºç«‹ä¸€å€‹ç°¡å–®çš„ todo æœå‹™ï¼Œæä¾›è¨˜æ†¶é«”å…§çš„ CRUD æ“ä½œã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">
```python
# service.py

"""
ç°¡æ˜“ Todo æœå‹™ï¼Œåƒ…ä¾›ç¤ºç¯„ã€‚
ä»¥è¨˜æ†¶é«”æ¸…å–®å„²å­˜ todosã€‚
"""

from datetime import datetime
from typing import List, Optional, Dict, Any
import random
import string

class Todo:
"""ä»£è¡¨ä¸€å€‹ todo é …ç›®ã€‚"""

    def __init__(self, id: str, content: str, owner_id: str, created_at: str):
        self.id = id
        self.content = content
        self.owner_id = owner_id
        self.created_at = created_at

    def to_dict(self) -> Dict[str, Any]:
        """è½‰æ›ç‚º dict ä»¥ä¾¿ JSON åºåˆ—åŒ–ã€‚"""
        return {
            "id": self.id,
            "content": self.content,
            "ownerId": self.owner_id,
            "createdAt": self.created_at
        }

class TodoService:
"""ç°¡æ˜“ Todo æœå‹™ï¼Œåƒ…ä¾›ç¤ºç¯„ã€‚"""

    def __init__(self):
        self._todos: List[Todo] = []

    def get_all_todos(self, owner_id: Optional[str] = None) -> List[Dict[str, Any]]:
        """
        å–å¾—æ‰€æœ‰ todosï¼Œå¯é¸æ“‡ä¾ owner_id éæ¿¾ã€‚

        Args:
            owner_id: è‹¥æœ‰ï¼Œåƒ…å›å‚³è©²ä½¿ç”¨è€…çš„ todos

        Returns:
            todo dict æ¸…å–®
        """
        if owner_id:
            filtered_todos = [todo for todo in self._todos if todo.owner_id == owner_id]
            return [todo.to_dict() for todo in filtered_todos]
        return [todo.to_dict() for todo in self._todos]

    def get_todo_by_id(self, todo_id: str) -> Optional[Todo]:
        """
        ä¾ ID å–å¾— todoã€‚

        Args:
            todo_id: æ¬²å–å¾—çš„ todo ID

        Returns:
            æ‰¾åˆ°å‰‡å›å‚³ Todo ç‰©ä»¶ï¼Œå¦å‰‡ None
        """
        for todo in self._todos:
            if todo.id == todo_id:
                return todo
        return None

    def create_todo(self, content: str, owner_id: str) -> Dict[str, Any]:
        """
        å»ºç«‹æ–° todoã€‚

        Args:
            content: todo å…§å®¹
            owner_id: æ“æœ‰è€… ID

        Returns:
            å»ºç«‹çš„ todo dict
        """
        todo = Todo(
            id=self._generate_id(),
            content=content,
            owner_id=owner_id,
            created_at=datetime.now().isoformat()
        )
        self._todos.append(todo)
        return todo.to_dict()

    def delete_todo(self, todo_id: str) -> Optional[Dict[str, Any]]:
        """
        ä¾ ID åˆªé™¤ todoã€‚

        Args:
            todo_id: æ¬²åˆªé™¤çš„ todo ID

        Returns:
            è‹¥æ‰¾åˆ°å‰‡å›å‚³è¢«åˆªé™¤çš„ todo dictï¼Œå¦å‰‡ None
        """
        for i, todo in enumerate(self._todos):
            if todo.id == todo_id:
                deleted_todo = self._todos.pop(i)
                return deleted_todo.to_dict()
        return None

    def _generate_id(self) -> str:
        """ç”¢ç”Ÿéš¨æ©Ÿ todo IDã€‚"""
        return ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))

````


</TabItem>
<TabItem value="node" label="Node.js">

```ts
// todo-service.ts

type Todo = {
  id: string;
  content: string;
  ownerId: string;
  createdAt: string;
};

/**
 * ç°¡æ˜“ Todo æœå‹™ï¼Œåƒ…ä¾›ç¤ºç¯„ã€‚
 * ä»¥è¨˜æ†¶é«”é™£åˆ—å„²å­˜ todos
 */
export class TodoService {
  private readonly todos: Todo[] = [];

  getAllTodos(ownerId?: string): Todo[] {
    if (ownerId) {
      return this.todos.filter((todo) => todo.ownerId === ownerId);
    }
    return this.todos;
  }

  getTodoById(id: string): Todo | undefined {
    return this.todos.find((todo) => todo.id === id);
  }

  createTodo({ content, ownerId }: { content: string; ownerId: string }): Todo {
    const todo: Todo = {
      id: this.genId(),
      content,
      ownerId,
      createdAt: new Date().toISOString(),
    };

    // eslint-disable-next-line @silverhand/fp/no-mutating-methods
    this.todos.push(todo);
    return todo;
  }

  deleteTodo(id: string): Todo | undefined {
    const index = this.todos.findIndex((todo) => todo.id === id);

    if (index === -1) {
      return undefined;
    }

    // eslint-disable-next-line @silverhand/fp/no-mutating-methods
    const [deleted] = this.todos.splice(index, 1);
    return deleted;
  }

  private genId(): string {
    return Math.random().toString(36).slice(2, 10);
  }
}
````

</TabItem>
</Tabs>

ç„¶å¾Œåœ¨å·¥å…·å±¤æ ¹æ“šä½¿ç”¨è€…æ¬Šé™ç¯„åœåˆ¤æ–·æ˜¯å¦å…è¨±æ“ä½œï¼š

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```python
# todo-manager.py

from typing import Any, Optional
from mcpauth.errors import MCPAuthBearerAuthError

def assert_user_id(auth_info: Optional[dict]) -> str:
    """å¾ auth info æ“·å–ä¸¦é©—è­‰ user IDã€‚"""
    subject = auth_info.get('subject') if auth_info else None
    if not subject:
        raise ValueError('Invalid auth info')
    return subject

def has_required_scopes(user_scopes: list[str], required_scopes: list[str]) -> bool:
    """æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æ“æœ‰æ‰€æœ‰å¿…è¦æ¬Šé™ç¯„åœã€‚"""
    return all(scope in user_scopes for scope in required_scopes)

# å»ºç«‹ TodoService å¯¦ä¾‹
todo_service = TodoService()

@mcp.tool()
def create_todo(content: str) -> dict[str, Any]:
    """å»ºç«‹æ–° todoã€‚

    åªæœ‰æ“æœ‰ 'create:todos' æ¬Šé™ç¯„åœçš„ä½¿ç”¨è€…æ‰èƒ½å»ºç«‹ todoã€‚
    """
    # å–å¾—é©—è­‰è³‡è¨Š
    auth_info = mcp_auth.auth_info

    # é©—è­‰ user ID
    try:
        user_id = assert_user_id(auth_info)
    except ValueError as e:
        return {"error": str(e)}

    # æª¢æŸ¥æ˜¯å¦æœ‰å¿…è¦æ¬Šé™
    if not has_required_scopes(auth_info.scopes if auth_info else [], ['create:todos']):
        raise MCPAuthBearerAuthError('missing_required_scopes')

    # å»ºç«‹æ–° todo
    created_todo = todo_service.create_todo(content=content, owner_id=user_id)

    # å›å‚³å»ºç«‹çš„ todo
    return created_todo.__dict__

# ...
```

ä½ å¯ä»¥åƒè€ƒæˆ‘å€‘çš„ [ç¯„ä¾‹ç¨‹å¼ç¢¼](https://github.com/mcp-auth/python/tree/master/samples/server) å–å¾—å®Œæ•´å¯¦ä½œã€‚

</TabItem>
<TabItem value="node" label="Node.js">

```ts
// todo-manager.ts

// ... å…¶ä»– import
import assert from 'node:assert';
import { type AuthInfo } from '@modelcontextprotocol/sdk/server/auth/types.js';
import { TodoService } from './todo-service.js';

const todoService = new TodoService();

const assertUserId = (authInfo?: AuthInfo) => {
  const { subject } = authInfo ?? {};
  assert(subject, 'Invalid auth info');
  return subject;
};

/**
 * æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æ“æœ‰æ‰€æœ‰å¿…è¦æ¬Šé™ç¯„åœ
 */
const hasRequiredScopes = (userScopes: string[], requiredScopes: string[]): boolean => {
  return requiredScopes.every((scope) => userScopes.includes(scope));
};

server.tool(
  'create-todo',
  'Create a new todo',
  { content: z.string() },
  ({ content }: { content: string }, { authInfo }) => {
    const userId = assertUserId(authInfo);

    /**
     * åªæœ‰æ“æœ‰ 'create:todos' æ¬Šé™ç¯„åœçš„ä½¿ç”¨è€…æ‰èƒ½å»ºç«‹ todo
     */
    if (!hasRequiredScopes(authInfo?.scopes ?? [], ['create:todos'])) {
      throw new MCPAuthBearerAuthError('missing_required_scopes');
    }

    const createdTodo = todoService.createTodo({ content, ownerId: userId });

    return {
      content: [{ type: 'text', text: JSON.stringify(createdTodo) }],
    };
  }
);

// ...
```

ä½ å¯ä»¥åƒè€ƒæˆ‘å€‘çš„ [ç¯„ä¾‹ç¨‹å¼ç¢¼](https://github.com/mcp-auth/js/tree/master/packages/sample-servers/src/todo-manager) å–å¾—å®Œæ•´å¯¦ä½œã€‚

</TabItem>
</Tabs>

## æª¢æŸ¥é»ï¼šåŸ·è¡Œ `todo-manager` å·¥å…· \{#checkpoint-run-the-todo-manager-tools}

é‡å•Ÿ MCP ä¼ºæœå™¨ä¸¦åœ¨ç€è¦½å™¨é–‹å•Ÿ MCP inspectorã€‚é»æ“Šã€ŒConnectã€å¾Œï¼Œæ‡‰æœƒè¢«å°å‘æˆæ¬Šä¼ºæœå™¨ç™»å…¥é ã€‚

ç™»å…¥ä¸¦è¿”å› MCP inspector å¾Œï¼Œé‡è¤‡å‰è¿°æ­¥é©ŸåŸ·è¡Œ todo manager å·¥å…·ã€‚é€™æ¬¡ä½ å°‡ä»¥å·²é©—è­‰çš„ä½¿ç”¨è€…èº«åˆ†æ“ä½œï¼Œå·¥å…·è¡Œç‚ºæœƒä¾ä½ è¢«æŒ‡æ´¾çš„è§’è‰²èˆ‡æ¬Šé™è€Œç•°ï¼š

- è‹¥ä»¥ **User**ï¼ˆåƒ…æœ‰ `create:todos` æ¬Šé™ç¯„åœï¼‰ç™»å…¥ï¼š

  - å¯ç”¨ `create-todo` å·¥å…·å»ºç«‹æ–°å¾…è¾¦äº‹é …
  - åªèƒ½æª¢è¦–èˆ‡åˆªé™¤è‡ªå·±çš„å¾…è¾¦äº‹é …
  - ç„¡æ³•çœ‹åˆ°æˆ–åˆªé™¤å…¶ä»–ä½¿ç”¨è€…çš„å¾…è¾¦äº‹é …

- è‹¥ä»¥ **Admin**ï¼ˆæ“æœ‰æ‰€æœ‰æ¬Šé™ç¯„åœï¼š`create:todos`ã€`read:todos`ã€`delete:todos`ï¼‰ç™»å…¥ï¼š
  - å¯å»ºç«‹æ–°å¾…è¾¦äº‹é …
  - å¯ç”¨ `get-todos` å·¥å…·æª¢è¦–ç³»çµ±æ‰€æœ‰å¾…è¾¦äº‹é …
  - å¯ç”¨ `delete-todo` å·¥å…·åˆªé™¤ä»»ä½•å¾…è¾¦äº‹é …ï¼Œä¸è«–æ“æœ‰è€…

ä½ å¯ä»¥é€™æ¨£æ¸¬è©¦ä¸åŒæ¬Šé™å±¤ç´šï¼š

1. ç™»å‡ºç›®å‰æœƒè©±ï¼ˆé» MCP inspector çš„ã€ŒDisconnectã€ï¼‰
2. ä»¥ä¸åŒè§’è‰²ï¼æ¬Šé™çš„å¸³è™Ÿç™»å…¥
3. é‡è¤‡æ“ä½œè§€å¯Ÿå·¥å…·è¡Œç‚ºå¦‚ä½•éš¨ä½¿ç”¨è€…æ¬Šé™è®ŠåŒ–

é€™å±•ç¤ºäº†è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC) çš„å¯¦éš›é‹ä½œï¼Œä¸åŒä½¿ç”¨è€…å°ç³»çµ±åŠŸèƒ½æœ‰ä¸åŒå­˜å–å±¤ç´šã€‚

![MCP inspector todo manager å·¥å…·çµæœ](/docs-assets/images/tutorials/todo-manager/result.png)

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

:::info
å®Œæ•´ MCP ä¼ºæœå™¨ï¼ˆOIDC ç‰ˆï¼‰ç¨‹å¼ç¢¼è«‹åƒè€ƒ [MCP Auth Python SDK repository](https://github.com/mcp-auth/python/blob/master/samples/server/todo-manager/server.py)ã€‚
:::

</TabItem>
<TabItem value="node" label="Node.js">

:::info
å®Œæ•´ MCP ä¼ºæœå™¨ï¼ˆOIDC ç‰ˆï¼‰ç¨‹å¼ç¢¼è«‹åƒè€ƒ [MCP Auth Node.js SDK repository](https://github.com/mcp-auth/js/blob/master/packages/sample-servers/src)ã€‚
:::

</TabItem>
</Tabs>

## çµèª (Closing notes) \{#closing-notes}

ğŸŠ æ­å–œä½ ï¼å·²é †åˆ©å®Œæˆæœ¬æ•™å­¸ã€‚è®“æˆ‘å€‘å›é¡§ä¸€ä¸‹ï¼š

- å»ºç«‹å…·å‚™ todo ç®¡ç†å·¥å…·ï¼ˆ`create-todo`ã€`get-todos`ã€`delete-todo`ï¼‰çš„åŸºæœ¬ MCP ä¼ºæœå™¨
- å¯¦ä½œä¸åŒä½¿ç”¨è€…èˆ‡ç®¡ç†å“¡æ¬Šé™å±¤ç´šçš„è§’è‰²å‹å­˜å–æ§åˆ¶ (RBAC)
- é€é MCP Auth å°‡ MCP ä¼ºæœå™¨èˆ‡æˆæ¬Šä¼ºæœå™¨æ•´åˆ
- è¨­å®š MCP Inspector ä»¥é©—è­‰ä½¿ç”¨è€…ä¸¦ç”¨å¸¶æ¬Šé™ç¯„åœçš„å­˜å–æ¬Šæ–å‘¼å«å·¥å…·

æ­¡è¿åƒé–±å…¶ä»–æ•™å­¸èˆ‡æ–‡ä»¶ï¼Œå……åˆ†ç™¼æ® MCP Auth çš„å¼·å¤§åŠŸèƒ½ã€‚
