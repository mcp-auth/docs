---
sidebar_position: 2
sidebar_label: 'æ•™ç¨‹ï¼šæ„å»ºä¸€ä¸ªå¾…åŠäº‹é¡¹ç®¡ç†å™¨'
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';


# æ•™ç¨‹ï¼šæ„å»ºä¸€ä¸ªå¾…åŠäº‹é¡¹ç®¡ç†å™¨

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå¸¦æœ‰ç”¨æˆ·è®¤è¯ (Authentication) å’Œæˆæƒ (Authorization) çš„å¾…åŠäº‹é¡¹ç®¡ç†å™¨ MCP æœåŠ¡å™¨ã€‚æŒ‰ç…§æœ€æ–°çš„ MCP è§„èŒƒï¼Œæˆ‘ä»¬çš„ MCP æœåŠ¡å™¨å°†ä½œä¸º OAuth 2.0 **èµ„æºæœåŠ¡å™¨ (Resource Server)**ï¼Œç”¨äºéªŒè¯è®¿é—®ä»¤ç‰Œ (Access token) å¹¶å¼ºåˆ¶æ‰§è¡ŒåŸºäºæƒé™ (Scope) çš„æƒé™æ§åˆ¶ã€‚

å®Œæˆæœ¬æ•™ç¨‹åï¼Œä½ å°†è·å¾—ï¼š

- âœ… å¯¹å¦‚ä½•åœ¨ MCP æœåŠ¡å™¨ä¸­è®¾ç½®åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC) æœ‰åŸºæœ¬äº†è§£
- âœ… ä¸€ä¸ªä½œä¸ºèµ„æºæœåŠ¡å™¨ (Resource Server) çš„ MCP æœåŠ¡å™¨ï¼Œèƒ½å¤Ÿæ¶ˆè´¹ç”±æˆæƒæœåŠ¡å™¨ (Authorization Server) é¢å‘çš„è®¿é—®ä»¤ç‰Œ (Access token)
- âœ… ä¸€ä¸ªåŸºäºæƒé™ (Scope) çš„å¾…åŠäº‹é¡¹æ“ä½œæƒé™æ§åˆ¶çš„å®é™…å®ç°

## æ¦‚è§ˆ \{#overview}

æœ¬æ•™ç¨‹æ¶‰åŠä»¥ä¸‹ç»„ä»¶ï¼š

- **MCP å®¢æˆ·ç«¯ï¼ˆMCP Inspectorï¼‰**ï¼šä¸€ä¸ªç”¨äºæµ‹è¯• MCP æœåŠ¡å™¨çš„å¯è§†åŒ–å·¥å…·ï¼Œä½œä¸º OAuth 2.0/OIDC å®¢æˆ·ç«¯ã€‚å®ƒå‘èµ·ä¸æˆæƒæœåŠ¡å™¨çš„æˆæƒæµç¨‹ï¼Œå¹¶è·å–è®¿é—®ä»¤ç‰Œ (Access token) ä»¥è®¤è¯ (Authentication) å¯¹ MCP æœåŠ¡å™¨çš„è¯·æ±‚ã€‚
- **æˆæƒæœåŠ¡å™¨ (Authorization Server)**ï¼šä¸€ä¸ª OAuth 2.1 æˆ– OpenID Connect æä¾›å•†ï¼Œè´Ÿè´£ç®¡ç†ç”¨æˆ·èº«ä»½ã€è®¤è¯ (Authentication) ç”¨æˆ·ï¼Œå¹¶å‘æˆæƒå®¢æˆ·ç«¯é¢å‘å¸¦æœ‰ç›¸åº”æƒé™ (Scope) çš„è®¿é—®ä»¤ç‰Œ (Access token)ã€‚
- **MCP æœåŠ¡å™¨ï¼ˆèµ„æºæœåŠ¡å™¨ Resource Serverï¼‰**ï¼šæ ¹æ®æœ€æ–°çš„ MCP è§„èŒƒï¼ŒMCP æœåŠ¡å™¨åœ¨ OAuth 2.0 æ¡†æ¶ä¸­ä½œä¸ºèµ„æºæœåŠ¡å™¨ (Resource Server)ã€‚å®ƒéªŒè¯æˆæƒæœåŠ¡å™¨é¢å‘çš„è®¿é—®ä»¤ç‰Œ (Access token)ï¼Œå¹¶å¯¹å¾…åŠäº‹é¡¹æ“ä½œå¼ºåˆ¶æ‰§è¡ŒåŸºäºæƒé™ (Scope) çš„æƒé™æ§åˆ¶ã€‚

è¯¥æ¶æ„éµå¾ªæ ‡å‡†çš„ OAuth 2.0 æµç¨‹ï¼š

- **MCP Inspector** ä»£è¡¨ç”¨æˆ·è¯·æ±‚å—ä¿æŠ¤èµ„æº
- **æˆæƒæœåŠ¡å™¨ (Authorization Server)** è®¤è¯ (Authentication) ç”¨æˆ·å¹¶é¢å‘è®¿é—®ä»¤ç‰Œ (Access token)
- **MCP æœåŠ¡å™¨** éªŒè¯ä»¤ç‰Œå¹¶æ ¹æ®æˆäºˆçš„æƒé™ (Scope) æä¾›å—ä¿æŠ¤èµ„æº

ä»¥ä¸‹æ˜¯è¿™äº›ç»„ä»¶ä¹‹é—´äº¤äº’çš„é«˜çº§æµç¨‹å›¾ï¼š

```mermaid
sequenceDiagram
  autonumber
  participant Client as MCP Inspector<br/>(OAuth å®¢æˆ·ç«¯)
  participant RS as MCP æœåŠ¡å™¨<br/>(èµ„æºæœåŠ¡å™¨ Resource Server)
  participant AS as æˆæƒæœåŠ¡å™¨ (Authorization Server)

  Client->>RS: MCP è¯·æ±‚ï¼ˆæ— ä»¤ç‰Œï¼‰
  RS-->>Client: 401 æœªæˆæƒ (WWW-Authenticate)
  Note over Client: ä» WWW-Authenticate å¤´ä¸­æå– resource_metadata URL

  Client->>RS: GET /.well-known/oauth-protected-resource (resource_metadata)
  RS-->>Client: å—ä¿æŠ¤èµ„æºå…ƒæ•°æ®<br/>(åŒ…å«æˆæƒæœåŠ¡å™¨ URL)

  Client->>AS: GET /.well-known/oauth-authorization-server
  AS-->>Client: æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®
  Client->>AS: OAuth æˆæƒï¼ˆç™»å½• & åŒæ„ï¼‰
  AS-->>Client: è®¿é—®ä»¤ç‰Œ (Access token)

  Client->>RS: MCP è¯·æ±‚ (Authorization: Bearer <token>)
  RS->>RS: éªŒè¯è®¿é—®ä»¤ç‰Œ (Access token) æ˜¯å¦æœ‰æ•ˆä¸”å·²æˆæƒ
  RS-->>Client: MCP å“åº”
```

## äº†è§£ä½ çš„æˆæƒæœåŠ¡å™¨ \{#understand-your-authorization-server}

### å¸¦æœ‰æƒé™ (Scope) çš„è®¿é—®ä»¤ç‰Œ (Access token) \{#access-tokens-with-scopes}

è¦åœ¨ MCP æœåŠ¡å™¨ä¸­å®ç°[åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)](https://auth.wiki/rbac)ï¼Œä½ çš„æˆæƒæœåŠ¡å™¨éœ€è¦æ”¯æŒé¢å‘å¸¦æœ‰æƒé™ (Scope) çš„è®¿é—®ä»¤ç‰Œ (Access token)ã€‚æƒé™ (Scope) ä»£è¡¨ç”¨æˆ·è¢«æˆäºˆçš„æƒé™ã€‚

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

[Logto](https://logto.io) é€šè¿‡å…¶ API èµ„æºï¼ˆç¬¦åˆ [RFC 8707: OAuth 2.0 çš„èµ„æºæŒ‡ç¤ºå™¨ Resource Indicator]ï¼‰å’Œè§’è‰² (Role) åŠŸèƒ½æä¾› RBAC æ”¯æŒã€‚è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š

1. ç™»å½• [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ‰˜ç®¡ Logto Consoleï¼‰

2. åˆ›å»º API èµ„æºå’Œæƒé™ (Scope)ï¼š

   - è¿›å…¥â€œAPI èµ„æºâ€
   - åˆ›å»ºä¸€ä¸ªåä¸ºâ€œTodo Managerâ€çš„æ–° API èµ„æº
   - æ·»åŠ ä»¥ä¸‹æƒé™ (Scope)ï¼š
     - `create:todos`ï¼šâ€œåˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹â€
     - `read:todos`ï¼šâ€œè¯»å–æ‰€æœ‰å¾…åŠäº‹é¡¹â€
     - `delete:todos`ï¼šâ€œåˆ é™¤ä»»æ„å¾…åŠäº‹é¡¹â€

3. åˆ›å»ºè§’è‰² (Role)ï¼ˆæ¨èï¼Œä¾¿äºç®¡ç†ï¼‰ï¼š

   - è¿›å…¥â€œè§’è‰² (Roles)â€
   - åˆ›å»ºä¸€ä¸ªâ€œAdminâ€è§’è‰²ï¼Œå¹¶åˆ†é…æ‰€æœ‰æƒé™ (`create:todos`, `read:todos`, `delete:todos`)
   - åˆ›å»ºä¸€ä¸ªâ€œUserâ€è§’è‰²ï¼Œä»…åˆ†é… `create:todos` æƒé™

4. åˆ†é…æƒé™ï¼š
   - è¿›å…¥â€œç”¨æˆ·â€
   - é€‰æ‹©ä¸€ä¸ªç”¨æˆ·
   - ä½ å¯ä»¥ï¼š
     - åœ¨â€œè§’è‰² (Roles)â€æ ‡ç­¾é¡µåˆ†é…è§’è‰²ï¼ˆæ¨èï¼‰
     - æˆ–ç›´æ¥åœ¨â€œæƒé™ (Permissions)â€æ ‡ç­¾é¡µåˆ†é…æƒé™ (Scope)

è¿™äº›æƒé™ (Scope) ä¼šä½œä¸ºç©ºæ ¼åˆ†éš”çš„å­—ç¬¦ä¸²åŒ…å«åœ¨ JWT è®¿é—®ä»¤ç‰Œ (Access token) çš„ `scope` å£°æ˜ (Claim) ä¸­ã€‚

</TabItem>
<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

OAuth 2.0 / OIDC æä¾›å•†é€šå¸¸æ”¯æŒåŸºäºæƒé™ (Scope) çš„è®¿é—®æ§åˆ¶ã€‚å®ç° RBAC æ—¶ï¼š

1. åœ¨æˆæƒæœåŠ¡å™¨ä¸­å®šä¹‰æ‰€éœ€çš„æƒé™ (Scope)
2. é…ç½®å®¢æˆ·ç«¯åœ¨æˆæƒæµç¨‹ä¸­è¯·æ±‚è¿™äº›æƒé™ (Scope)
3. ç¡®ä¿æˆæƒæœåŠ¡å™¨åœ¨è®¿é—®ä»¤ç‰Œ (Access token) ä¸­åŒ…å«æˆäºˆçš„æƒé™ (Scope)
4. æƒé™ (Scope) é€šå¸¸åŒ…å«åœ¨ JWT è®¿é—®ä»¤ç‰Œ (Access token) çš„ `scope` å£°æ˜ (Claim) ä¸­

è¯·æŸ¥é˜…ä½ çš„æä¾›å•†æ–‡æ¡£ï¼Œäº†è§£ï¼š

- å¦‚ä½•å®šä¹‰å’Œç®¡ç†æƒé™ (Scope)
- æƒé™ (Scope) å¦‚ä½•åŒ…å«åœ¨è®¿é—®ä»¤ç‰Œ (Access token) ä¸­
- æ˜¯å¦æœ‰é¢å¤–çš„ RBAC åŠŸèƒ½ï¼Œå¦‚è§’è‰² (Role) ç®¡ç†

</TabItem>
</Tabs>

### éªŒè¯ä»¤ç‰Œå¹¶æ£€æŸ¥æƒé™ \{#validating-tokens-and-checking-permissions}

æ ¹æ®æœ€æ–°çš„ MCP è§„èŒƒï¼ŒMCP æœåŠ¡å™¨åœ¨ OAuth 2.0 æ¡†æ¶ä¸­ä½œä¸º**èµ„æºæœåŠ¡å™¨ (Resource Server)**ã€‚ä½œä¸ºèµ„æºæœåŠ¡å™¨ (Resource Server)ï¼ŒMCP æœåŠ¡å™¨æœ‰ä»¥ä¸‹èŒè´£ï¼š

1. **ä»¤ç‰ŒéªŒè¯**ï¼šéªŒè¯ä» MCP å®¢æˆ·ç«¯æ”¶åˆ°çš„è®¿é—®ä»¤ç‰Œ (Access token) çš„çœŸå®æ€§å’Œå®Œæ•´æ€§
2. **æƒé™ (Scope) å¼ºåˆ¶**ï¼šä»è®¿é—®ä»¤ç‰Œ (Access token) ä¸­æå–å¹¶éªŒè¯æƒé™ (Scope)ï¼Œä»¥ç¡®å®šå®¢æˆ·ç«¯è¢«æˆæƒæ‰§è¡Œå“ªäº›æ“ä½œ
3. **èµ„æºä¿æŠ¤**ï¼šä»…åœ¨å®¢æˆ·ç«¯æä¾›æœ‰æ•ˆä¸”æƒé™ (Scope) è¶³å¤Ÿçš„ä»¤ç‰Œæ—¶ï¼Œæ‰æä¾›å—ä¿æŠ¤èµ„æºï¼ˆæ‰§è¡Œå·¥å…·ï¼‰

å½“ MCP æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œä¼šæ‰§è¡Œå¦‚ä¸‹éªŒè¯æµç¨‹ï¼š

1. ä» `Authorization` å¤´ä¸­æå–è®¿é—®ä»¤ç‰Œ (Access token)ï¼ˆBearer token æ ¼å¼ï¼‰
2. éªŒè¯è®¿é—®ä»¤ç‰Œ (Access token) çš„ç­¾åå’Œè¿‡æœŸæ—¶é—´
3. ä»å·²éªŒè¯çš„ä»¤ç‰Œä¸­æå–æƒé™ (Scope) å’Œç”¨æˆ·ä¿¡æ¯
4. æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åŒ…å«æ‰€è¯·æ±‚æ“ä½œæ‰€éœ€çš„æƒé™ (Scope)

ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·æƒ³åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹ï¼Œå…¶è®¿é—®ä»¤ç‰Œ (Access token) å¿…é¡»åŒ…å« `create:todos` æƒé™ (Scope)ã€‚ä»¥ä¸‹æ˜¯èµ„æºæœåŠ¡å™¨ (Resource Server) éªŒè¯æµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant Client as MCP å®¢æˆ·ç«¯
    participant Server as MCP æœåŠ¡å™¨<br/>(èµ„æºæœåŠ¡å™¨ Resource Server)
    participant Auth as æˆæƒæœåŠ¡å™¨ (Authorization Server)

    Client->>Server: æºå¸¦è®¿é—®ä»¤ç‰Œçš„è¯·æ±‚<br/>(Authorization: Bearer <token>)

    alt JWT éªŒè¯ï¼ˆæ¨èï¼‰
        Server->>Auth: è·å– JWKSï¼ˆå¦‚æœªç¼“å­˜ï¼‰
        Auth-->>Server: è¿”å› JWKS
        Server->>Server: æœ¬åœ°éªŒè¯ JWT ç­¾åå’Œå£°æ˜ (Claim)
    else ä»¤ç‰Œè‡ªçœï¼ˆå¤‡ç”¨ï¼‰
        Server->>Auth: POST /introspect<br/>(token=access_token)
        Auth-->>Server: è¿”å›ä»¤ç‰Œä¿¡æ¯<br/>(active, scope, user_id ç­‰)
    end

    Server->>Server: ä»å·²éªŒè¯ä»¤ç‰Œä¸­æå–æƒé™ (Scope) å’Œç”¨æˆ·ä¸Šä¸‹æ–‡

    alt æ‹¥æœ‰æ‰€éœ€æƒé™ (Scope)
        Server->>Server: æ‰§è¡Œè¯·æ±‚çš„æ“ä½œ
        Server->>Client: è¿”å›æ“ä½œç»“æœ
    else ç¼ºå°‘æ‰€éœ€æƒé™ (Scope)
        Server->>Client: è¿”å› 403 Forbidden<br/>(insufficient_scope é”™è¯¯)
    end
```

### åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ \{#dynamic-client-registration}

æœ¬æ•™ç¨‹ä¸è¦æ±‚åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œï¼Œä½†å¦‚æœä½ æƒ³è‡ªåŠ¨åŒ– MCP å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹ï¼Œå¯ä»¥å‚è€ƒ [æ˜¯å¦éœ€è¦åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œï¼Ÿ](/provider-list#is-dcr-required) è·å–æ›´å¤šä¿¡æ¯ã€‚

## äº†è§£å¾…åŠäº‹é¡¹ç®¡ç†å™¨ä¸­çš„ RBAC \{#understand-rbac-in-todo-manager}

ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å°†åœ¨å¾…åŠäº‹é¡¹ç®¡ç†å™¨ MCP æœåŠ¡å™¨ä¸­å®ç°ä¸€ä¸ªç®€å•çš„åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC) ç³»ç»Ÿã€‚è¿™å°†å‘ä½ å±•ç¤º RBAC çš„åŸºæœ¬åŸç†ï¼ŒåŒæ—¶ä¿æŒå®ç°ç®€æ´ã€‚

:::note
è™½ç„¶æœ¬æ•™ç¨‹æ¼”ç¤ºäº†åŸºäº RBAC çš„æƒé™ (Scope) ç®¡ç†ï¼Œä½†éœ€è¦æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰è®¤è¯ (Authentication) æä¾›å•†éƒ½é€šè¿‡è§’è‰² (Role) å®ç°æƒé™ (Scope) ç®¡ç†ã€‚æœ‰äº›æä¾›å•†å¯èƒ½æœ‰è‡ªå·±ç‹¬ç‰¹çš„è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†æœºåˆ¶ã€‚
:::

### å·¥å…·ä¸æƒé™ (Scope) \{#tools-and-scopes}

æˆ‘ä»¬çš„å¾…åŠäº‹é¡¹ç®¡ç†å™¨ MCP æœåŠ¡å™¨æä¾›ä¸‰ä¸ªä¸»è¦å·¥å…·ï¼š

- `create-todo`ï¼šåˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹
- `get-todos`ï¼šåˆ—å‡ºæ‰€æœ‰å¾…åŠäº‹é¡¹
- `delete-todo`ï¼šæ ¹æ® ID åˆ é™¤å¾…åŠäº‹é¡¹

ä¸ºäº†æ§åˆ¶å¯¹è¿™äº›å·¥å…·çš„è®¿é—®ï¼Œæˆ‘ä»¬å®šä¹‰å¦‚ä¸‹æƒé™ (Scope)ï¼š

- `create:todos`ï¼šå…è®¸åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹
- `delete:todos`ï¼šå…è®¸åˆ é™¤å·²æœ‰çš„å¾…åŠäº‹é¡¹
- `read:todos`ï¼šå…è®¸æŸ¥è¯¢å’Œè·å–æ‰€æœ‰å¾…åŠäº‹é¡¹åˆ—è¡¨

### è§’è‰² (Role) ä¸æƒé™ (Permission) \{#roles-and-permissions}

æˆ‘ä»¬å°†å®šä¹‰ä¸¤ä¸ªå…·æœ‰ä¸åŒè®¿é—®çº§åˆ«çš„è§’è‰² (Role)ï¼š

| è§’è‰² (Role)  | create:todos | read:todos | delete:todos |
| ----- | ------------ | ---------- | ------------ |
| Admin | âœ…           | âœ…         | âœ…           |
| User  | âœ…           |            |              |

- **User**ï¼šæ™®é€šç”¨æˆ·ï¼Œå¯ä»¥åˆ›å»ºå¾…åŠäº‹é¡¹ï¼Œä»…èƒ½æŸ¥çœ‹æˆ–åˆ é™¤è‡ªå·±çš„å¾…åŠäº‹é¡¹
- **Admin**ï¼šç®¡ç†å‘˜ï¼Œå¯ä»¥åˆ›å»ºã€æŸ¥çœ‹å’Œåˆ é™¤æ‰€æœ‰å¾…åŠäº‹é¡¹ï¼Œæ— è®ºå½’å±è°

### èµ„æºå½’å± \{#resource-ownership}

è™½ç„¶ä¸Šè¡¨æ˜¾ç¤ºäº†åˆ†é…ç»™æ¯ä¸ªè§’è‰² (Role) çš„æ˜¾å¼æƒé™ (Scope)ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„èµ„æºå½’å±åŸåˆ™ï¼š

- **User** æ²¡æœ‰ `read:todos` æˆ– `delete:todos` æƒé™ (Scope)ï¼Œä½†ä»ç„¶å¯ä»¥ï¼š
  - æŸ¥çœ‹è‡ªå·±çš„å¾…åŠäº‹é¡¹
  - åˆ é™¤è‡ªå·±çš„å¾…åŠäº‹é¡¹
- **Admin** æ‹¥æœ‰å…¨éƒ¨æƒé™ (`read:todos` å’Œ `delete:todos`)ï¼Œå¯ä»¥ï¼š
  - æŸ¥çœ‹ç³»ç»Ÿä¸­æ‰€æœ‰å¾…åŠäº‹é¡¹
  - åˆ é™¤ä»»æ„å¾…åŠäº‹é¡¹ï¼Œæ— è®ºå½’å±è°

è¿™å±•ç¤ºäº† RBAC ç³»ç»Ÿä¸­çš„å¸¸è§æ¨¡å¼ï¼šèµ„æºå½’å±ä¸ºç”¨æˆ·è‡ªå·±çš„èµ„æºéšå¼æˆäºˆæƒé™ï¼Œè€Œç®¡ç†å‘˜è§’è‰² (Role) åˆ™å¯¹æ‰€æœ‰èµ„æºæ‹¥æœ‰æ˜¾å¼æƒé™ã€‚

:::tip äº†è§£æ›´å¤š
æƒ³æ·±å…¥äº†è§£ RBAC æ¦‚å¿µå’Œæœ€ä½³å®è·µï¼Œè¯·å‚é˜… [ç²¾é€š RBACï¼šä¸€ä¸ªå…¨é¢çš„çœŸå®æ¡ˆä¾‹](https://blog.logto.io/mastering-rbac)ã€‚
:::

## åœ¨ä½ çš„æä¾›å•†ä¸­é…ç½®æˆæƒ (Authorization) \{#configure-authorization-in-your-provider}

è¦å®ç°ä¸Šè¿°è®¿é—®æ§åˆ¶ç³»ç»Ÿï¼Œä½ éœ€è¦åœ¨æˆæƒæœåŠ¡å™¨ä¸­é…ç½®æ‰€éœ€çš„æƒé™ (Scope)ã€‚ä¸åŒæä¾›å•†çš„é…ç½®æ–¹æ³•å¦‚ä¸‹ï¼š

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

[Logto](https://logto.io) é€šè¿‡å…¶ API èµ„æºå’Œè§’è‰² (Role) åŠŸèƒ½æä¾› RBAC æ”¯æŒã€‚è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š

1. ç™»å½• [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ‰˜ç®¡ Logto Consoleï¼‰

2. åˆ›å»º API èµ„æºå’Œæƒé™ (Scope)ï¼š

   - è¿›å…¥â€œAPI èµ„æºâ€
   - åˆ›å»ºä¸€ä¸ªåä¸ºâ€œTodo Managerâ€çš„æ–° API èµ„æºï¼Œå¹¶ä½¿ç”¨ `http://localhost:3001` ä½œä¸ºèµ„æºæŒ‡ç¤ºå™¨ (Resource indicator)ã€‚
     - **é‡è¦**ï¼šèµ„æºæŒ‡ç¤ºå™¨ (Resource indicator) å¿…é¡»ä¸ä½ çš„ MCP æœåŠ¡å™¨ URL åŒ¹é…ã€‚æœ¬æ•™ç¨‹ä½¿ç”¨ `http://localhost:3001`ï¼Œå› ä¸º MCP æœåŠ¡å™¨è¿è¡Œåœ¨ 3001 ç«¯å£ã€‚ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨å®é™… MCP æœåŠ¡å™¨ URLï¼ˆå¦‚ `https://your-mcp-server.example.com`ï¼‰ã€‚
   - åˆ›å»ºä»¥ä¸‹æƒé™ (Scope)ï¼š
     - `create:todos`ï¼šâ€œåˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹â€
     - `read:todos`ï¼šâ€œè¯»å–æ‰€æœ‰å¾…åŠäº‹é¡¹â€
     - `delete:todos`ï¼šâ€œåˆ é™¤ä»»æ„å¾…åŠäº‹é¡¹â€

3. åˆ›å»ºè§’è‰² (Role)ï¼ˆæ¨èï¼Œä¾¿äºç®¡ç†ï¼‰ï¼š

   - è¿›å…¥â€œè§’è‰² (Roles)â€
   - åˆ›å»ºä¸€ä¸ªâ€œAdminâ€è§’è‰²ï¼Œå¹¶åˆ†é…æ‰€æœ‰æƒé™ (`create:todos`, `read:todos`, `delete:todos`)
   - åˆ›å»ºä¸€ä¸ªâ€œUserâ€è§’è‰²ï¼Œä»…åˆ†é… `create:todos` æƒé™
   - åœ¨â€œUserâ€è§’è‰²è¯¦æƒ…é¡µï¼Œåˆ‡æ¢åˆ°â€œå¸¸è§„â€æ ‡ç­¾ï¼Œå¹¶å°†â€œUserâ€è§’è‰²è®¾ç½®ä¸ºâ€œé»˜è®¤è§’è‰² (Default role)â€ã€‚

4. ç®¡ç†ç”¨æˆ·è§’è‰² (Role) å’Œæƒé™ (Permission)ï¼š
   - æ–°ç”¨æˆ·ï¼š
     - å› ä¸ºè®¾ç½®äº†é»˜è®¤è§’è‰²ï¼Œæ³¨å†Œåä¼šè‡ªåŠ¨è·å¾—â€œUserâ€è§’è‰²
   - å·²æœ‰ç”¨æˆ·ï¼š
     - è¿›å…¥â€œç”¨æˆ·ç®¡ç†â€
     - é€‰æ‹©ä¸€ä¸ªç”¨æˆ·
     - åœ¨â€œè§’è‰² (Roles)â€æ ‡ç­¾é¡µä¸ºç”¨æˆ·åˆ†é…è§’è‰²

:::tip ç¼–ç¨‹æ–¹å¼ç®¡ç†è§’è‰² (Role)
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Logto çš„ [Management API](https://docs.logto.io/integrate-logto/interact-with-management-api) ä»¥ç¼–ç¨‹æ–¹å¼ç®¡ç†ç”¨æˆ·è§’è‰² (Role)ã€‚è¿™å¯¹äºè‡ªåŠ¨åŒ–ç”¨æˆ·ç®¡ç†æˆ–æ„å»ºç®¡ç†åå°éå¸¸æœ‰ç”¨ã€‚
:::

è¯·æ±‚è®¿é—®ä»¤ç‰Œ (Access token) æ—¶ï¼ŒLogto ä¼šæ ¹æ®ç”¨æˆ·è§’è‰² (Role) æƒé™å°†æƒé™ (Scope) åŒ…å«åœ¨ä»¤ç‰Œçš„ `scope` å£°æ˜ (Claim) ä¸­ã€‚

</TabItem>
<TabItem value="oauth-or-oidc" label="OAuth 2 / OIDC">

å¯¹äº OAuth 2.0 æˆ– OpenID Connect æä¾›å•†ï¼Œä½ éœ€è¦é…ç½®ä»£è¡¨ä¸åŒæƒé™çš„æƒé™ (Scope)ã€‚å…·ä½“æ­¥éª¤è§†æä¾›å•†è€Œå®šï¼Œä½†é€šå¸¸åŒ…æ‹¬ï¼š

1. å®šä¹‰æƒé™ (Scope)ï¼š

   - é…ç½®æˆæƒæœåŠ¡å™¨æ”¯æŒï¼š
     - `create:todos`
     - `read:todos`
     - `delete:todos`

2. é…ç½®å®¢æˆ·ç«¯ï¼š

   - æ³¨å†Œæˆ–æ›´æ–°å®¢æˆ·ç«¯ä»¥è¯·æ±‚è¿™äº›æƒé™ (Scope)
   - ç¡®ä¿æƒé™ (Scope) è¢«åŒ…å«åœ¨è®¿é—®ä»¤ç‰Œ (Access token) ä¸­

3. åˆ†é…æƒé™ (Permission)ï¼š
   - ä½¿ç”¨æä¾›å•†ç•Œé¢ä¸ºç”¨æˆ·æˆäºˆç›¸åº”æƒé™ (Scope)
   - æœ‰äº›æä¾›å•†æ”¯æŒåŸºäºè§’è‰² (Role) çš„ç®¡ç†ï¼Œæœ‰äº›åˆ™ç›´æ¥åˆ†é…æƒé™ (Scope)
   - æŸ¥é˜…æä¾›å•†æ–‡æ¡£è·å–æ¨èåšæ³•

:::tip
å¤§å¤šæ•°æä¾›å•†ä¼šåœ¨è®¿é—®ä»¤ç‰Œ (Access token) çš„ `scope` å£°æ˜ (Claim) ä¸­åŒ…å«æˆäºˆçš„æƒé™ (Scope)ã€‚æ ¼å¼é€šå¸¸ä¸ºç©ºæ ¼åˆ†éš”çš„æƒé™ (Scope) å­—ç¬¦ä¸²ã€‚
:::

</TabItem>
</Tabs>

é…ç½®å¥½æˆæƒæœåŠ¡å™¨åï¼Œç”¨æˆ·å°†è·å¾—åŒ…å«å…¶æƒé™ (Scope) çš„è®¿é—®ä»¤ç‰Œ (Access token)ã€‚MCP æœåŠ¡å™¨å°†ä½¿ç”¨è¿™äº›æƒé™ (Scope) åˆ¤æ–­ï¼š

- ç”¨æˆ·æ˜¯å¦å¯ä»¥åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹ï¼ˆ`create:todos`ï¼‰
- ç”¨æˆ·æ˜¯å¦å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¾…åŠäº‹é¡¹ï¼ˆ`read:todos`ï¼‰æˆ–ä»…èƒ½æŸ¥çœ‹è‡ªå·±çš„
- ç”¨æˆ·æ˜¯å¦å¯ä»¥åˆ é™¤ä»»æ„å¾…åŠäº‹é¡¹ï¼ˆ`delete:todos`ï¼‰æˆ–ä»…èƒ½åˆ é™¤è‡ªå·±çš„

## æ­å»º MCP æœåŠ¡å™¨ \{#set-up-the-mcp-server}

æˆ‘ä»¬å°†ä½¿ç”¨ [MCP å®˜æ–¹ SDK](https://github.com/modelcontextprotocol) åˆ›å»ºæˆ‘ä»¬çš„å¾…åŠäº‹é¡¹ç®¡ç†å™¨ MCP æœåŠ¡å™¨ã€‚

### åˆ›å»ºæ–°é¡¹ç›® \{#create-a-new-project}

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

åˆ›å»ºä¸€ä¸ªæ–°çš„ Python é¡¹ç›®ï¼š

```bash
mkdir mcp-todo-server
cd mcp-todo-server

# åˆå§‹åŒ–æ–° Python é¡¹ç›®
uv init

# ä½¿ç”¨ uv åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆä½¿ç”¨ 'uv run' æ—¶å¯é€‰ï¼‰
source .venv/bin/activate
```

:::note
æœ¬é¡¹ç›®ä½¿ç”¨ `uv` è¿›è¡ŒåŒ…ç®¡ç†ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹© `pip`ã€`poetry` æˆ– `conda` ç­‰å…¶ä»–åŒ…ç®¡ç†å™¨ã€‚
:::

</TabItem>
<TabItem value="node" label="Node.js">

åˆ›å»ºä¸€ä¸ªæ–°çš„ Node.js é¡¹ç›®ï¼š

```bash
mkdir mcp-server
cd mcp-server
npm init -y # æˆ–ä½¿ç”¨ `pnpm init`
npm pkg set type="module"
npm pkg set main="todo-manager.ts"
npm pkg set scripts.start="node --experimental-strip-types todo-manager.ts"
```

:::note
æˆ‘ä»¬çš„ç¤ºä¾‹ä½¿ç”¨ TypeScriptï¼Œå› ä¸º Node.js v22.6.0+ åŸç”Ÿæ”¯æŒ `--experimental-strip-types` è¿è¡Œ TypeScriptã€‚å¦‚æœä½ ä½¿ç”¨ JavaScriptï¼Œä»£ç ç±»ä¼¼â€”â€”åªéœ€ç¡®ä¿ Node.js ç‰ˆæœ¬ä¸º v22.6.0 æˆ–æ›´é«˜ã€‚è¯¦è§ Node.js å®˜æ–¹æ–‡æ¡£ã€‚
:::

</TabItem>
</Tabs>

### å®‰è£… MCP SDK åŠä¾èµ– \{#install-the-mcp-sdk-and-dependencies}

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

å®‰è£…æ‰€éœ€ä¾èµ–ï¼š

```bash
uv add "mcp[cli]" uvicorn starlette
```

</TabItem>
<TabItem value="node" label="Node.js">

```bash
npm install @modelcontextprotocol/sdk express zod
```

æˆ–ä½¿ç”¨ä½ å–œæ¬¢çš„åŒ…ç®¡ç†å™¨ï¼Œå¦‚ `pnpm` æˆ– `yarn`ã€‚

</TabItem>
</Tabs>

### åˆ›å»º MCP æœåŠ¡å™¨ \{#create-the-mcp-server}

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ MCP æœåŠ¡å™¨å’Œå·¥å…·å®šä¹‰ï¼š

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

åˆ›å»º `server.py` æ–‡ä»¶å¹¶æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```python
# server.py

import contextlib
from typing import Any
from mcp.server.fastmcp import FastMCP
from starlette.applications import Starlette
from starlette.routing import Mount

# åˆå§‹åŒ– FastMCP æœåŠ¡å™¨
mcp = FastMCP(name="Todo Manager", stateless_http=True, streamable_http_path='/')

@mcp.tool()
def create_todo(content: str) -> dict[str, Any]:
    """åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹ã€‚éœ€è¦ 'create:todos' æƒé™ (Scope)ã€‚"""
    return {"error": "Not implemented"}

@mcp.tool()
def get_todos() -> dict[str, Any]:
    """åˆ—å‡ºå¾…åŠäº‹é¡¹ã€‚æ‹¥æœ‰ 'read:todos' æƒé™ (Scope) çš„ç”¨æˆ·å¯æŸ¥çœ‹æ‰€æœ‰å¾…åŠäº‹é¡¹ã€‚"""
    return {"error": "Not implemented"}

@mcp.tool()
def delete_todo(id: str) -> dict[str, Any]:
    """æ ¹æ® id åˆ é™¤å¾…åŠäº‹é¡¹ã€‚ç”¨æˆ·å¯åˆ é™¤è‡ªå·±çš„å¾…åŠäº‹é¡¹ã€‚"""
    return {"error": "Not implemented"}

@contextlib.asynccontextmanager
async def lifespan(app: Starlette):
    async with contextlib.AsyncExitStack() as stack:
        await stack.enter_async_context(mcp.session_manager.run())
        yield

# åˆ›å»º app
app = Starlette(
    routes=[
        Mount("/", app=mcp.streamable_http_app()),
    ],
    lifespan=lifespan,
)
```

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡å™¨ï¼š

```bash
# ä½¿ç”¨ uvicorn å¯åŠ¨ Todo Manager æœåŠ¡å™¨
uvicorn server:app --host 127.0.0.1 --port 3001

# æˆ–ä½¿ç”¨ uv:
# uv run uvicorn server:app --host 127.0.0.1 --port 3001
```

</TabItem>
<TabItem value="node" label="Node.js">

åˆ›å»º `todo-manager.ts` æ–‡ä»¶å¹¶æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```ts
// todo-manager.ts

import { z } from 'zod';
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StreamableHTTPServerTransport } from '@modelcontextprotocol/sdk/server/streamableHttp.js';
import express, { type Request, type Response } from 'express';

// åˆ›å»º MCP æœåŠ¡å™¨
const server = new McpServer({
  name: 'Todo Manager',
  version: '0.0.0',
});

server.tool('create-todo', 'åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹', { content: z.string() }, async ({ content }) => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

server.tool('get-todos', 'åˆ—å‡ºæ‰€æœ‰å¾…åŠäº‹é¡¹', async () => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

server.tool('delete-todo', 'æ ¹æ® id åˆ é™¤å¾…åŠäº‹é¡¹', { id: z.string() }, async ({ id }) => {
  return {
    content: [{ type: 'text', text: JSON.stringify({ error: 'Not implemented' }) }],
  };
});

// ä»¥ä¸‹ä¸º MCP SDK æ–‡æ¡£ä¸­çš„æ ·æ¿ä»£ç 
const PORT = 3001;
const app = express();

app.post('/', async (request: Request, response: Response) => {
  // åœ¨æ— çŠ¶æ€æ¨¡å¼ä¸‹ï¼Œä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºæ–°çš„ transport å’Œ server å®ä¾‹ä»¥ç¡®ä¿å®Œå…¨éš”ç¦»ã€‚
  // å•ä¸€å®ä¾‹ä¼šå¯¼è‡´å¤šä¸ªå®¢æˆ·ç«¯å¹¶å‘è¿æ¥æ—¶è¯·æ±‚ ID å†²çªã€‚

  try {
    const transport: StreamableHTTPServerTransport = new StreamableHTTPServerTransport({
      sessionIdGenerator: undefined,
    });
    response.on('close', async () => {
      console.log('Request closed');
      await transport.close();
      await server.close();
    });
    await server.connect(transport);
    await transport.handleRequest(request, response, request.body);
  } catch (error) {
    console.error('Error handling MCP request:', error);
    if (!response.headersSent) {
      response.status(500).json({
        jsonrpc: '2.0',
        error: {
          code: -32_603,
          message: 'Internal server error',
        },
        id: null,
      });
    }
  }
});

// æ— çŠ¶æ€æ¨¡å¼ä¸‹ä¸æ”¯æŒ SSE é€šçŸ¥
app.get('/', async (request: Request, response: Response) => {
  console.log('Received GET MCP request');
  response.writeHead(405).end(
    JSON.stringify({
      jsonrpc: '2.0',
      error: {
        code: -32_000,
        message: 'Method not allowed.',
      },
      id: null,
    })
  );
});

// æ— çŠ¶æ€æ¨¡å¼ä¸‹æ— éœ€ä¼šè¯ç»ˆæ­¢
app.delete('/', async (request: Request, response: Response) => {
  console.log('Received DELETE MCP request');
  response.writeHead(405).end(
    JSON.stringify({
      jsonrpc: '2.0',
      error: {
        code: -32_000,
        message: 'Method not allowed.',
      },
      id: null,
    })
  );
});

app.listen(PORT);
```

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡å™¨ï¼š

```bash
npm start
```

</TabItem>
</Tabs>

### æ£€æŸ¥ MCP æœåŠ¡å™¨ \{#inspect-the-mcp-server}

#### å…‹éš†å¹¶è¿è¡Œ MCP inspector \{#clone-and-run-mcp-inspector}

ç°åœ¨ MCP æœåŠ¡å™¨å·²è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MCP inspector æ£€æŸ¥å·¥å…·æ˜¯å¦å¯ç”¨ã€‚

å®˜æ–¹ MCP inspector v0.16.2 å­˜åœ¨å½±å“è®¤è¯ (Authentication) åŠŸèƒ½çš„ bugã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª[ä¿®è¡¥ç‰ˆ MCP inspector](https://github.com/mcp-auth/inspector/tree/patch/0.16.2-fixes)ï¼ŒåŒ…å«äº† OAuth/OIDC è®¤è¯ (Authentication) æµç¨‹çš„å¿…è¦ä¿®å¤ã€‚æˆ‘ä»¬ä¹Ÿå·²å‘å®˜æ–¹ä»“åº“æäº¤äº† PRã€‚

è¿è¡Œ MCP inspectorï¼š

```bash
git clone https://github.com/mcp-auth/inspector.git -b patch/0.16.2-fixes
cd inspector
npm install
npm run dev
```

MCP inspector ä¼šè‡ªåŠ¨åœ¨é»˜è®¤æµè§ˆå™¨æ‰“å¼€ï¼Œæˆ–ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨ç‚¹å‡»ç»ˆç«¯è¾“å‡ºä¸­çš„é“¾æ¥ï¼ˆç¡®ä¿ç‚¹å‡»å¸¦æœ‰ `MCP_PROXY_AUTH_TOKEN` å‚æ•°çš„é“¾æ¥ï¼Œå¦‚ `http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=458ae4a4...acab1907`ï¼‰ã€‚

#### è¿æ¥ MCP inspector åˆ° MCP æœåŠ¡å™¨ \{#connect-mcp-inspector-to-the-mcp-server}

ç»§ç»­å‰è¯·æ£€æŸ¥ MCP inspector çš„å¦‚ä¸‹é…ç½®ï¼š

- **Transport Type**ï¼šè®¾ç½®ä¸º `Streamable HTTP`
- **URL**ï¼šè®¾ç½®ä¸ºä½ çš„ MCP æœåŠ¡å™¨ URLï¼Œæœ¬ä¾‹ä¸º `http://localhost:3001`

ç°åœ¨ç‚¹å‡»â€œConnectâ€æŒ‰é’®ï¼Œæ£€æŸ¥ MCP inspector æ˜¯å¦èƒ½è¿æ¥ MCP æœåŠ¡å™¨ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ ä¼šåœ¨ MCP inspector ä¸­çœ‹åˆ°â€œConnectedâ€çŠ¶æ€ã€‚

#### æ£€æŸ¥ç‚¹ï¼šè¿è¡Œå¾…åŠäº‹é¡¹ç®¡ç†å·¥å…· \{#checkpoint-run-todo-manager-tools}

1. åœ¨ MCP inspector é¡¶éƒ¨èœå•ç‚¹å‡»â€œToolsâ€æ ‡ç­¾
2. ç‚¹å‡»â€œList Toolsâ€æŒ‰é’®
3. ä½ åº”è¯¥èƒ½åœ¨é¡µé¢ä¸Šçœ‹åˆ° `create-todo`ã€`get-todos` å’Œ `delete-todo` å·¥å…·ï¼Œç‚¹å‡»å¯æŸ¥çœ‹å·¥å…·è¯¦æƒ…
4. å³ä¾§ä¼šæœ‰â€œRun Toolâ€æŒ‰é’®ï¼Œç‚¹å‡»å¹¶è¾“å…¥æ‰€éœ€å‚æ•°è¿è¡Œå·¥å…·
5. ä½ ä¼šçœ‹åˆ°å·¥å…·è¿”å›çš„ JSON å“åº” `{"error": "Not implemented"}`

![MCP inspector é¦–æ¬¡è¿è¡Œ](/docs-assets/images/tutorials/todo-manager/inspector-first-run.png)

## é›†æˆä½ çš„æˆæƒæœåŠ¡å™¨ \{#integrate-with-your-authorization-server}

å®Œæˆæœ¬èŠ‚éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š

<details>
<summary>**ä½ çš„æˆæƒæœåŠ¡å™¨çš„å‘è¡Œè€… (Issuer) URL**</summary>

é€šå¸¸æ˜¯ä½ çš„æˆæƒæœåŠ¡å™¨çš„åŸºç¡€ URLï¼Œå¦‚ `https://auth.example.com`ã€‚æœ‰äº›æä¾›å•†å¯èƒ½æ˜¯ `https://example.logto.app/oidc`ï¼Œè¯·æŸ¥é˜…ä½ çš„æä¾›å•†æ–‡æ¡£ã€‚

</details>

<details>
<summary>**å¦‚ä½•è·å–æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®**</summary>

- å¦‚æœä½ çš„æˆæƒæœåŠ¡å™¨ç¬¦åˆ [OAuth 2.0 æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®](https://datatracker.ietf.org/doc/html/rfc8414) æˆ– [OpenID Connect å‘ç°](https://openid.net/specs/openid-connect-discovery-1_0.html)ï¼Œå¯ä»¥ç”¨ MCP Auth å†…ç½®å·¥å…·è‡ªåŠ¨è·å–å…ƒæ•°æ®
- å¦‚æœä¸ç¬¦åˆä¸Šè¿°æ ‡å‡†ï¼Œä½ éœ€è¦åœ¨ MCP æœåŠ¡å™¨é…ç½®ä¸­æ‰‹åŠ¨æŒ‡å®šå…ƒæ•°æ® URL æˆ–ç«¯ç‚¹ã€‚è¯·æŸ¥é˜…æä¾›å•†æ–‡æ¡£

</details>

<details>
<summary>**å¦‚ä½•å°† MCP inspector æ³¨å†Œä¸ºæˆæƒæœåŠ¡å™¨çš„å®¢æˆ·ç«¯**</summary>

- å¦‚æœä½ çš„æˆæƒæœåŠ¡å™¨æ”¯æŒ [åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ (Dynamic Client Registration)](https://datatracker.ietf.org/doc/html/rfc7591)ï¼Œå¯è·³è¿‡æ­¤æ­¥ï¼ŒMCP inspector ä¼šè‡ªåŠ¨æ³¨å†Œ
- å¦‚æœä¸æ”¯æŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œï¼Œéœ€è¦æ‰‹åŠ¨åœ¨æˆæƒæœåŠ¡å™¨ä¸­æ³¨å†Œ MCP inspector ä½œä¸ºå®¢æˆ·ç«¯

</details>

<details>
<summary>**äº†è§£ä»¤ç‰Œè¯·æ±‚å‚æ•°**</summary>

å‘ä¸åŒæˆæƒæœåŠ¡å™¨è¯·æ±‚è®¿é—®ä»¤ç‰Œ (Access token) æ—¶ï¼ŒæŒ‡å®šç›®æ ‡èµ„æºå’Œæƒé™ (Scope) çš„æ–¹å¼å„å¼‚ï¼Œä¸»è¦æœ‰ï¼š

- **åŸºäºèµ„æºæŒ‡ç¤ºå™¨ (Resource indicator)**ï¼š

  - ä½¿ç”¨ `resource` å‚æ•°æŒ‡å®šç›®æ ‡ APIï¼ˆè§ [RFC 8707: OAuth 2.0 çš„èµ„æºæŒ‡ç¤ºå™¨]ï¼‰
  - ç°ä»£ OAuth 2.0 å®ç°å¸¸è§
  - ç¤ºä¾‹è¯·æ±‚ï¼š
    ```json
    {
      "resource": "http://localhost:3001",
      "scope": "create:todos read:todos"
    }
    ```
  - æœåŠ¡å™¨é¢å‘ä¸“é—¨ç»‘å®šåˆ°è¯·æ±‚èµ„æºçš„ä»¤ç‰Œ

- **åŸºäºå—ä¼— (Audience)**ï¼š

  - ä½¿ç”¨ `audience` å‚æ•°æŒ‡å®šä»¤ç‰Œæ¥æ”¶æ–¹
  - ä¸èµ„æºæŒ‡ç¤ºå™¨ç±»ä¼¼ä½†è¯­ä¹‰ä¸åŒ
  - ç¤ºä¾‹è¯·æ±‚ï¼š
    ```json
    {
      "audience": "todo-api",
      "scope": "create:todos read:todos"
    }
    ```

- **çº¯æƒé™ (Scope) æ¨¡å¼**ï¼š
  - ä»…ä¾èµ–æƒé™ (Scope)ï¼Œæ—  resource/audience å‚æ•°
  - ä¼ ç»Ÿ OAuth 2.0 åšæ³•
  - ç¤ºä¾‹è¯·æ±‚ï¼š
    ```json
    {
      "scope": "todo-api:create todo-api:read openid profile"
    }
    ```
  - å¸¸ç”¨å‰ç¼€æƒé™ (Scope) è¿›è¡Œå‘½åç©ºé—´éš”ç¦»
  - ç®€å• OAuth 2.0 å®ç°å¸¸è§

:::tip æœ€ä½³å®è·µ

- æŸ¥é˜…ä½ çš„æä¾›å•†æ–‡æ¡£ï¼Œäº†è§£æ”¯æŒå“ªäº›å‚æ•°
- æœ‰äº›æä¾›å•†åŒæ—¶æ”¯æŒå¤šç§æ–¹å¼
- èµ„æºæŒ‡ç¤ºå™¨ (Resource indicator) é€šè¿‡å—ä¼—é™åˆ¶æå‡å®‰å…¨æ€§
- å¦‚å¯ç”¨ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨èµ„æºæŒ‡ç¤ºå™¨ (Resource indicator) ä»¥è·å¾—æ›´å¥½çš„è®¿é—®æ§åˆ¶
  :::

</details>

è™½ç„¶æ¯ä¸ªæä¾›å•†æœ‰è‡ªå·±çš„å…·ä½“è¦æ±‚ï¼Œä»¥ä¸‹æ­¥éª¤å°†æŒ‡å¯¼ä½ å¦‚ä½•ç»“åˆ MCP inspector å’Œ MCP æœåŠ¡å™¨è¿›è¡Œæä¾›å•†ç‰¹å®šé…ç½®ã€‚

### æ³¨å†Œ MCP inspector ä¸ºå®¢æˆ·ç«¯ \{#register-mcp-inspector-as-a-client}

<Tabs groupId="provider">
<TabItem value="logto" label="Logto">

å°†å¾…åŠäº‹é¡¹ç®¡ç†å™¨é›†æˆåˆ° [Logto](https://logto.io) éå¸¸ç®€å•ï¼Œå› ä¸ºå®ƒæ˜¯æ”¯æŒèµ„æºæŒ‡ç¤ºå™¨ (Resource indicator) å’Œæƒé™ (Scope) çš„ OpenID Connect æä¾›å•†ï¼Œå¯ä»¥ç”¨ `http://localhost:3001` ä½œä¸ºèµ„æºæŒ‡ç¤ºå™¨ä¿æŠ¤ä½ çš„ todo APIã€‚

ç”±äº Logto ç›®å‰å°šä¸æ”¯æŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œï¼Œä½ éœ€è¦æ‰‹åŠ¨åœ¨ Logto ç§Ÿæˆ·ä¸­æ³¨å†Œ MCP inspector ä½œä¸ºå®¢æˆ·ç«¯ï¼š

1. æ‰“å¼€ MCP inspectorï¼Œè¿›å…¥ Authentication é…ç½®ï¼Œç‚¹å‡» "OAuth2.0 Flow" é…ç½®ï¼Œå¤åˆ¶ **Redirect URI**ï¼Œå¦‚ `http://localhost:6274/oauth/callback`
2. ç™»å½• [Logto Console](https://cloud.logto.io)ï¼ˆæˆ–ä½ çš„è‡ªæ‰˜ç®¡ Logto Consoleï¼‰
3. è¿›å…¥â€œåº”ç”¨ç¨‹åºâ€æ ‡ç­¾ï¼Œç‚¹å‡»â€œåˆ›å»ºåº”ç”¨ç¨‹åºâ€ã€‚é¡µé¢åº•éƒ¨ç‚¹å‡»â€œæ— æ¡†æ¶åˆ›å»ºåº”ç”¨â€
4. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼Œç‚¹å‡»â€œåˆ›å»ºåº”ç”¨ç¨‹åºâ€ï¼š
   - **é€‰æ‹©åº”ç”¨ç±»å‹**ï¼šé€‰æ‹©â€œå•é¡µåº”ç”¨â€
   - **åº”ç”¨åç§°**ï¼šå¦‚â€œMCP Inspectorâ€
5. åœ¨â€œè®¾ç½® / Redirect URIsâ€éƒ¨åˆ†ï¼Œç²˜è´´ MCP inspector å¤åˆ¶çš„ **Redirect URI**ï¼Œç„¶åç‚¹å‡»åº•éƒ¨æ â€œä¿å­˜æ›´æ”¹â€
6. é¡¶éƒ¨å¡ç‰‡ä¼šæ˜¾ç¤ºâ€œApp IDâ€ï¼Œå¤åˆ¶å®ƒ
7. å›åˆ° MCP inspectorï¼Œåœ¨ Authentication é…ç½®çš„ "OAuth2.0 Flow" ä¸‹çš„ "Client ID" å­—æ®µç²˜è´´ "App ID"
8. åœ¨ "Scope" å­—æ®µè¾“å…¥ï¼š`create:todos read:todos delete:todos`ï¼Œç¡®ä¿ Logto è¿”å›çš„è®¿é—®ä»¤ç‰Œ (Access token) åŒ…å«è®¿é—® todo manager æ‰€éœ€çš„æƒé™ (Scope)

</TabItem>
<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

:::note
è¿™æ˜¯é€šç”¨çš„ OAuth 2.0 / OpenID Connect æä¾›å•†é›†æˆæŒ‡å—ã€‚OIDC åŸºäº OAuth 2.0ï¼Œæ­¥éª¤ç±»ä¼¼ã€‚å…·ä½“ç»†èŠ‚è¯·æŸ¥é˜…ä½ çš„æä¾›å•†æ–‡æ¡£ã€‚
:::

å¦‚æœä½ çš„æä¾›å•†æ”¯æŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œï¼Œå¯ç›´æ¥è·³åˆ°ç¬¬ 8 æ­¥é…ç½® MCP inspectorï¼Œå¦åˆ™éœ€æ‰‹åŠ¨æ³¨å†Œ MCP inspector ä¸ºå®¢æˆ·ç«¯ï¼š

1. æ‰“å¼€ MCP inspectorï¼Œè¿›å…¥ Authentication é…ç½®ï¼Œç‚¹å‡» "OAuth2.0 Flow" é…ç½®ï¼Œå¤åˆ¶ **Redirect URI**ï¼Œå¦‚ `http://localhost:6274/oauth/callback`

2. ç™»å½•ä½ çš„æä¾›å•†æ§åˆ¶å°

3. è¿›å…¥â€œåº”ç”¨ç¨‹åºâ€æˆ–â€œå®¢æˆ·ç«¯â€éƒ¨åˆ†ï¼Œåˆ›å»ºæ–°åº”ç”¨æˆ–å®¢æˆ·ç«¯

4. å¦‚éœ€é€‰æ‹©å®¢æˆ·ç«¯ç±»å‹ï¼Œé€‰â€œå•é¡µåº”ç”¨â€æˆ–â€œå…¬å¼€å®¢æˆ·ç«¯â€

5. åˆ›å»ºåº”ç”¨åï¼Œé…ç½®é‡å®šå‘ URIï¼Œç²˜è´´ MCP inspector å¤åˆ¶çš„ **Redirect URI**

6. æ‰¾åˆ°æ–°å»ºåº”ç”¨çš„ "Client ID" æˆ– "Application ID"ï¼Œå¤åˆ¶

7. å›åˆ° MCP inspectorï¼Œåœ¨ Authentication é…ç½®çš„ "OAuth2.0 Flow" ä¸‹çš„ "Client ID" å­—æ®µç²˜è´´

8. åœ¨ "Scope" å­—æ®µè¾“å…¥ä»¥ä¸‹æƒé™ (Scope) ä»¥è¯·æ±‚å¾…åŠäº‹é¡¹æ“ä½œæ‰€éœ€æƒé™ï¼š

```text
create:todos read:todos delete:todos
```

</TabItem>
</Tabs>

### é…ç½® MCP Auth \{#set-up-mcp-auth}

é¦–å…ˆï¼Œåœ¨ MCP æœåŠ¡å™¨é¡¹ç›®ä¸­å®‰è£… MCP Auth SDKã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

```bash
uv add mcpauth==0.2.0b1
```

</TabItem>
<TabItem value="node" label="Node.js">

```bash
npm install mcp-auth@0.2.0-beta.1
```

</TabItem>
</Tabs>

ç°åœ¨éœ€è¦åœ¨ MCP æœåŠ¡å™¨ä¸­åˆå§‹åŒ– MCP Authï¼Œä¸»è¦åˆ†ä¸¤æ­¥ï¼š

1. **è·å–æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®**ï¼šç”¨äºåç»­ MCP Auth éªŒè¯æˆæƒæœåŠ¡å™¨é¢å‘çš„è®¿é—®ä»¤ç‰Œ (Access token)ï¼Œå¹¶åœ¨èµ„æºå…ƒæ•°æ®ä¸­åŒ…å«æˆæƒæœåŠ¡å™¨çš„å‘è¡Œè€… (Issuer) æ ‡è¯†
2. **é…ç½®å—ä¿æŠ¤èµ„æºå…ƒæ•°æ®**ï¼šå®šä¹‰ MCP æœåŠ¡å™¨çš„èµ„æºæ ‡è¯†ç¬¦å’Œæ”¯æŒçš„æƒé™ (Scope)

#### æ­¥éª¤ 1ï¼šè·å–æˆæƒæœåŠ¡å™¨å…ƒæ•°æ® \{#step-1-fetch-authorization-server-metadata\}

æ ¹æ® OAuth / OIDC è§„èŒƒï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆæƒæœåŠ¡å™¨çš„å‘è¡Œè€… (Issuer) URL è·å–æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®ã€‚

<Tabs groupId="provider">

<TabItem value="logto" label="Logto">

åœ¨ Logto ä¸­ï¼Œä½ å¯ä»¥åœ¨ Logto Console çš„åº”ç”¨è¯¦æƒ…é¡µ "Endpoints & Credentials / Issuer endpoint" éƒ¨åˆ†æ‰¾åˆ°å‘è¡Œè€… (Issuer) URLï¼Œæ ¼å¼å¦‚ `https://my-project.logto.app/oidc`ã€‚

</TabItem>

<TabItem value="oauth-oidc" label="OAuth 2.0 / OIDC">

å¯¹äº OAuth 2.0 æä¾›å•†ï¼Œä½ éœ€è¦ï¼š

1. æŸ¥é˜…æä¾›å•†æ–‡æ¡£ï¼Œè·å–æˆæƒæœåŠ¡å™¨ URLï¼ˆé€šå¸¸ç§°ä¸ºå‘è¡Œè€… (Issuer) URL æˆ–åŸºç¡€ URLï¼‰
2. æœ‰äº›æä¾›å•†ä¼šåœ¨ `https://{your-domain}/.well-known/oauth-authorization-server` æš´éœ²
3. åœ¨æä¾›å•†ç®¡ç†åå°çš„ OAuth/API è®¾ç½®ä¸­æŸ¥æ‰¾

</TabItem>

</Tabs>

ç°åœ¨ï¼Œä½¿ç”¨ MCP Auth å·¥å…·å‡½æ•°è·å–æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®ï¼š

<Tabs groupId="sdk">

<TabItem value="python" label="Python">
```python
from mcpauth import MCPAuth
from mcpauth.config import AuthServerType
from mcpauth.utils import fetch_server_config

issuer_url = "<issuer-url>"  # æ›¿æ¢ä¸ºä½ çš„æˆæƒæœåŠ¡å™¨å‘è¡Œè€… (Issuer) URL

# è·å–æˆæƒæœåŠ¡å™¨é…ç½®
auth_server_config = fetch_server_config(issuer_url, AuthServerType.OIDC) # æˆ– AuthServerType.OAUTH
```

</TabItem>
<TabItem value="node" label="Node.js">
```js
import { MCPAuth, fetchServerConfig } from 'mcp-auth';

const issuerUrl = '<issuer-url>'; // æ›¿æ¢ä¸ºä½ çš„æˆæƒæœåŠ¡å™¨å‘è¡Œè€… (Issuer) URL

// è·å–æˆæƒæœåŠ¡å™¨é…ç½®ï¼ˆOIDC å‘ç°ï¼‰
const authServerConfig = await fetchServerConfig(issuerUrl, { type: 'oidc' }); // æˆ– { type: 'oauth' }
```

</TabItem>
</Tabs>

å¦‚éœ€å…¶ä»–æ–¹å¼è·å–æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®æˆ–è‡ªå®šä¹‰é…ç½®ï¼Œè¯·å‚è€ƒ[å…¶ä»–é…ç½®æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®çš„æ–¹æ³•](/docs/configure-server/mcp-auth#other-ways)ã€‚

#### æ­¥éª¤ 2ï¼šé…ç½®å—ä¿æŠ¤èµ„æºå…ƒæ•°æ® \{#step-2-configure-protected-resource-metadata}

æ¥ä¸‹æ¥ï¼Œåœ¨æ„å»º MCP Auth å®ä¾‹æ—¶é…ç½®å—ä¿æŠ¤èµ„æºå…ƒæ•°æ®ã€‚éšåï¼ŒMCP æœåŠ¡å™¨ä¼šé€šè¿‡ MCP Auth æš´éœ²é…ç½®çš„èµ„æºå…ƒæ•°æ®ã€‚

<Tabs groupId="sdk">

<TabItem value="python" label="Python">
```python
# server.py

# å…¶ä»–å¯¼å…¥...
from mcpauth.types import ResourceServerConfig, ResourceServerMetadata

# å®šä¹‰ MCP æœåŠ¡å™¨çš„èµ„æºæ ‡è¯†ç¬¦
resource_id = "http://localhost:3001"

mcp_auth = MCPAuth(
    protected_resources=ResourceServerConfig(
        metadata=ResourceServerMetadata(
            resource=resource_id,
            # ä¸Šä¸€æ­¥è·å–çš„æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®
            authorization_servers=[auth_server_config],
            # MCP æœåŠ¡å™¨æ”¯æŒçš„æƒé™ (Scope)
            scopes_supported=[
                "create:todos",
                "read:todos",
                "delete:todos"
            ]
        )
    )
)
```
</TabItem>

<TabItem value="node" label="Node.js">
```js
// todo-manager.ts

// å®šä¹‰ MCP æœåŠ¡å™¨çš„èµ„æºæ ‡è¯†ç¬¦
const resourceId = 'http://localhost:3001';

// é…ç½® MCP Auth çš„å—ä¿æŠ¤èµ„æºå…ƒæ•°æ®
const mcpAuth = new MCPAuth({
  protectedResources: {
    metadata: {
      resource: resourceId,
      // ä¸Šä¸€æ­¥è·å–çš„æˆæƒæœåŠ¡å™¨å…ƒæ•°æ®
      authorizationServers: [authServerConfig],
      // MCP æœåŠ¡å™¨æ”¯æŒçš„æƒé™ (Scope)
      scopesSupported: [
        "create:todos",
        "read:todos",
        "delete:todos"
      ]
    }
  }
});
```
</TabItem>

</Tabs>

### æ›´æ–° MCP æœåŠ¡å™¨ \{#update-mcp-server}

å¿«å®Œæˆäº†ï¼ç°åœ¨éœ€è¦æ›´æ–° MCP æœåŠ¡å™¨ï¼Œåº”ç”¨ MCP Auth è·¯ç”±å’Œä¸­é—´ä»¶å‡½æ•°ï¼Œå¹¶åŸºäºç”¨æˆ·æƒé™ (Scope) å®ç°å¾…åŠäº‹é¡¹å·¥å…·çš„æƒé™æ§åˆ¶ã€‚

é¦–å…ˆï¼Œåº”ç”¨å—ä¿æŠ¤èµ„æºå…ƒæ•°æ®è·¯ç”±ï¼Œè®© MCP å®¢æˆ·ç«¯å¯ä»¥ä» MCP æœåŠ¡å™¨è·å–èµ„æºå…ƒæ•°æ®ã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">
```python
# server.py

# ..å…¶ä»–ä»£ç 

app = Starlette(
    routes=[
        # è®¾ç½®å—ä¿æŠ¤èµ„æºå…ƒæ•°æ®è·¯ç”±
        # è¿™ä¼šä¸º OAuth å®¢æˆ·ç«¯æš´éœ²æœ¬èµ„æºæœåŠ¡å™¨çš„å…ƒæ•°æ®
        *mcp_auth.resource_metadata_router().routes,
        Mount("/", app=mcp.streamable_http_app()),
    ],
    lifespan=lifespan,
)
```
</TabItem>
<TabItem value="node" label="Node.js">

```ts
// todo-manager.ts

// è®¾ç½®å—ä¿æŠ¤èµ„æºå…ƒæ•°æ®è·¯ç”±
// è¿™ä¼šä¸º OAuth å®¢æˆ·ç«¯æš´éœ²æœ¬èµ„æºæœåŠ¡å™¨çš„å…ƒæ•°æ®
app.use(mcpAuth.protectedResourceMetadataRouter());

```
</TabItem>
</Tabs>

æ¥ä¸‹æ¥ï¼Œåº”ç”¨ MCP Auth ä¸­é—´ä»¶åˆ° MCP æœåŠ¡å™¨ã€‚è¯¥ä¸­é—´ä»¶å°†å¤„ç†æ‰€æœ‰è¯·æ±‚çš„è®¤è¯ (Authentication) å’Œæˆæƒ (Authorization)ï¼Œç¡®ä¿åªæœ‰è¢«æˆæƒç”¨æˆ·æ‰èƒ½è®¿é—®å¾…åŠäº‹é¡¹å·¥å…·ã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">
```python
# server.py

# å…¶ä»–å¯¼å…¥...
from starlette.middleware import Middleware

# å…¶ä»–ä»£ç ...

# åˆ›å»ºä¸­é—´ä»¶
bearer_auth = Middleware(mcp_auth.bearer_auth_middleware('jwt', resource=resource_id, audience=resource_id))

app = Starlette(
    routes=[
        *mcp_auth.resource_metadata_router().routes,
        # åº”ç”¨ MCP Auth ä¸­é—´ä»¶
        Mount("/", app=mcp.streamable_http_app(), middleware=[bearer_auth]),
    ],
    lifespan=lifespan,
)
```
</TabItem>
<TabItem value="node" label="Node.js">

```ts
// todo-manager.ts

app.use(mcpAuth.protectedResourceMetadataRouter());

// åº”ç”¨ MCP Auth ä¸­é—´ä»¶
app.use(
  mcpAuth.bearerAuth('jwt', {
    resource: resourceId,
    audience: resourceId,
  })
);
```
</TabItem>
</Tabs>

ç°åœ¨å¯ä»¥æ›´æ–°å¾…åŠäº‹é¡¹å·¥å…·çš„å®ç°ï¼Œè®©å…¶åˆ©ç”¨ MCP Auth ä¸­é—´ä»¶è¿›è¡Œè®¤è¯ (Authentication) å’Œæˆæƒ (Authorization)ã€‚

<Tabs groupId="sdk">
<TabItem value="python" label="Python">
```python
# server.py

# å…¶ä»–å¯¼å…¥...

from typing import Any, List, Optional
from mcpauth.exceptions import MCPAuthBearerAuthException, BearerAuthExceptionCode
from mcpauth.types import AuthInfo, ResourceServerConfig, ResourceServerMetadata

# ä¸‹ä¸€èŠ‚ä¼šç”¨åˆ°
from service import TodoService

def assert_user_id(auth_info: Optional[AuthInfo]) -> str:
    """æ–­è¨€ auth_info åŒ…å«æœ‰æ•ˆç”¨æˆ· ID å¹¶è¿”å›ã€‚"""
    if not auth_info or not auth_info.subject:
        raise Exception("Invalid auth info")
    return auth_info.subject

def has_required_scopes(user_scopes: List[str], required_scopes: List[str]) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰å¿…éœ€æƒé™ (Scope)ã€‚"""
    return all(scope in user_scopes for scope in required_scopes)

# åˆ›å»º TodoService å®ä¾‹
todo_service = TodoService()

@mcp.tool()
def create_todo(content: str) -> dict[str, Any]:
    """åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹ã€‚éœ€è¦ 'create:todos' æƒé™ (Scope)ã€‚"""
    auth_info = mcp_auth.auth_info
    user_id = assert_user_id(auth_info)
    
    # åªæœ‰æ‹¥æœ‰ 'create:todos' æƒé™ (Scope) çš„ç”¨æˆ·æ‰èƒ½åˆ›å»º
    user_scopes = auth_info.scopes if auth_info else []
    if not has_required_scopes(user_scopes, ["create:todos"]):
        raise MCPAuthBearerAuthException(BearerAuthExceptionCode.MISSING_REQUIRED_SCOPES)
    
    created_todo = todo_service.create_todo(content=content, owner_id=user_id)
    return created_todo

@mcp.tool()
def get_todos() -> dict[str, Any]:
    """
    åˆ—å‡ºå¾…åŠäº‹é¡¹ã€‚æ‹¥æœ‰ 'read:todos' æƒé™ (Scope) çš„ç”¨æˆ·å¯æŸ¥çœ‹æ‰€æœ‰å¾…åŠäº‹é¡¹ï¼Œ
    å¦åˆ™åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ã€‚
    """
    auth_info = mcp_auth.auth_info
    user_id = assert_user_id(auth_info)
    
    # æœ‰ 'read:todos' æƒé™ (Scope) å¯è®¿é—®æ‰€æœ‰å¾…åŠäº‹é¡¹ï¼Œå¦åˆ™åªèƒ½è®¿é—®è‡ªå·±çš„
    user_scopes = auth_info.scopes if auth_info else []
    todo_owner_id = None if has_required_scopes(user_scopes, ["read:todos"]) else user_id
    
    todos = todo_service.get_all_todos(todo_owner_id)
    return {"todos": todos}

@mcp.tool()
def delete_todo(id: str) -> dict[str, Any]:
    """
    æ ¹æ® id åˆ é™¤å¾…åŠäº‹é¡¹ã€‚ç”¨æˆ·å¯åˆ é™¤è‡ªå·±çš„å¾…åŠäº‹é¡¹ã€‚
    æ‹¥æœ‰ 'delete:todos' æƒé™ (Scope) çš„ç”¨æˆ·å¯åˆ é™¤ä»»æ„å¾…åŠäº‹é¡¹ã€‚
    """
    auth_info = mcp_auth.auth_info
    user_id = assert_user_id(auth_info)
    
    todo = todo_service.get_todo_by_id(id)
    
    if not todo:
        return {"error": "Failed to delete todo"}
    
    # ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„å¾…åŠäº‹é¡¹
    # æ‹¥æœ‰ 'delete:todos' æƒé™ (Scope) å¯åˆ é™¤ä»»æ„å¾…åŠäº‹é¡¹
    user_scopes = auth_info.scopes if auth_info else []
    if todo.owner_id != user_id and not has_required_scopes(user_scopes, ["delete:todos"]):
        return {"error": "Failed to delete todo"}
    
    deleted_todo = todo_service.delete_todo(id)
    
    if deleted_todo:
        return {
            "message": f"Todo {id} deleted",
            "details": deleted_todo
        }
    else:
        return {"error": "Failed to delete todo"}
```
</TabItem>

<TabItem value="node" label="Node.js">
```js
// todo-manager.ts

// å…¶ä»–å¯¼å…¥...
import assert from 'node:assert';
import { fetchServerConfig, MCPAuth, MCPAuthBearerAuthError } from 'mcp-auth';
import { type AuthInfo } from '@modelcontextprotocol/sdk/server/auth/types.js';

// ä¸‹ä¸€èŠ‚ä¼šç”¨åˆ°
import { TodoService } from './todo-service.js';

const assertUserId = (authInfo?: AuthInfo) => {
  const { subject } = authInfo ?? {};
  assert(subject, 'Invalid auth info');
  return subject;
};

const hasRequiredScopes = (userScopes: string[], requiredScopes: string[]): boolean => {
  return requiredScopes.every((scope) => userScopes.includes(scope));
};

const todoService = new TodoService();

server.tool(
  'create-todo',
  'åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹',
  { content: z.string() },
  ({ content }: { content: string }, { authInfo }) => {
    const userId = assertUserId(authInfo);

    /**
     * åªæœ‰æ‹¥æœ‰ 'create:todos' æƒé™ (Scope) çš„ç”¨æˆ·æ‰èƒ½åˆ›å»º
     */
    if (!hasRequiredScopes(authInfo?.scopes ?? [], ['create:todos'])) {
      throw new MCPAuthBearerAuthError('missing_required_scopes');
    }

    const createdTodo = todoService.createTodo({ content, ownerId: userId });

    return {
      content: [{ type: 'text', text: JSON.stringify(createdTodo) }],
    };
  }
);

server.tool('get-todos', 'åˆ—å‡ºæ‰€æœ‰å¾…åŠäº‹é¡¹', ({ authInfo }) => {
  const userId = assertUserId(authInfo);

  /**
   * æœ‰ 'read:todos' æƒé™ (Scope) å¯è®¿é—®æ‰€æœ‰å¾…åŠäº‹é¡¹ï¼ˆtodoOwnerId = undefinedï¼‰
   * æ²¡æœ‰ 'read:todos' æƒé™ (Scope) åªèƒ½è®¿é—®è‡ªå·±çš„ï¼ˆtodoOwnerId = userIdï¼‰
   */
  const todoOwnerId = hasRequiredScopes(authInfo?.scopes ?? [], ['read:todos'])
    ? undefined
    : userId;

  const todos = todoService.getAllTodos(todoOwnerId);

  return {
    content: [{ type: 'text', text: JSON.stringify(todos) }],
  };
});

server.tool(
  'delete-todo',
  'æ ¹æ® id åˆ é™¤å¾…åŠäº‹é¡¹',
  { id: z.string() },
  ({ id }: { id: string }, { authInfo }) => {
    const userId = assertUserId(authInfo);

    const todo = todoService.getTodoById(id);

    if (!todo) {
      return {
        content: [{ type: 'text', text: JSON.stringify({ error: 'Failed to delete todo' }) }],
      };
    }

    /**
     * ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„å¾…åŠäº‹é¡¹
     * æ‹¥æœ‰ 'delete:todos' æƒé™ (Scope) å¯åˆ é™¤ä»»æ„å¾…åŠäº‹é¡¹
     */
    if (todo.ownerId !== userId && !hasRequiredScopes(authInfo?.scopes ?? [], ['delete:todos'])) {
      return {
        content: [
          {
            type: 'text',
            text: JSON.stringify({ error: 'Failed to delete todo' }),
          },
        ],
      };
    }

    const deletedTodo = todoService.deleteTodo(id);

    return {
      content: [
        {
          type: 'text',
          text: JSON.stringify({
            message: `Todo ${id} deleted`,
            details: deletedTodo,
          }),
        },
      ],
    };
  }
);
```
</TabItem>
</Tabs>

ç°åœ¨ï¼Œåˆ›å»ºä¸Šè¿°ä»£ç ä¸­ç”¨åˆ°çš„ "Todo service" å®ç°ç›¸å…³åŠŸèƒ½ï¼š

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

åˆ›å»º `service.py` æ–‡ä»¶ï¼š

```python
"""
ä¸€ä¸ªç®€å•çš„ Todo æœåŠ¡ï¼Œä»…ç”¨äºæ¼”ç¤ºã€‚
ä½¿ç”¨å†…å­˜åˆ—è¡¨å­˜å‚¨å¾…åŠäº‹é¡¹ã€‚
"""

from datetime import datetime
from typing import List, Optional, Dict, Any
import random
import string

class Todo:
    """å¾…åŠäº‹é¡¹å®ä½“"""
    
    def __init__(self, id: str, content: str, owner_id: str, created_at: str):
        self.id = id
        self.content = content
        self.owner_id = owner_id
        self.created_at = created_at
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸ï¼Œä¾¿äº JSON åºåˆ—åŒ–"""
        return {
            "id": self.id,
            "content": self.content,
            "ownerId": self.owner_id,
            "createdAt": self.created_at
        }


class TodoService:
    """ç®€å•çš„ Todo æœåŠ¡ï¼Œä»…ç”¨äºæ¼”ç¤º"""
    
    def __init__(self):
        self._todos: List[Todo] = []
    
    def get_all_todos(self, owner_id: Optional[str] = None) -> List[Dict[str, Any]]:
        """
        è·å–æ‰€æœ‰å¾…åŠäº‹é¡¹ï¼Œå¯é€‰æŒ‰ owner_id è¿‡æ»¤
        
        Args:
            owner_id: å¦‚æä¾›ï¼Œä»…è¿”å›è¯¥ç”¨æˆ·çš„å¾…åŠäº‹é¡¹
            
        Returns:
            å¾…åŠäº‹é¡¹å­—å…¸åˆ—è¡¨
        """
        if owner_id:
            filtered_todos = [todo for todo in self._todos if todo.owner_id == owner_id]
            return [todo.to_dict() for todo in filtered_todos]
        return [todo.to_dict() for todo in self._todos]
    
    def get_todo_by_id(self, todo_id: str) -> Optional[Todo]:
        """
        æ ¹æ® ID è·å–å¾…åŠäº‹é¡¹
        
        Args:
            todo_id: å¾…åŠäº‹é¡¹ ID
            
        Returns:
            æ‰¾åˆ°åˆ™è¿”å› Todo å¯¹è±¡ï¼Œå¦åˆ™è¿”å› None
        """
        for todo in self._todos:
            if todo.id == todo_id:
                return todo
        return None
    
    def create_todo(self, content: str, owner_id: str) -> Dict[str, Any]:
        """
        åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹
        
        Args:
            content: å¾…åŠäº‹é¡¹å†…å®¹
            owner_id: ç”¨æˆ· ID
            
        Returns:
            åˆ›å»ºçš„å¾…åŠäº‹é¡¹å­—å…¸
        """
        todo = Todo(
            id=self._generate_id(),
            content=content,
            owner_id=owner_id,
            created_at=datetime.now().isoformat()
        )
        self._todos.append(todo)
        return todo.to_dict()
    
    def delete_todo(self, todo_id: str) -> Optional[Dict[str, Any]]:
        """
        æ ¹æ® ID åˆ é™¤å¾…åŠäº‹é¡¹
        
        Args:
            todo_id: å¾…åŠäº‹é¡¹ ID
            
        Returns:
            åˆ é™¤çš„å¾…åŠäº‹é¡¹å­—å…¸ï¼Œå¦‚æœªæ‰¾åˆ°è¿”å› None
        """
        for i, todo in enumerate(self._todos):
            if todo.id == todo_id:
                deleted_todo = self._todos.pop(i)
                return deleted_todo.to_dict()
        return None
    
    def _generate_id(self) -> str:
        """ç”Ÿæˆéšæœº ID"""
        return ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))
```

</TabItem>
<TabItem value="node" label="Node.js">

åˆ›å»º `todo-service.ts` æ–‡ä»¶ï¼š

```ts
// todo-service.ts

type Todo = {
  id: string;
  content: string;
  ownerId: string;
  createdAt: string;
};

/**
 * ç®€å•çš„ Todo æœåŠ¡ï¼Œä»…ç”¨äºæ¼”ç¤ºã€‚
 * ä½¿ç”¨å†…å­˜æ•°ç»„å­˜å‚¨å¾…åŠäº‹é¡¹
 */
export class TodoService {
  private readonly todos: Todo[] = [];

  getAllTodos(ownerId?: string): Todo[] {
    if (ownerId) {
      return this.todos.filter((todo) => todo.ownerId === ownerId);
    }
    return this.todos;
  }

  getTodoById(id: string): Todo | undefined {
    return this.todos.find((todo) => todo.id === id);
  }

  createTodo({ content, ownerId }: { content: string; ownerId: string }): Todo {
    const todo: Todo = {
      id: this.genId(),
      content,
      ownerId,
      createdAt: new Date().toISOString(),
    };

    // eslint-disable-next-line @silverhand/fp/no-mutating-methods
    this.todos.push(todo);
    return todo;
  }

  deleteTodo(id: string): Todo | undefined {
    const index = this.todos.findIndex((todo) => todo.id === id);

    if (index === -1) {
      return undefined;
    }

    // eslint-disable-next-line @silverhand/fp/no-mutating-methods
    const [deleted] = this.todos.splice(index, 1);
    return deleted;
  }

  private genId(): string {
    return Math.random().toString(36).slice(2, 10);
  }
}
```

</TabItem>
</Tabs>

ğŸ‰ æ­å–œï¼æˆ‘ä»¬å·²ç»æˆåŠŸå®ç°äº†ä¸€ä¸ªå¸¦æœ‰è®¤è¯ (Authentication) å’Œæˆæƒ (Authorization) çš„å®Œæ•´ MCP æœåŠ¡å™¨ï¼

ä½ ä¹Ÿå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ç¤ºä¾‹ä»£ç ï¼š

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

:::info
å®Œæ•´ MCP æœåŠ¡å™¨ï¼ˆOIDC ç‰ˆæœ¬ï¼‰ä»£ç è¯·å‚è€ƒ [MCP Auth Python SDK ä»“åº“](https://github.com/mcp-auth/python/tree/master/samples/current/todo-manager)ã€‚
:::

</TabItem>
<TabItem value="node" label="Node.js">

:::info
å®Œæ•´ MCP æœåŠ¡å™¨ï¼ˆOIDC ç‰ˆæœ¬ï¼‰ä»£ç è¯·å‚è€ƒ [MCP Auth Node.js SDK ä»“åº“](https://github.com/mcp-auth/js/blob/master/packages/sample-servers/src)ã€‚
:::

</TabItem>
</Tabs>

## æ£€æŸ¥ç‚¹ï¼šè¿è¡Œ `todo-manager` å·¥å…· \{#checkpoint-run-the-todo-manager-tools}

é‡å¯ MCP æœåŠ¡å™¨ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ MCP inspectorã€‚ç‚¹å‡»â€œConnectâ€æŒ‰é’®åï¼Œä½ ä¼šè¢«é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨çš„ç™»å½•é¡µé¢ã€‚

ç™»å½•å¹¶è¿”å› MCP inspector åï¼Œé‡å¤å‰é¢æ£€æŸ¥ç‚¹çš„æ“ä½œè¿è¡Œå¾…åŠäº‹é¡¹å·¥å…·ã€‚æ­¤æ—¶ï¼Œä½ å¯ä»¥ç”¨è®¤è¯ (Authentication) åçš„ç”¨æˆ·èº«ä»½ä½¿ç”¨è¿™äº›å·¥å…·ã€‚å·¥å…·çš„è¡Œä¸ºå°†æ ¹æ®ä½ ç”¨æˆ·çš„è§’è‰² (Role) å’Œæƒé™ (Permission) ä¸åŒè€Œä¸åŒï¼š

- å¦‚æœä½ ä»¥ **User**ï¼ˆä»…æœ‰ `create:todos` æƒé™ (Scope)ï¼‰ç™»å½•ï¼š

  - å¯ä»¥ç”¨ `create-todo` å·¥å…·åˆ›å»ºæ–°å¾…åŠäº‹é¡¹
  - åªèƒ½æŸ¥çœ‹å’Œåˆ é™¤è‡ªå·±çš„å¾…åŠäº‹é¡¹
  - æ— æ³•æŸ¥çœ‹æˆ–åˆ é™¤å…¶ä»–ç”¨æˆ·çš„å¾…åŠäº‹é¡¹

- å¦‚æœä½ ä»¥ **Admin**ï¼ˆæ‹¥æœ‰æ‰€æœ‰æƒé™ï¼š`create:todos`ã€`read:todos`ã€`delete:todos`ï¼‰ç™»å½•ï¼š
  - å¯ä»¥åˆ›å»ºæ–°å¾…åŠäº‹é¡¹
  - å¯ä»¥ç”¨ `get-todos` å·¥å…·æŸ¥çœ‹ç³»ç»Ÿä¸­æ‰€æœ‰å¾…åŠäº‹é¡¹
  - å¯ä»¥ç”¨ `delete-todo` å·¥å…·åˆ é™¤ä»»æ„å¾…åŠäº‹é¡¹ï¼Œæ— è®ºå½’å±è°

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•ä¸åŒæƒé™çº§åˆ«ï¼š

1. é€€å‡ºå½“å‰ä¼šè¯ï¼ˆç‚¹å‡» MCP inspector çš„â€œDisconnectâ€æŒ‰é’®ï¼‰
2. ç”¨æ‹¥æœ‰ä¸åŒè§’è‰² (Role)/æƒé™ (Permission) çš„å…¶ä»–ç”¨æˆ·è´¦å·ç™»å½•
3. å†æ¬¡å°è¯•ç›¸åŒå·¥å…·ï¼Œè§‚å¯Ÿç”¨æˆ·æƒé™å˜åŒ–å¸¦æ¥çš„è¡Œä¸ºå·®å¼‚

è¿™å±•ç¤ºäº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC) åœ¨å®é™…ä¸­çš„å·¥ä½œæ–¹å¼ï¼Œä¸åŒç”¨æˆ·å¯¹ç³»ç»ŸåŠŸèƒ½æœ‰ä¸åŒè®¿é—®çº§åˆ«ã€‚

![MCP inspector å¾…åŠäº‹é¡¹å·¥å…·ç»“æœ](/docs-assets/images/tutorials/todo-manager/result.png)

<Tabs groupId="sdk">
<TabItem value="python" label="Python">

:::info
å®Œæ•´ MCP æœåŠ¡å™¨ï¼ˆOIDC ç‰ˆæœ¬ï¼‰ä»£ç è¯·å‚è€ƒ [MCP Auth Python SDK ä»“åº“](https://github.com/mcp-auth/python)ã€‚
:::

</TabItem>
<TabItem value="node" label="Node.js">

:::info
å®Œæ•´ MCP æœåŠ¡å™¨ï¼ˆOIDC ç‰ˆæœ¬ï¼‰ä»£ç è¯·å‚è€ƒ [MCP Auth Node.js SDK ä»“åº“](https://github.com/mcp-auth/js/blob/master/packages/sample-servers/src)ã€‚
:::

</TabItem>
</Tabs>

## ç»“è¯­ \{#closing-notes}

ğŸŠ æ­å–œï¼ä½ å·²æˆåŠŸå®Œæˆæœ¬æ•™ç¨‹ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ‰€åšçš„å†…å®¹ï¼š

- æ­å»ºäº†ä¸€ä¸ªåŸºç¡€ MCP æœåŠ¡å™¨ï¼ŒåŒ…å«å¾…åŠäº‹é¡¹ç®¡ç†å·¥å…·ï¼ˆ`create-todo`ã€`get-todos`ã€`delete-todo`ï¼‰
- å®ç°äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)ï¼Œä¸ºç”¨æˆ·å’Œç®¡ç†å‘˜è®¾ç½®ä¸åŒæƒé™çº§åˆ«
- ä½¿ç”¨ MCP Auth å°† MCP æœåŠ¡å™¨ä¸æˆæƒæœåŠ¡å™¨é›†æˆ
- é…ç½® MCP Inspector è®¤è¯ (Authentication) ç”¨æˆ·ï¼Œå¹¶ç”¨å¸¦æƒé™ (Scope) çš„è®¿é—®ä»¤ç‰Œ (Access token) è°ƒç”¨å·¥å…·

æ¬¢è¿æŸ¥é˜…å…¶ä»–æ•™ç¨‹å’Œæ–‡æ¡£ï¼Œå……åˆ†å‘æŒ¥ MCP Auth çš„å¼ºå¤§åŠŸèƒ½ã€‚
